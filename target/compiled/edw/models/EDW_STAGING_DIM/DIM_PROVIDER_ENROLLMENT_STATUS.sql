 

 WITH  SCD AS (  
	SELECT  UNIQUE_ID_KEY,
     last_value(ENROLLMENT_STATUS_TYPE_CODE) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as ENROLLMENT_STATUS_TYPE_CODE, 
     last_value(ENROLLMENT_STATUS_REASON_CODE) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as ENROLLMENT_STATUS_REASON_CODE, 
     last_value(ENROLLMENT_STATUS_TYPE_DESC) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as ENROLLMENT_STATUS_TYPE_DESC, 
     last_value(ENROLLMENT_STATUS_REASON_DESC) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as ENROLLMENT_STATUS_REASON_DESC
         
	FROM EDW_STAGING.DIM_PROVIDER_ENROLLMENT_STATUS_SCDALL_STEP2),

ETL AS (
select UNIQUE_ID_KEY AS ENROLLMENT_STATUS_HKEY
    , * 
    , CURRENT_TIMESTAMP AS  LOAD_DATETIME
    , TRY_TO_TIMESTAMP('Invalid') AS UPDATE_DATETIME
    , 'PEACH' AS PRIMARY_SOURCE_SYSTEM 
    from SCD
)

SELECT * FROM ETL