 

WITH  SCD AS ( 
	SELECT  UNIQUE_ID_KEY,
          last_value(HOSPITAL_REVENUE_CENTER_CODE) over 
        (partition by UNIQUE_ID_KEY 
        order by dbt_updated_at 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as HOSPITAL_REVENUE_CENTER_CODE,
     last_value(REVENUE_CENTER_PAYMENT_CATEGORY) over 
        (partition by UNIQUE_ID_KEY 
        order by dbt_updated_at 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as REVENUE_CENTER_PAYMENT_CATEGORY,
    
 HOSPITAL_REVENUE_CENTER_DESC,
 REVENUE_CENTER_EFFECTIVE_DATE,
 REVENUE_CENTER_EXPIRATION_DATE
,DBT_VALID_FROM AS EFFECTIVE_TIMESTAMP 
,DBT_VALID_TO   AS END_TIMESTAMP 
,
    CASE WHEN (ROW_NUMBER() OVER (PARTITION BY UNIQUE_ID_KEY ORDER BY DBT_VALID_FROM )) = 1 THEN REVENUE_CENTER_EFFECTIVE_DATE
    WHEN CAST(DBT_VALID_FROM AS DATE) = '1901-01-01' then CAST(DBT_VALID_FROM AS DATE)
      WHEN CAST(DBT_VALID_FROM AS DATE) <> '1901-01-01' THEN dateadd(day,1,CAST(DBT_VALID_FROM AS DATE))
    else CAST(DBT_VALID_FROM AS DATE) end as EFFECTIVE_DATE
,
    CAST(DBT_VALID_TO AS DATE) as END_DATE 
,CASE WHEN DBT_VALID_TO IS NULL THEN 'Y' ELSE 'N' END AS CURRENT_INDICATOR
     FROM EDW_STAGING.DIM_REVENUE_CENTER_SCDALL_STEP2),

ETL AS (select md5(cast(
    
    coalesce(cast(HOSPITAL_REVENUE_CENTER_CODE as 
    varchar
), '') || '-' || coalesce(cast(EFFECTIVE_DATE as 
    varchar
), '')

 as 
    varchar
)) as REVENUE_CENTER_HKEY
,UNIQUE_ID_KEY
,HOSPITAL_REVENUE_CENTER_CODE
,HOSPITAL_REVENUE_CENTER_DESC
,REVENUE_CENTER_PAYMENT_CATEGORY
,REVENUE_CENTER_EFFECTIVE_DATE::DATE AS REVENUE_CENTER_EFFECTIVE_DATE
,REVENUE_CENTER_EXPIRATION_DATE::DATE AS REVENUE_CENTER_EXPIRATION_DATE
,CURRENT_INDICATOR AS CURRENT_RECORD_IND
,EFFECTIVE_DATE AS RECORD_EFFECTIVE_DATE
,END_DATE AS RECORD_END_DATE
,EFFECTIVE_TIMESTAMP AS LOAD_DATETIME
,END_TIMESTAMP AS UPDATE_DATETIME
,'CAM' AS PRIMARY_SOURCE_SYSTEM

 from SCD)
 SELECT * FROM ETL