

 WITH  SCD AS ( 
	SELECT  UNIQUE_ID_KEY,
     last_value(POLICY_TYPE_CODE) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as POLICY_TYPE_CODE, 
     last_value(POLICY_STATUS_CODE) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as POLICY_STATUS_CODE, 
     last_value(STATUS_REASON_CODE) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as STATUS_REASON_CODE, 
     last_value(POLICY_ACTIVE_IND) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as POLICY_ACTIVE_IND, 
     last_value(POLICY_TYPE_DESC) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as POLICY_TYPE_DESC, 
     last_value(POLICY_STATUS_DESC) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as POLICY_STATUS_DESC, 
     last_value(STATUS_REASON_DESC) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as STATUS_REASON_DESC
	FROM EDW_STAGING.DIM_POLICY_STANDING_SCDALL_STEP2)

select UNIQUE_ID_KEY AS POLICY_STANDING_HKEY
, UNIQUE_ID_KEY
, POLICY_TYPE_CODE
, POLICY_STATUS_CODE
, STATUS_REASON_CODE
, POLICY_ACTIVE_IND
, POLICY_TYPE_DESC
, POLICY_STATUS_DESC
, STATUS_REASON_DESC
, CURRENT_TIMESTAMP AS LOAD_DATETIME
, try_to_TIMESTAMP('Invalid')  AS UPDATE_DATETIME
, 'CORESUITE' AS PRIMARY_SOURCE_SYSTEM
from SCD