

 WITH  SCD AS ( 
	SELECT  UNIQUE_ID_KEY,
     last_value(CUSTOMER_NUMBER) over 
        (partition by UNIQUE_ID_KEY 
        order by dbt_updated_at 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as CUSTOMER_NUMBER, 
     last_value(REPRESENTATIVE_ID_NUMBER) over 
        (partition by UNIQUE_ID_KEY 
        order by dbt_updated_at 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as REPRESENTATIVE_ID_NUMBER, 
     last_value(REPRESENTATIVE_ID_EFFECTIVE_DATE) over 
        (partition by UNIQUE_ID_KEY 
        order by dbt_updated_at 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as REPRESENTATIVE_ID_EFFECTIVE_DATE, 
     last_value(REPRESENTATIVE_ID_END_DATE) over 
        (partition by UNIQUE_ID_KEY 
        order by dbt_updated_at 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as REPRESENTATIVE_ID_END_DATE, 
     last_value(CUSTOMER_TYPE_CODE) over 
        (partition by UNIQUE_ID_KEY 
        order by dbt_updated_at 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as CUSTOMER_TYPE_CODE, 
     last_value(CUSTOMER_TYPE_DESC) over 
        (partition by UNIQUE_ID_KEY 
        order by dbt_updated_at 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as CUSTOMER_TYPE_DESC, 
     last_value("1099_RECEIVER_IND") over 
        (partition by UNIQUE_ID_KEY 
        order by dbt_updated_at 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as "1099_RECEIVER_IND", 
     last_value(W9_RECVEIVER_IND) over 
        (partition by UNIQUE_ID_KEY 
        order by dbt_updated_at 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as W9_RECVEIVER_IND, 
     last_value(TAX_EXEMPT_IND) over 
        (partition by UNIQUE_ID_KEY 
        order by dbt_updated_at 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as TAX_EXEMPT_IND, 
     last_value(FOREIGN_CITIZEN_IND) over 
        (partition by UNIQUE_ID_KEY 
        order by dbt_updated_at 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as FOREIGN_CITIZEN_IND, 
     last_value(TAX_ID_UNAVAILABLE_IND) over 
        (partition by UNIQUE_ID_KEY 
        order by dbt_updated_at 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as TAX_ID_UNAVAILABLE_IND, 
     last_value(TAX_ID_OVERRIDE_IND) over 
        (partition by UNIQUE_ID_KEY 
        order by dbt_updated_at 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as TAX_ID_OVERRIDE_IND, 
     last_value(PRIMARY_BUSINESS_PHONE_NUMBER) over 
        (partition by UNIQUE_ID_KEY 
        order by dbt_updated_at 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as PRIMARY_BUSINESS_PHONE_NUMBER, 
 CUSTOMER_NAME, 
 DOCUMENT_BLOCK_IND, 
 THREAT_BEHAVIOR_BLOCK_IND, 
 MAILING_STREET_ADDRESS_1, 
 MAILING_STREET_ADDRESS_2, 
 MAILING_ADDRESS_CITY_NAME, 
 MAILING_ADDRESS_STATE_CODE, 
 MAILING_ADDRESS_STATE_NAME, 
 MAILING_ADDRESS_POSTAL_CODE, 
 MAILING_FORMATTED_ADDRESS_POSTAL_CODE, 
 MAILING_FORMATTED_ADDRESS_ZIP_CODE, 
 MAILING_FORMATTED_ADDRESS_ZIP4_CODE, 
 MAILING_ADDRESS_COUNTY_NAME, 
 MAILING_ADDRESS_COUNTRY_NAME, 
 MAILING_ADDRESS_VALIDATED_IND, 
 MAILING_ADDRESS_COMMENT_TEXT, 
 PHYSICAL_STREET_ADDRESS_1, 
 PHYSICAL_STREET_ADDRESS_2, 
 PHYSICAL_ADDRESS_CITY_NAME, 
 PHYSICAL_ADDRESS_STATE_CODE, 
 PHYSICAL_ADDRESS_STATE_NAME, 
 PHYSICAL_ADDRESS_POSTAL_CODE, 
 PHYSICAL_FORMATTED_ADDRESS_POSTAL_CODE, 
 PHYSICAL_FORMATTED_ADDRESS_ZIP_CODE, 
 PHYSICAL_FORMATTED_ADDRESS_ZIP4_CODE, 
 PHYSICAL_ADDRESS_COUNTY_NAME, 
 PHYSICAL_ADDRESS_COUNTRY_NAME, 
 PHYSICAL_ADDRESS_VALIDATED_IND, 
 PHYSICAL_ADDRESS_COMMENT_TEXT, 
CASE WHEN DBT_VALID_TO IS NULL THEN 'Y' ELSE 'N' END AS CURRENT_RECORD_IND,
 COALESCE(CASE WHEN (ROW_NUMBER() OVER (PARTITION BY UNIQUE_ID_KEY ORDER BY DBT_VALID_FROM )) = 1 
      AND  CAST(DBT_VALID_FROM AS DATE) <> '1901-01-01' THEN CAST(DBT_VALID_FROM AS DATE)
               WHEN CAST(DBT_VALID_FROM AS DATE) = '1901-01-01' then CAST(DBT_VALID_FROM AS DATE)
               WHEN CAST(DBT_VALID_FROM AS DATE) <> '1901-01-01' THEN dateadd(day,1,CAST(DBT_VALID_FROM AS DATE))
               ELSE CAST(DBT_VALID_FROM AS DATE) END,'1901-01-01'::DATE) as RECORD_EFFECTIVE_DATE,
CAST(DBT_VALID_TO AS DATE) as RECORD_END_DATE,
DBT_VALID_FROM as LOAD_DATETIME,
DBT_VALID_TO   AS UPDATE_DATETIME,
'CORESUITE' as PRIMARY_SOURCE_SYSTEM

FROM EDW_STAGING.DIM_REPRESENTATIVE_SCDALL_STEP2),
ETL AS (select md5(cast(
    
    coalesce(cast(CUSTOMER_NUMBER as 
    varchar
), '') || '-' || coalesce(cast(RECORD_EFFECTIVE_DATE as 
    varchar
), '')

 as 
    varchar
)) as REPRESENTATIVE_HKEY, * FROM SCD )

select 
 REPRESENTATIVE_HKEY
,UNIQUE_ID_KEY
,CUSTOMER_NUMBER
,CUSTOMER_NAME
,REPRESENTATIVE_ID_NUMBER
,REPRESENTATIVE_ID_EFFECTIVE_DATE
,REPRESENTATIVE_ID_END_DATE
,CUSTOMER_TYPE_CODE
,CUSTOMER_TYPE_DESC
,"1099_RECEIVER_IND"
,W9_RECVEIVER_IND
,TAX_EXEMPT_IND
,FOREIGN_CITIZEN_IND
,TAX_ID_UNAVAILABLE_IND
,TAX_ID_OVERRIDE_IND
,PRIMARY_BUSINESS_PHONE_NUMBER
,DOCUMENT_BLOCK_IND
,THREAT_BEHAVIOR_BLOCK_IND
,MAILING_STREET_ADDRESS_1
,MAILING_STREET_ADDRESS_2
,MAILING_ADDRESS_CITY_NAME
,MAILING_ADDRESS_STATE_CODE
,MAILING_ADDRESS_STATE_NAME
,MAILING_ADDRESS_POSTAL_CODE
,MAILING_FORMATTED_ADDRESS_POSTAL_CODE
,MAILING_FORMATTED_ADDRESS_ZIP_CODE
,MAILING_FORMATTED_ADDRESS_ZIP4_CODE
,MAILING_ADDRESS_COUNTY_NAME
,MAILING_ADDRESS_COUNTRY_NAME
,MAILING_ADDRESS_VALIDATED_IND
,MAILING_ADDRESS_COMMENT_TEXT
--,MAILING_ADDRESS_EFFECTIVE_DATE
--,MAILING_ADDRESS_END_DATE
,PHYSICAL_STREET_ADDRESS_1
,PHYSICAL_STREET_ADDRESS_2
,PHYSICAL_ADDRESS_CITY_NAME
,PHYSICAL_ADDRESS_STATE_CODE
,PHYSICAL_ADDRESS_STATE_NAME
,PHYSICAL_ADDRESS_POSTAL_CODE
,PHYSICAL_FORMATTED_ADDRESS_POSTAL_CODE
,PHYSICAL_FORMATTED_ADDRESS_ZIP_CODE
,PHYSICAL_FORMATTED_ADDRESS_ZIP4_CODE
,PHYSICAL_ADDRESS_COUNTY_NAME
,PHYSICAL_ADDRESS_COUNTRY_NAME
,PHYSICAL_ADDRESS_VALIDATED_IND
,PHYSICAL_ADDRESS_COMMENT_TEXT
--,PHYSICAL_ADDRESS_EFFECTIVE_DATE
--,PHYSICAL_ADDRESS_END_DATE
,CURRENT_RECORD_IND
,RECORD_EFFECTIVE_DATE
,RECORD_END_DATE
,LOAD_DATETIME
,UPDATE_DATETIME
,PRIMARY_SOURCE_SYSTEM
 from ETL