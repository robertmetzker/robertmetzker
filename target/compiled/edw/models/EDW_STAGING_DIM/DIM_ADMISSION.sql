 

 WITH  SCD AS ( 
	SELECT  UNIQUE_ID_KEY,
     last_value(HOSPITAL_ADMISSION_TYPE_DESC) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as HOSPITAL_ADMISSION_TYPE_DESC,
     last_value(MEDICAL_INVOICE_SOURCE_OF_ADMISSION_DESC) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as MEDICAL_INVOICE_SOURCE_OF_ADMISSION_DESC,
     last_value(MEDICAL_INVOICE_HOSPITAL_DISCHARGE_STATUS_DESC) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as MEDICAL_INVOICE_HOSPITAL_DISCHARGE_STATUS_DESC,
     first_value(HOSPITAL_ADMISSION_TYPE_CODE) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as HOSPITAL_ADMISSION_TYPE_CODE,
     first_value(MEDICAL_INVOICE_SOURCE_OF_ADMISSION_CODE) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as MEDICAL_INVOICE_SOURCE_OF_ADMISSION_CODE,
     first_value(MEDICAL_INVOICE_HOSPITAL_BILL_TYPE_CODE) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as MEDICAL_INVOICE_HOSPITAL_BILL_TYPE_CODE,
     first_value(MEDICAL_INVOICE_HOSPITAL_BILL_TYPE_DESC) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as MEDICAL_INVOICE_HOSPITAL_BILL_TYPE_DESC,
     first_value(MEDICAL_INVOICE_HOSPITAL_DISCHARGE_STATUS_CODE) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as MEDICAL_INVOICE_HOSPITAL_DISCHARGE_STATUS_CODE

    
     FROM EDW_STAGING.DIM_ADMISSION_SCDALL_STEP2),
ETL AS (select md5(cast(
    
    coalesce(cast(HOSPITAL_ADMISSION_TYPE_CODE as 
    varchar
), '') || '-' || coalesce(cast(MEDICAL_INVOICE_SOURCE_OF_ADMISSION_CODE as 
    varchar
), '') || '-' || coalesce(cast(MEDICAL_INVOICE_HOSPITAL_DISCHARGE_STATUS_CODE as 
    varchar
), '') || '-' || coalesce(cast(MEDICAL_INVOICE_HOSPITAL_BILL_TYPE_CODE as 
    varchar
), '')

 as 
    varchar
)) AS ADMISSION_HKEY
, UNIQUE_ID_KEY
, HOSPITAL_ADMISSION_TYPE_CODE
, MEDICAL_INVOICE_SOURCE_OF_ADMISSION_CODE
, MEDICAL_INVOICE_HOSPITAL_DISCHARGE_STATUS_CODE
, MEDICAL_INVOICE_HOSPITAL_BILL_TYPE_CODE
, CASE WHEN HOSPITAL_ADMISSION_TYPE_CODE IS NOT NULL
      AND HOSPITAL_ADMISSION_TYPE_DESC IS NULL THEN 'INVALID' 
      ELSE HOSPITAL_ADMISSION_TYPE_DESC 
      END AS HOSPITAL_ADMISSION_TYPE_DESC
, CASE WHEN MEDICAL_INVOICE_SOURCE_OF_ADMISSION_CODE IS NOT NULL
        AND MEDICAL_INVOICE_SOURCE_OF_ADMISSION_DESC IS NULL THEN 'INVALID' 
        ELSE MEDICAL_INVOICE_SOURCE_OF_ADMISSION_DESC 
        END AS MEDICAL_INVOICE_SOURCE_OF_ADMISSION_DESC
, CASE WHEN MEDICAL_INVOICE_HOSPITAL_DISCHARGE_STATUS_CODE IS NOT NULL
      AND MEDICAL_INVOICE_HOSPITAL_DISCHARGE_STATUS_DESC IS NULL THEN 'INVALID' 
      ELSE MEDICAL_INVOICE_HOSPITAL_DISCHARGE_STATUS_DESC 
      END AS MEDICAL_INVOICE_HOSPITAL_DISCHARGE_STATUS_DESC
, CASE WHEN MEDICAL_INVOICE_HOSPITAL_BILL_TYPE_CODE IS NOT NULL
      AND MEDICAL_INVOICE_HOSPITAL_BILL_TYPE_DESC IS NULL THEN 'INVALID'
       ELSE MEDICAL_INVOICE_HOSPITAL_BILL_TYPE_DESC 
      END AS MEDICAL_INVOICE_HOSPITAL_BILL_TYPE_DESC
, CURRENT_TIMESTAMP AS LOAD_DATETIME
, try_to_TIMESTAMP('Invalid')  AS UPDATE_DATETIME
, 'CAM' AS PRIMARY_SOURCE_SYSTEM
 from SCD)

SELECT * FROM ETL