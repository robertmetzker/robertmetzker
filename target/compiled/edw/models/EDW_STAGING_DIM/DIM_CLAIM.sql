 

 WITH  SCD AS ( 
	SELECT  UNIQUE_ID_KEY,
     last_value(CLAIM_NUMBER) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as CLAIM_NUMBER,
     last_value(CURRENT_CORESUITE_CLAIM_TYPE_CODE) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as CURRENT_CORESUITE_CLAIM_TYPE_CODE,
     last_value(CURRENT_CORESUITE_CLAIM_TYPE_DESC) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as CURRENT_CORESUITE_CLAIM_TYPE_DESC,
     last_value(CLAIM_STATE_DESC) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as CLAIM_STATE_DESC,
     last_value(CLAIM_STATUS_DESC) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as CLAIM_STATUS_DESC,
     last_value(CLAIM_STATUS_REASON_DESC) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as CLAIM_STATUS_REASON_DESC,
     last_value(ACCIDENT_DESCRIPTION_TEXT) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as ACCIDENT_DESCRIPTION_TEXT,
     last_value(NATURE_OF_INJURY_CATEGORY) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as NATURE_OF_INJURY_CATEGORY, 
     last_value(NATURE_OF_INJURY_TYPE) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as NATURE_OF_INJURY_TYPE, 
     last_value(FILING_SOURCE_DESC) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as FILING_SOURCE_DESC,
     last_value(FILING_MEDIA_DESC) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as FILING_MEDIA_DESC,
     last_value(FIREFIGHTER_CANCER_IND) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as FIREFIGHTER_CANCER_IND,
     last_value(COVID_EXPOSURE_IND) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as COVID_EXPOSURE_IND,
     last_value(COVID_EMERGENCY_WORKER_IND) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as COVID_EMERGENCY_WORKER_IND,
     last_value(COVID_HEALTH_CARE_WORKER_IND) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as COVID_HEALTH_CARE_WORKER_IND,
     last_value(COMBINED_IND) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as COMBINED_IND,
     last_value(SB223_IND) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as SB223_IND,
     last_value(EMPLOYER_PREMISES_IND) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as EMPLOYER_PREMISES_IND,
     last_value(ACCIDENT_PREMISES_TEXT) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as ACCIDENT_PREMISES_TEXT,
     last_value(K_PROGRAM_ENROLLMENT_DESC) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as K_PROGRAM_ENROLLMENT_DESC,
     last_value(K_PROGRAM_TYPE_DESC) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as K_PROGRAM_TYPE_DESC,
     /* last_value(K_PROGRAM_START_DATE) over  */
     last_value( EMPLOYER_PAID_PROGRAM_EFFECTIVE_DATE ) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            /* ) as K_PROGRAM_START_DATE, */
            ) as EMPLOYER_PAID_PROGRAM_EFFECTIVE_DATE,
     /* last_value(K_PROGRAM_END_DATE) over  */
     last_value( EMPLOYER_PAID_PROGRAM_EXPIRATION_DATE ) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            /* ) as K_PROGRAM_END_DATE, */
            ) as EMPLOYER_PAID_PROGRAM_EXPIRATION_DATE,
     last_value(K_PROGRAM_REASON_DESC) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as K_PROGRAM_REASON_DESC,
     last_value(CATASTROPHIC_IND) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as CATASTROPHIC_IND,
     last_value(ACCIDENT_LOCATION_NAME) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as ACCIDENT_LOCATION_NAME,
     last_value(ACCIDENT_LOCATION_CITY) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as ACCIDENT_LOCATION_CITY,
     last_value(ACCIDENT_LOCATION_POSTAL_CODE) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as ACCIDENT_LOCATION_POSTAL_CODE,
     last_value(ACCIDENT_LOCATION_COUNTY) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as ACCIDENT_LOCATION_COUNTY,
     last_value(ACCIDENT_LOCATION_STATE_CODE) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as ACCIDENT_LOCATION_STATE_CODE,
     last_value(ACCIDENT_LOCATION_STATE) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as ACCIDENT_LOCATION_STATE,
     last_value(ACCIDENT_LOCATION_COUNTRY) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as ACCIDENT_LOCATION_COUNTRY,
     last_value(ACCIDENT_LOCATION_TEXT) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as ACCIDENT_LOCATION_TEXT

     FROM EDW_STAGING.DIM_CLAIM_SCDALL_STEP2),
------ ETL LAYER --------------
ETL AS (select md5(cast(
    
    coalesce(cast(CLAIM_NUMBER as 
    varchar
), '')

 as 
    varchar
)) as CLAIM_HKEY
,UNIQUE_ID_KEY
,CLAIM_NUMBER
,CURRENT_CORESUITE_CLAIM_TYPE_CODE
,CURRENT_CORESUITE_CLAIM_TYPE_DESC
,CLAIM_STATE_DESC
,CLAIM_STATUS_DESC
,CLAIM_STATUS_REASON_DESC
,ACCIDENT_DESCRIPTION_TEXT
,NATURE_OF_INJURY_CATEGORY
,NATURE_OF_INJURY_TYPE
,FILING_SOURCE_DESC
,FILING_MEDIA_DESC
,FIREFIGHTER_CANCER_IND
,COVID_EXPOSURE_IND
,COVID_EMERGENCY_WORKER_IND
,COVID_HEALTH_CARE_WORKER_IND
,COMBINED_IND
,SB223_IND
,EMPLOYER_PREMISES_IND
,ACCIDENT_PREMISES_TEXT
,K_PROGRAM_ENROLLMENT_DESC
,K_PROGRAM_TYPE_DESC
/* ,K_PROGRAM_START_DATE
,K_PROGRAM_END_DATE */
,EMPLOYER_PAID_PROGRAM_EFFECTIVE_DATE
,EMPLOYER_PAID_PROGRAM_EXPIRATION_DATE
,K_PROGRAM_REASON_DESC
,CATASTROPHIC_IND
,ACCIDENT_LOCATION_NAME
,ACCIDENT_LOCATION_CITY
,ACCIDENT_LOCATION_POSTAL_CODE
,ACCIDENT_LOCATION_COUNTY
,ACCIDENT_LOCATION_STATE_CODE
,ACCIDENT_LOCATION_STATE
,ACCIDENT_LOCATION_COUNTRY
,ACCIDENT_LOCATION_TEXT
, CURRENT_TIMESTAMP AS LOAD_DATETIME
,try_to_TIMESTAMP('Invalid')  AS UPDATE_DATETIME
,'CORESUITE' AS PRIMARY_SOURCE_SYSTEM
 from SCD)

SELECT * FROM ETL