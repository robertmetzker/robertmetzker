 

 WITH  SCD AS ( 
	SELECT  UNIQUE_ID_KEY,
     last_value(ICD_CODE) over 
        (partition by UNIQUE_ID_KEY 
        order by dbt_updated_at 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as ICD_CODE,
     last_value(ICD_CODE_VERSION_NUMBER) over 
        (partition by UNIQUE_ID_KEY 
        order by dbt_updated_at 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as ICD_CODE_VERSION_NUMBER,
     last_value(GENDER_SPECIFIC_CODE) over 
        (partition by UNIQUE_ID_KEY 
        order by dbt_updated_at 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as GENDER_SPECIFIC_CODE,
     last_value(GENDER_SPECIFIC_DESC) over 
        (partition by UNIQUE_ID_KEY 
        order by dbt_updated_at 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as GENDER_SPECIFIC_DESC,
     last_value(AUTHORIZED_BILL_USE_IND) over 
        (partition by UNIQUE_ID_KEY 
        order by dbt_updated_at 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as AUTHORIZED_BILL_USE_IND,
     last_value(AUTHORIZED_CLAIM_USE_IND) over 
        (partition by UNIQUE_ID_KEY 
        order by dbt_updated_at 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as AUTHORIZED_CLAIM_USE_IND,
     last_value(CATASTROPHIC_ICD_IND) over 
        (partition by UNIQUE_ID_KEY 
        order by dbt_updated_at 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as CATASTROPHIC_ICD_IND,
     last_value(CMS_PROHIBITED_IND) over 
        (partition by UNIQUE_ID_KEY 
        order by dbt_updated_at 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as CMS_PROHIBITED_IND,
     last_value(ASSIGN_ICD_TO_FIELD_IND) over 
        (partition by UNIQUE_ID_KEY 
        order by dbt_updated_at 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as ASSIGN_ICD_TO_FIELD_IND,
     last_value(ICD_ACP_ELIGIBILE_IND) over 
        (partition by UNIQUE_ID_KEY 
        order by dbt_updated_at 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as ICD_ACP_ELIGIBILE_IND,
     last_value(ENCODER_VALIDATION_REQUIRED_IND) over 
        (partition by UNIQUE_ID_KEY 
        order by dbt_updated_at 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as ENCODER_VALIDATION_REQUIRED_IND,
     last_value(ICD_PRIVACY_IND) over 
        (partition by UNIQUE_ID_KEY 
        order by dbt_updated_at 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as ICD_PRIVACY_IND,
     last_value(ICD_STATUTORY_OCCUPATIONAL_DISEASE_IND) over 
        (partition by UNIQUE_ID_KEY 
        order by dbt_updated_at 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as ICD_STATUTORY_OCCUPATIONAL_DISEASE_IND,
     last_value(ICD_LOCATION_REQUIRED_IND) over 
        (partition by UNIQUE_ID_KEY 
        order by dbt_updated_at 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as ICD_LOCATION_REQUIRED_IND,
     last_value(ICD_PRIOR_AUTHORIZATION_REQUIRED_IND) over 
        (partition by UNIQUE_ID_KEY 
        order by dbt_updated_at 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as ICD_PRIOR_AUTHORIZATION_REQUIRED_IND,
     last_value(ICD_POTENTIAL_SEVERE_COMPLICATIONS_IND) over 
        (partition by UNIQUE_ID_KEY 
        order by dbt_updated_at 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as ICD_POTENTIAL_SEVERE_COMPLICATIONS_IND,
     last_value(ICD_PSYCHOLOGICAL_IND) over 
        (partition by UNIQUE_ID_KEY 
        order by dbt_updated_at 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as ICD_PSYCHOLOGICAL_IND,
     last_value(ICD_SECURITY_AUTHORIZATION_IND) over 
        (partition by UNIQUE_ID_KEY 
        order by dbt_updated_at 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as ICD_SECURITY_AUTHORIZATION_IND,
     last_value(ICD_SITE_REQUIRED_IND) over 
        (partition by UNIQUE_ID_KEY 
        order by dbt_updated_at 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as ICD_SITE_REQUIRED_IND,
     last_value(ICD_SUBROGATION_REVIEW_IND) over 
        (partition by UNIQUE_ID_KEY 
        order by dbt_updated_at 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as ICD_SUBROGATION_REVIEW_IND,
     last_value(EM_REFERRAL_CODE) over 
        (partition by UNIQUE_ID_KEY 
        order by dbt_updated_at 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as EM_REFERRAL_CODE,
     last_value(EM_REFERRAL_DESC) over 
        (partition by UNIQUE_ID_KEY 
        order by dbt_updated_at 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as EM_REFERRAL_DESC,
     last_value(ICD_CODE_CHAPTER_NUMBER) over 
        (partition by UNIQUE_ID_KEY 
        order by dbt_updated_at 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as ICD_CODE_CHAPTER_NUMBER,
     last_value(ICD_CODE_CHAPTER_NUMBER_SHORT_DESC) over 
        (partition by UNIQUE_ID_KEY 
        order by dbt_updated_at 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as ICD_CODE_CHAPTER_NUMBER_SHORT_DESC,
     last_value(ICD_CODE_CHAPTER_NUMBER_LONG_DESC) over 
        (partition by UNIQUE_ID_KEY 
        order by dbt_updated_at 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as ICD_CODE_CHAPTER_NUMBER_LONG_DESC,
     last_value(BWC_INJURY_CLASS_DESC) over 
        (partition by UNIQUE_ID_KEY 
        order by dbt_updated_at 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as BWC_INJURY_CLASS_DESC,
     last_value(BWC_SPECIFIC_BODY_PART_DESC) over 
        (partition by UNIQUE_ID_KEY 
        order by dbt_updated_at 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as BWC_SPECIFIC_BODY_PART_DESC,
     last_value(BWC_GENERIC_BODY_PART_DESC) over 
        (partition by UNIQUE_ID_KEY 
        order by dbt_updated_at 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as BWC_GENERIC_BODY_PART_DESC,
 ICD_CODE_SHORT_DESC,
 ICD_CODE_LONG_DESC,
 ICD_CODE_STATUS_CODE,
 ICD_CODE_STATUS_DESC
, ICD_CODE_STATUS_EFFECTIVE_DATE
, ICD_CODE_STATUS_END_DATE
,DBT_VALID_FROM AS EFFECTIVE_TIMESTAMP 
,DBT_VALID_TO   AS END_TIMESTAMP 
-- ,
--     CASE WHEN CAST(DBT_VALID_FROM AS DATE) = '1901-01-01' THEN CAST(DBT_VALID_FROM AS DATE)
--       WHEN CAST(DBT_VALID_FROM AS DATE) <> '1901-01-01' THEN dateadd(day,1,CAST(DBT_VALID_FROM AS DATE))
--     else CAST(DBT_VALID_FROM AS DATE) end as EFFECTIVE_DATE
,
    CAST(DBT_VALID_TO AS DATE) as END_DATE 
, CASE WHEN (ROW_NUMBER() OVER (PARTITION BY UNIQUE_ID_KEY ORDER BY DBT_VALID_FROM )) = 1 THEN ICD_CODE_STATUS_EFFECTIVE_DATE 
        WHEN CAST(DBT_VALID_FROM AS DATE) = '1901-01-01' THEN CAST(DBT_VALID_FROM AS DATE)
      WHEN CAST(DBT_VALID_FROM AS DATE) <> '1901-01-01' THEN dateadd(day,1,CAST(DBT_VALID_FROM AS DATE))
    else CAST(DBT_VALID_FROM AS DATE) end as EFFECTIVE_DATE
     FROM EDW_STAGING.DIM_ICD_SCDALL_STEP2)

--- ETL LAYER ----
, 
ETL AS ( Select 
md5(cast(
    
    coalesce(cast(ICD_CODE as 
    varchar
), '') || '-' || coalesce(cast(EFFECTIVE_DATE as 
    varchar
), '')

 as 
    varchar
)) as ICD_HKEY
,UNIQUE_ID_KEY
,ICD_CODE
,ICD_CODE_SHORT_DESC
,ICD_CODE_LONG_DESC
,ICD_CODE_STATUS_CODE
,ICD_CODE_STATUS_DESC
,ICD_CODE_STATUS_EFFECTIVE_DATE::DATE AS ICD_CODE_STATUS_EFFECTIVE_DATE
,ICD_CODE_STATUS_END_DATE::DATE AS ICD_CODE_STATUS_END_DATE
,ICD_CODE_VERSION_NUMBER
,GENDER_SPECIFIC_CODE
,GENDER_SPECIFIC_DESC
,CASE WHEN AUTHORIZED_BILL_USE_IND IS NULL THEN 'N' ELSE AUTHORIZED_BILL_USE_IND END AS AUTHORIZED_BILL_USE_IND
,CASE WHEN AUTHORIZED_CLAIM_USE_IND IS NULL THEN 'N' ELSE AUTHORIZED_CLAIM_USE_IND END AS AUTHORIZED_CLAIM_USE_IND
,CASE WHEN CATASTROPHIC_ICD_IND IS NULL THEN 'N' ELSE CATASTROPHIC_ICD_IND END AS CATASTROPHIC_ICD_IND
,CASE WHEN CMS_PROHIBITED_IND IS NULL THEN 'N' ELSE CMS_PROHIBITED_IND END AS CMS_PROHIBITED_IND
,CASE WHEN ASSIGN_ICD_TO_FIELD_IND IS NULL THEN 'N' ELSE ASSIGN_ICD_TO_FIELD_IND END AS ASSIGN_ICD_TO_FIELD_IND 
,CASE WHEN ICD_ACP_ELIGIBILE_IND IS NULL THEN 'N' ELSE ICD_ACP_ELIGIBILE_IND END AS ICD_ACP_ELIGIBILE_IND
,CASE WHEN ENCODER_VALIDATION_REQUIRED_IND IS NULL THEN 'N' ELSE ENCODER_VALIDATION_REQUIRED_IND END AS ENCODER_VALIDATION_REQUIRED_IND
,CASE WHEN ICD_PRIVACY_IND IS NULL THEN 'N' ELSE ICD_PRIVACY_IND END AS ICD_PRIVACY_IND
,CASE WHEN ICD_STATUTORY_OCCUPATIONAL_DISEASE_IND IS NULL THEN 'N' ELSE ICD_STATUTORY_OCCUPATIONAL_DISEASE_IND END AS  ICD_STATUTORY_OCCUPATIONAL_DISEASE_IND
,CASE WHEN ICD_LOCATION_REQUIRED_IND IS NULL THEN 'N' ELSE ICD_LOCATION_REQUIRED_IND END AS ICD_LOCATION_REQUIRED_IND
,CASE WHEN ICD_PRIOR_AUTHORIZATION_REQUIRED_IND IS NULL THEN 'N' ELSE ICD_PRIOR_AUTHORIZATION_REQUIRED_IND END AS ICD_PRIOR_AUTHORIZATION_REQUIRED_IND
,CASE WHEN ICD_POTENTIAL_SEVERE_COMPLICATIONS_IND IS NULL THEN 'N' ELSE ICD_POTENTIAL_SEVERE_COMPLICATIONS_IND END AS ICD_POTENTIAL_SEVERE_COMPLICATIONS_IND
,CASE WHEN ICD_PSYCHOLOGICAL_IND IS NULL THEN 'N' ELSE  ICD_PSYCHOLOGICAL_IND END AS ICD_PSYCHOLOGICAL_IND
,CASE WHEN ICD_SECURITY_AUTHORIZATION_IND IS NULL THEN 'N' ELSE  ICD_SECURITY_AUTHORIZATION_IND END AS ICD_SECURITY_AUTHORIZATION_IND
,CASE WHEN ICD_SITE_REQUIRED_IND IS NULL THEN 'N' ELSE ICD_SITE_REQUIRED_IND END AS ICD_SITE_REQUIRED_IND
,CASE WHEN ICD_SUBROGATION_REVIEW_IND IS NULL THEN 'N' ELSE ICD_SUBROGATION_REVIEW_IND END AS ICD_SUBROGATION_REVIEW_IND
,EM_REFERRAL_CODE
,EM_REFERRAL_DESC
,ICD_CODE_CHAPTER_NUMBER
,ICD_CODE_CHAPTER_NUMBER_SHORT_DESC
,ICD_CODE_CHAPTER_NUMBER_LONG_DESC
,BWC_INJURY_CLASS_DESC
,BWC_SPECIFIC_BODY_PART_DESC
,BWC_GENERIC_BODY_PART_DESC
,CASE WHEN END_DATE IS NULL THEN 'Y' ELSE 'N' END AS CURRENT_RECORD_IND
,EFFECTIVE_DATE AS RECORD_EFFECTIVE_DATE
,END_DATE AS RECORD_END_DATE
,EFFECTIVE_TIMESTAMP AS LOAD_DATETIME
,END_TIMESTAMP AS UPDATE_DATETIME
,'BWC' AS PRIMARY_SOURCE_SYSTEM
 from SCD )

 SELECT * FROM ETL