----SRC LAYER----
WITH
SRC_CNEA as ( SELECT *     from      DEV_VIEWS.DBMOBP00.TMPCNEA ),
SRC_ADRS as ( SELECT *     from      DEV_VIEWS.DBMOBP00.TMPADRS ),
SRC_ADRT as ( SELECT *     from      DEV_VIEWS.BWC_PEACH.TMPADRT )

----LOGIC LAYER----
,
LOGIC_CNEA as ( SELECT 
		cast(PRVDR_BASE_NMBR as TEXT) AS PRVDR_BASE_NMBR,
		lpad(cast(PRVDR_SFX_NMBR as TEXT),4,'0') AS PRVDR_SFX_NMBR,
		UPPER(TRIM(ADRS_TYPE_CODE)) AS ADRS_TYPE_CODE,
		ADRS_TYPE_LCT_NMBR::NUMERIC(4) AS ADRS_TYPE_LCT_NMBR,
		CNEA_CRT_DTTM AS CNEA_CRT_DTTM,
		ADRS_ID AS ADRS_ID,
		UPPER(TRIM(PRMRY_LCTN_IND)) AS PRMRY_LCTN_IND,
		EFCTV_DATE AS EFCTV_DATE,
		ENDNG_DATE AS ENDNG_DATE,
		UPPER(TRIM(CRT_USER_CODE)) AS CRT_USER_CODE,
		DCTVT_DTTM AS DCTVT_DTTM,
		UPPER(TRIM(DCTVT_USER_CODE)) AS DCTVT_USER_CODE,
		UPPER(TRIM(UPDT_PRGRM_NAME)) AS UPDT_PRGRM_NAME 
				from SRC_CNEA
            ),
LOGIC_ADRS as ( SELECT 
		ADRS_CRT_DTTM AS ADRS_CRT_DTTM,
		UPPER(TRIM(LINE_1_ADRS)) AS LINE_1_ADRS,
		NULLIF(UPPER(TRIM(LINE_2_ADRS)),'') AS LINE_2_ADRS,
		UPPER(TRIM(P_O_BOX_NMBR)) AS P_O_BOX_NMBR,
		UPPER(TRIM(CITY_NAME)) AS CITY_NAME,
		case when UPPER(TRIM(STATE_CODE))='' then NULL else UPPER(TRIM(STATE_CODE)) END AS STATE_CODE,
		UPPER(TRIM(ZIP_CODE_NMBR)) AS ZIP_CODE_NMBR,
		UPPER(TRIM(ZIP_CODE_PLS4_NMBR)) AS ZIP_CODE_PLS4_NMBR,
		NULLIF(UPPER(TRIM(CNTY_CODE)),'') AS CNTY_CODE,
		NULLIF(UPPER(TRIM(CNTY_NAME)),'') AS CNTY_NAME,
		UPPER(FRGN_ADRS_IND) AS FRGN_ADRS_IND,
		UPPER(TRIM(FRGN_TRTRY_NAME)) AS FRGN_TRTRY_NAME,
		UPPER(TRIM(FRGN_PSTL_CODE)) AS FRGN_PSTL_CODE,
		UPPER(TRIM(FRGN_CNTRY_NAME)) AS FRGN_CNTRY_NAME,
		case when trim(UPPER(FNLST_VLDTN_IND))='' then NULL else UPPER(FNLST_VLDTN_IND) end AS FNLST_VLDTN_IND,
		case when trim(UPPER(FNLST_OVRD_IND))='' then NULL else  UPPER(FNLST_OVRD_IND) end AS FNLST_OVRD_IND,
		UPPER(TRIM(CRT_USER_CODE)) AS CRT_USER_CODE,
		DCTVT_DTTM AS DCTVT_DTTM,
		UPPER(TRIM(DCTVT_USER_CODE)) AS DCTVT_USER_CODE,
		UPPER(TRIM(UPDT_PRGRM_NAME)) AS UPDT_PRGRM_NAME,
		ADRS_ID AS ADRS_ID 
				from SRC_ADRS
            ),
LOGIC_ADRT as ( SELECT 
		UPPER(TRIM(ADRS_TYPE_DESCR)) AS ADRS_TYPE_DESCR,
		CRT_DTTM AS CRT_DTTM,
		EFCTV_DATE AS EFCTV_DATE,
		ENDNG_DATE AS ENDNG_DATE,
		UPPER(TRIM(CRT_USER_CODE)) AS CRT_USER_CODE,
		DCTVT_DTTM AS DCTVT_DTTM,
		UPPER(TRIM(DCTVT_USER_CODE)) AS DCTVT_USER_CODE,
		UPPER(TRIM(UPDT_PRGRM_NAME)) AS UPDT_PRGRM_NAME,
		UPPER(TRIM(ADRS_TYPE_CODE)) AS ADRS_TYPE_CODE 
				from SRC_ADRT
            )
----RENAME LAYER ----
,
RENAME_CNEA as ( SELECT PRVDR_BASE_NMBR AS PRVDR_BASE_NMBR,PRVDR_SFX_NMBR AS PRVDR_SFX_NMBR,ADRS_TYPE_CODE AS ADRS_TYPE_CODE,ADRS_TYPE_LCT_NMBR AS ADRS_TYPE_LCT_NMBR,CNEA_CRT_DTTM AS CNEA_CRT_DTTM,ADRS_ID AS ADRS_ID,PRMRY_LCTN_IND AS PRMRY_LCTN_IND,EFCTV_DATE AS EFCTV_DATE,ENDNG_DATE AS ENDNG_DATE,CRT_USER_CODE AS CRT_USER_CODE,DCTVT_DTTM AS DCTVT_DTTM,DCTVT_USER_CODE AS DCTVT_USER_CODE,UPDT_PRGRM_NAME AS UPDT_PRGRM_NAME 
			from      LOGIC_CNEA
        ),
RENAME_ADRS as ( SELECT ADRS_CRT_DTTM AS ADRS_CRT_DTTM,LINE_1_ADRS AS LINE_1_ADRS,LINE_2_ADRS AS LINE_2_ADRS,P_O_BOX_NMBR AS P_O_BOX_NMBR,CITY_NAME AS CITY_NAME,STATE_CODE AS STATE_CODE,ZIP_CODE_NMBR AS ZIP_CODE_NMBR,ZIP_CODE_PLS4_NMBR AS ZIP_CODE_PLS4_NMBR,CNTY_CODE AS CNTY_CODE,CNTY_NAME AS CNTY_NAME,FRGN_ADRS_IND AS FRGN_ADRS_IND,FRGN_TRTRY_NAME AS FRGN_TRTRY_NAME,FRGN_PSTL_CODE AS FRGN_PSTL_CODE,FRGN_CNTRY_NAME AS FRGN_CNTRY_NAME,FNLST_VLDTN_IND AS FNLST_VLDTN_IND,FNLST_OVRD_IND AS FNLST_OVRD_IND,
			
			CRT_USER_CODE AS ADRS_CRT_USER_CODE,
			
			DCTVT_DTTM AS ADRS_DCTVT_DTTM,
			
			DCTVT_USER_CODE AS ADRS_DCTVT_USER_CODE,
			
			UPDT_PRGRM_NAME AS ADRS_UPDT_PRGRM_NAME,
			
			ADRS_ID AS ADRS_ADRS_ID 
			from      LOGIC_ADRS
        ),
RENAME_ADRT as ( SELECT ADRS_TYPE_DESCR AS ADRS_TYPE_DESCR,CRT_DTTM AS CRT_DTTM,
			
			EFCTV_DATE AS ADRT_EFCTV_DATE,
			
			ENDNG_DATE AS ADRT_ENDNG_DATE,
			
			CRT_USER_CODE AS ADRT_CRT_USER_CODE,
			
			DCTVT_DTTM AS ADRT_DCTVT_DTTM,
			
			DCTVT_USER_CODE AS ADRT_DCTVT_USER_CODE,
			
			UPDT_PRGRM_NAME AS ADRT_UPDT_PRGRM_NAME,
			
			ADRS_TYPE_CODE AS ADRT_ADRS_TYPE_CODE 
			from      LOGIC_ADRT
        )
----FILTER LAYER(uses aliases)----
,

        FILTER_CNEA as ( SELECT  * 
			from     RENAME_CNEA 
            
        ),

        FILTER_ADRS as ( SELECT  * 
			from     RENAME_ADRS 
            
        ),

        FILTER_ADRT as ( SELECT  * 
			from     RENAME_ADRT 
            
        )
----JOIN LAYER----
,
CNEA as ( SELECT * 
			from  FILTER_CNEA
				INNER JOIN FILTER_ADRS ON FILTER_CNEA.ADRS_ID = FILTER_ADRS.ADRS_ADRS_ID 
				INNER JOIN FILTER_ADRT ON FILTER_CNEA.ADRS_TYPE_CODE = FILTER_ADRT.ADRT_ADRS_TYPE_CODE  )
select * from CNEA