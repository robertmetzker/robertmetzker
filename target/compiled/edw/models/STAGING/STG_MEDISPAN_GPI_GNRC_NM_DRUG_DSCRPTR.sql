----SRC LAYER----
WITH
SRC_NDC as ( SELECT *     from      DEV_VIEWS.DBEABP00.TEADCVD ),
SRC_MGMD as ( SELECT *     from      DEV_VIEWS.DBEABP00.TEAMGMD ),
SRC_DGPI2 as ( SELECT *     from      DEV_VIEWS.PCMP.DRUG_GENERIC_PRODUCT_INDEX ),
SRC_DGPI4 as ( SELECT *     from      DEV_VIEWS.PCMP.DRUG_GENERIC_PRODUCT_INDEX ),
SRC_DGPI6 as ( SELECT *     from      DEV_VIEWS.PCMP.DRUG_GENERIC_PRODUCT_INDEX ),
SRC_DGPI8 as ( SELECT *     from      DEV_VIEWS.PCMP.DRUG_GENERIC_PRODUCT_INDEX ),
SRC_DGPI10 as ( SELECT *     from      DEV_VIEWS.PCMP.DRUG_GENERIC_PRODUCT_INDEX ),
SRC_DGPI12 as ( SELECT *     from      DEV_VIEWS.PCMP.DRUG_GENERIC_PRODUCT_INDEX ),
SRC_DGPI14 as ( SELECT *     from      DEV_VIEWS.PCMP.DRUG_GENERIC_PRODUCT_INDEX ),
SRC_NDC_VRSN as ( SELECT *     from      DEV_VIEWS.DBEABP00.TEAMDNV )
//SRC_NDC as ( SELECT *     from      TEADCVD),
//SRC_MGMD as ( SELECT *     from      TEAMGMD),
//SRC_derived as ( SELECT *     from      TEAMGMD),
//SRC_DGPI2 as ( SELECT *     from      DRUG_GENERIC_PRODUCT_INDEX),
//SRC_DGPI4 as ( SELECT *     from      DRUG_GENERIC_PRODUCT_INDEX),
//SRC_DGPI6 as ( SELECT *     from      DRUG_GENERIC_PRODUCT_INDEX),
//SRC_DGPI8 as ( SELECT *     from      DRUG_GENERIC_PRODUCT_INDEX),
//SRC_DGPI10 as ( SELECT *     from      DRUG_GENERIC_PRODUCT_INDEX),
//SRC_DGPI12 as ( SELECT *     from      DRUG_GENERIC_PRODUCT_INDEX),
//SRC_DGPI14 as ( SELECT *     from      DRUG_GENERIC_PRODUCT_INDEX),
//SRC_NDC_VRSN as ( SELECT *     from      TEAMDNV)
----LOGIC LAYER----
,
LOGIC_NDC as ( SELECT 
		TRIM(FK_NDCL_CODE)||TRIM(FK_DCPR_CODE)||TRIM(FK_NDCP_CODE) AS NDC_11_CODE,
		cast(BGNG_DATE as DATE) AS BGNG_DATE,
		cast(ENDNG_DATE as DATE) AS ENDNG_DATE,
		DCTVT_DTTM AS DCTVT_DTTM,
		FK_NDCV_NMBR AS FK_NDCV_NMBR,
		FK_NDCL_CODE AS FK_NDCL_CODE,
		FK_DCPR_CODE AS FK_DCPR_CODE,
		FK_NDCP_CODE AS FK_NDCP_CODE 
				from SRC_NDC
            ),
LOGIC_MGMD as ( SELECT 
		FK_MDDI_NMBR AS FK_MDDI_NMBR,
		FK_MDDF_CRT_DTTM AS FK_MDDF_CRT_DTTM,
		MGMD_CRT_DTTM AS MGMD_CRT_DTTM,
		TRIM(FK_MTDG_CODE) AS FK_MTDG_CODE,
		TRIM(FK_MTDC_CODE) AS FK_MTDC_CODE,
		TRIM(FK_MTDS_CODE) AS FK_MTDS_CODE,
		TRIM(FK_MTDN_CODE) AS FK_MTDN_CODE,
		TRIM(FK_MDNE_CODE) AS FK_MDNE_CODE,
		TRIM(FK_MDFT_CODE) AS FK_MDFT_CODE,
		TRIM(FK_MGGN_CODE) AS FK_MGGN_CODE,
		cast(EFCTV_DATE as DATE) AS EFCTV_DATE,
		cast(ENDNG_DATE as DATE) AS ENDNG_DATE,
		TRIM(CRT_USER_CODE) AS CRT_USER_CODE,
		TRIM(CRT_PRGRM_NAME) AS CRT_PRGRM_NAME,
		TRIM(DCTVT_USER_CODE) AS DCTVT_USER_CODE,
		TRIM(DCTVT_PRGRM_NAME) AS DCTVT_PRGRM_NAME,
		DCTVT_DTTM AS DCTVT_DTTM,
		FK_MTDG_CODE||FK_MTDC_CODE AS GPI_4_CLASS_CODE,
		FK_MTDG_CODE||FK_MTDC_CODE||FK_MTDS_CODE AS GPI_6_SUBCLASS_CODE,
		FK_MTDG_CODE||FK_MTDC_CODE||FK_MTDS_CODE||FK_MTDN_CODE AS GPI_8_DRUG_NAME_CODE,
		FK_MTDG_CODE||FK_MTDC_CODE||FK_MTDS_CODE||FK_MTDN_CODE||FK_MDNE_CODE AS GPI_10_DRUG_NAME_EXTENSION_CODE,
		FK_MTDG_CODE||FK_MTDC_CODE||FK_MTDS_CODE||FK_MTDN_CODE||FK_MDNE_CODE||FK_MDFT_CODE AS GPI_12_DRUG_DOSAGE_FORM_CODE,
		FK_MTDG_CODE||FK_MTDC_CODE||FK_MTDS_CODE||FK_MTDN_CODE||FK_MDNE_CODE||FK_MDFT_CODE||FK_MGGN_CODE AS GPI_14_CODE 
				from SRC_MGMD
            ),
LOGIC_DGPI2 as ( SELECT 
		TRIM(replace(DGPI_NM,'*','')) AS DGPI_NM,
		cast(DGPI_EFF_DT as DATE) AS DGPI_EFF_DT,
		DGPI_CD AS DGPI_CD,
		UPPER(VOID_IND) AS VOID_IND 
				from SRC_DGPI2
            ),
LOGIC_DGPI4 as ( SELECT 
		TRIM(replace(DGPI_NM,'*','')) AS DGPI_NM,
		cast(DGPI_EFF_DT as DATE) AS DGPI_EFF_DT,
		DGPI_CD AS DGPI_CD,
		UPPER(VOID_IND) AS VOID_IND 
				from SRC_DGPI4
            ),
LOGIC_DGPI6 as ( SELECT 
		TRIM(replace(DGPI_NM,'*',''))  AS DGPI_NM,
		cast(DGPI_EFF_DT as DATE) AS DGPI_EFF_DT,
		DGPI_CD AS DGPI_CD,
		UPPER(VOID_IND) AS VOID_IND 
				from SRC_DGPI6
            ),
LOGIC_DGPI8 as ( SELECT 
		TRIM(replace(DGPI_NM,'*',''))  AS DGPI_NM,
		cast(DGPI_EFF_DT as DATE) AS DGPI_EFF_DT,
		DGPI_CD AS DGPI_CD,
		UPPER(VOID_IND) AS VOID_IND 
				from SRC_DGPI8
            ),
LOGIC_DGPI10 as ( SELECT 
		TRIM(replace(DGPI_NM,'*',''))  AS DGPI_NM,
		cast(DGPI_EFF_DT as DATE) AS DGPI_EFF_DT,
		DGPI_CD AS DGPI_CD,
		UPPER(VOID_IND) AS VOID_IND 
				from SRC_DGPI10
            ),
LOGIC_DGPI12 as ( SELECT 
		TRIM(replace(DGPI_NM,'*',''))  AS DGPI_NM,
		cast(DGPI_EFF_DT as DATE) AS DGPI_EFF_DT,
		DGPI_CD AS DGPI_CD,
		UPPER(VOID_IND) AS VOID_IND 
				from SRC_DGPI12
            ),
LOGIC_DGPI14 as ( SELECT 
		TRIM(replace(DGPI_NM,'*',''))  AS DGPI_NM,
		cast(DGPI_EFF_DT as DATE) AS DGPI_EFF_DT,
		DGPI_CD AS DGPI_CD,
		UPPER(VOID_IND) AS VOID_IND 
				from SRC_DGPI14
            ),
LOGIC_NDC_VRSN as ( SELECT 
		FK_MDDI_NMBR AS FK_MDDI_NMBR,
		EFCTV_DATE AS EFCTV_DATE,
		ENDNG_DATE AS ENDNG_DATE,
		FK_NDCL_CODE AS FK_NDCL_CODE,
		FK_DCPR_CODE AS FK_DCPR_CODE,
		FK_NDCP_CODE AS FK_NDCP_CODE,
		FK_NDCV_NMBR AS FK_NDCV_NMBR,
		DCTVT_DTTM AS DCTVT_DTTM 
				from SRC_NDC_VRSN
            )
----RENAME LAYER ----
,
RENAME_NDC as ( SELECT NDC_11_CODE,
			
			BGNG_DATE AS NDC_EFFECTIVE_DATE,
			
			ENDNG_DATE AS NDC_END_DATE,
			
			DCTVT_DTTM AS NDC_DCTVT_DTTM,FK_NDCV_NMBR AS FK_NDCV_NMBR,FK_NDCL_CODE AS FK_NDCL_CODE,FK_DCPR_CODE AS FK_DCPR_CODE,FK_NDCP_CODE AS FK_NDCP_CODE 
			from      LOGIC_NDC
        ),
RENAME_MGMD as ( SELECT FK_MDDI_NMBR AS FK_MDDI_NMBR,FK_MDDF_CRT_DTTM AS FK_MDDF_CRT_DTTM,MGMD_CRT_DTTM AS MGMD_CRT_DTTM,FK_MTDG_CODE AS FK_MTDG_CODE,FK_MTDC_CODE AS FK_MTDC_CODE,FK_MTDS_CODE AS FK_MTDS_CODE,FK_MTDN_CODE AS FK_MTDN_CODE,FK_MDNE_CODE AS FK_MDNE_CODE,FK_MDFT_CODE AS FK_MDFT_CODE,FK_MGGN_CODE AS FK_MGGN_CODE,
			
			EFCTV_DATE AS GPI_EFFECTIVE_DATE,
			
			ENDNG_DATE AS GPI_END_DATE,CRT_USER_CODE AS CRT_USER_CODE,CRT_PRGRM_NAME AS CRT_PRGRM_NAME,DCTVT_USER_CODE AS DCTVT_USER_CODE,DCTVT_PRGRM_NAME AS DCTVT_PRGRM_NAME,DCTVT_DTTM AS DCTVT_DTTM,
			
			FK_MTDG_CODE AS GPI_2_GROUP_CODE , GPI_4_CLASS_CODE as GPI_4_CLASS_CODE, GPI_6_SUBCLASS_CODE,
			GPI_8_DRUG_NAME_CODE,
			GPI_10_DRUG_NAME_EXTENSION_CODE,
			GPI_12_DRUG_DOSAGE_FORM_CODE,
			GPI_14_CODE
			from      LOGIC_MGMD
        ),
RENAME_DGPI2 as ( SELECT 
			
			DGPI_NM AS GPI_2_GROUP_DESC,
			
			DGPI_EFF_DT AS DGPI2_DGPI_EFF_DT,
			
			DGPI_CD AS DGPI2_DGPI_CD,
			
			VOID_IND AS DGPI2_VOID_IND 
			from      LOGIC_DGPI2
        ),
RENAME_DGPI4 as ( SELECT 
			
			DGPI_NM AS GPI_4_CLASS_DESC,
			
			DGPI_EFF_DT AS DGPI4_DGPI_EFF_DT,
			
			DGPI_CD AS DGPI4_DGPI_CD,
			
			VOID_IND AS DGPI4_VOID_IND 
			from      LOGIC_DGPI4
        ),
RENAME_DGPI6 as ( SELECT 
			
			DGPI_NM AS GPI_6_SUBCLASS_DESC,
			
			DGPI_EFF_DT AS DGPI6_DGPI_EFF_DT,
			
			DGPI_CD AS DGPI6_DGPI_CD,
			
			VOID_IND AS DGPI6_VOID_IND 
			from      LOGIC_DGPI6
        ),
RENAME_DGPI8 as ( SELECT 
			
			DGPI_NM AS GPI_8_DRUG_NAME_DESC,
			
			DGPI_EFF_DT AS DGPI8_DGPI_EFF_DT,
			
			DGPI_CD AS DGPI8_DGPI_CD,
			
			VOID_IND AS DGPI8_VOID_IND 
			from      LOGIC_DGPI8
        ),
RENAME_DGPI10 as ( SELECT 
			
			DGPI_NM AS GPI_10_DRUG_NAME_EXT_DESC,
			
			DGPI_EFF_DT AS DGPI10_DGPI_EFF_DT,
			
			DGPI_CD AS DGPI10_DGPI_CD,
			
			VOID_IND AS DGPI10_VOID_IND 
			from      LOGIC_DGPI10
        ),
RENAME_DGPI12 as ( SELECT 
			
			DGPI_NM AS GPI_12_DRUG_DOSAGE_FORM_DESC,
			
			DGPI_EFF_DT AS DGPI12_DGPI_EFF_DT,
			
			DGPI_CD AS DGPI12_DGPI_CD,
			
			VOID_IND AS DGPI12_VOID_IND 
			from      LOGIC_DGPI12
        ),
RENAME_DGPI14 as ( SELECT 
			
			DGPI_NM AS GPI_14_DESC,
			
			DGPI_EFF_DT AS DGPI14_DGPI_EFF_DT,
			
			DGPI_CD AS DGPI14_DGPI_CD,
			
			VOID_IND AS DGPI14_VOID_IND 
			from      LOGIC_DGPI14
        ),
RENAME_NDC_VRSN as ( SELECT 
			
			FK_MDDI_NMBR AS NDC_VRSN_FK_MDDI_NMBR,
			
			EFCTV_DATE AS NDC_VRSN_EFCTV_DATE,
			
			ENDNG_DATE AS NDC_VRSN_ENDNG_DATE,
			
			FK_NDCL_CODE AS NDC_VRSN_FK_NDCL_CODE,
			
			FK_DCPR_CODE AS NDC_VRSN_FK_DCPR_CODE,
			
			FK_NDCP_CODE AS NDC_VRSN_FK_NDCP_CODE,
			
			FK_NDCV_NMBR AS NDC_VRSN_FK_NDCV_NMBR,
			
			DCTVT_DTTM AS NDC_VRSN_DCTVT_DTTM 
			from      LOGIC_NDC_VRSN
        )
----FILTER LAYER(uses aliases)----
,

        FILTER_NDC as ( SELECT  *,
			ROW_NUMBER() OVER (PARTITION BY FK_NDCL_CODE,FK_DCPR_CODE,FK_NDCP_CODE ORDER BY FK_NDCV_NMBR DESC, NDC_DCTVT_DTTM DESC) AS ROWN
			from     RENAME_NDC 
            WHERE NDC_DCTVT_DTTM > CURRENT_DATE
			qualify ROWN=1
        ),

        FILTER_NDC_VRSN as ( SELECT  *,
			ROW_NUMBER() OVER (PARTITION BY NDC_VRSN_FK_NDCL_CODE,NDC_VRSN_FK_DCPR_CODE,NDC_VRSN_FK_NDCP_CODE,NDC_VRSN_FK_NDCV_NMBR ORDER BY NDC_VRSN_DCTVT_DTTM DESC) AS ROWN
			from     RENAME_NDC_VRSN 
            WHERE NDC_VRSN_EFCTV_DATE <= CURRENT_DATE AND NDC_VRSN_ENDNG_DATE >= CURRENT_DATE
			qualify ROWN=1

        ),

        FILTER_MGMD as ( SELECT  * 
			from     RENAME_MGMD 
            WHERE DCTVT_DTTM > CURRENT_DATE
        ),

        FILTER_DGPI2 as ( SELECT  *,
				ROW_NUMBER () OVER (PARTITION BY DGPI2_DGPI_CD ORDER BY DGPI2_DGPI_EFF_DT DESC) AS ROWN 
			from     RENAME_DGPI2 WHERE DGPI2_VOID_IND='N'
			qualify ROWN=1 
            
        ),

        FILTER_DGPI4 as (SELECT  *,
				ROW_NUMBER () OVER (PARTITION BY DGPI4_DGPI_CD ORDER BY DGPI4_DGPI_EFF_DT DESC) AS ROWN 
			from     RENAME_DGPI4 WHERE DGPI4_VOID_IND='N'
			qualify ROWN=1 
            
        ),

        FILTER_DGPI6 as ( SELECT  *,
				 ROW_NUMBER () OVER (PARTITION BY DGPI6_DGPI_CD ORDER BY DGPI6_DGPI_EFF_DT DESC) AS ROWN 
			from     RENAME_DGPI6 WHERE DGPI6_VOID_IND='N'
            qualify ROWN=1 
            
        ),

        FILTER_DGPI8 as ( SELECT  *,
				ROW_NUMBER () OVER (PARTITION BY DGPI8_DGPI_CD ORDER BY DGPI8_DGPI_EFF_DT DESC) AS ROWN 
			from     RENAME_DGPI8 WHERE DGPI8_VOID_IND='N'
            qualify ROWN=1 
            
        ),

        FILTER_DGPI10 as ( SELECT  *,
				ROW_NUMBER () OVER (PARTITION BY DGPI10_DGPI_CD ORDER BY DGPI10_DGPI_EFF_DT DESC) AS ROWN 
			from     RENAME_DGPI10 WHERE DGPI10_VOID_IND='N'
            qualify ROWN=1
            
        ),

        FILTER_DGPI12 as ( SELECT  *,
				ROW_NUMBER () OVER (PARTITION BY DGPI12_DGPI_CD ORDER BY DGPI12_DGPI_EFF_DT DESC) AS ROWN 
			from     RENAME_DGPI12 WHERE DGPI12_VOID_IND='N'
            qualify ROWN=1
            
        ),

        FILTER_DGPI14 as ( SELECT  *,
				ROW_NUMBER () OVER (PARTITION BY DGPI14_DGPI_CD ORDER BY DGPI14_DGPI_EFF_DT DESC) AS ROWN 
			from     RENAME_DGPI14 WHERE DGPI14_VOID_IND='N'
            qualify ROWN=1
            
        )
----JOIN LAYER----
,
NDC_VRSN as ( SELECT * 
			from  FILTER_NDC_VRSN
				INNER JOIN FILTER_MGMD ON FILTER_NDC_VRSN.NDC_VRSN_FK_MDDI_NMBR = FILTER_MGMD.FK_MDDI_NMBR 
				LEFT JOIN FILTER_DGPI2 ON FILTER_MGMD.GPI_2_GROUP_CODE = FILTER_DGPI2.DGPI2_DGPI_CD 
				LEFT JOIN FILTER_DGPI4 ON FILTER_MGMD.GPI_4_CLASS_CODE = FILTER_DGPI4.DGPI4_DGPI_CD 
				LEFT JOIN FILTER_DGPI6 ON FILTER_MGMD.GPI_6_SUBCLASS_CODE = FILTER_DGPI6.DGPI6_DGPI_CD 
				LEFT JOIN FILTER_DGPI8 ON FILTER_MGMD.GPI_8_DRUG_NAME_CODE = FILTER_DGPI8.DGPI8_DGPI_CD 
				LEFT JOIN FILTER_DGPI10 ON FILTER_MGMD.GPI_10_DRUG_NAME_EXTENSION_CODE = FILTER_DGPI10.DGPI10_DGPI_CD 
				LEFT JOIN FILTER_DGPI12 ON FILTER_MGMD.GPI_12_DRUG_DOSAGE_FORM_CODE = FILTER_DGPI12.DGPI12_DGPI_CD 
				LEFT JOIN FILTER_DGPI14 ON FILTER_MGMD.GPI_14_CODE = FILTER_DGPI14.DGPI14_DGPI_CD  ),
NDC as ( SELECT * 
			from  FILTER_NDC
				INNER JOIN NDC_VRSN ON FILTER_NDC.FK_NDCL_CODE = NDC_VRSN.NDC_VRSN_FK_NDCL_CODE AND FILTER_NDC.FK_DCPR_CODE = NDC_VRSN.NDC_VRSN_FK_DCPR_CODE 
            AND FILTER_NDC.FK_NDCP_CODE = NDC_VRSN.NDC_VRSN_FK_NDCP_CODE AND FILTER_NDC.FK_NDCV_NMBR = NDC_VRSN.NDC_VRSN_FK_NDCV_NMBR ),
--- s ETL LAYER ----

ETL AS (Select NDC_11_CODE
, NDC_EFFECTIVE_DATE
, case when NDC_END_DATE = '3000-01-01'::DATE THEN NULL ELSE NDC_END_DATE::DATE END AS NDC_END_DATE 
, FK_MDDI_NMBR
, FK_MDDF_CRT_DTTM
, MGMD_CRT_DTTM
, FK_MTDG_CODE
, FK_MTDC_CODE
, FK_MTDS_CODE
, FK_MTDN_CODE
, FK_MDNE_CODE
, FK_MDFT_CODE
, FK_MGGN_CODE
, case when ROW_NUMBER() OVER (PARTITION BY NDC_11_CODE order by GPI_EFFECTIVE_DATE) = 1 then NDC_EFFECTIVE_DATE else GPI_EFFECTIVE_DATE end as START_DATE
, GPI_EFFECTIVE_DATE
, CASE WHEN GPI_END_DATE = '3000-01-01'::DATE THEN NULL ELSE GPI_END_DATE::DATE END AS GPI_END_DATE
, CRT_USER_CODE
, CRT_PRGRM_NAME
, DCTVT_USER_CODE
, DCTVT_PRGRM_NAME
, DCTVT_DTTM
, GPI_2_GROUP_CODE
, GPI_2_GROUP_DESC
, GPI_4_CLASS_CODE
, GPI_4_CLASS_DESC
, GPI_6_SUBCLASS_CODE
, GPI_6_SUBCLASS_DESC
, GPI_8_DRUG_NAME_CODE
, GPI_8_DRUG_NAME_DESC
, GPI_10_DRUG_NAME_EXTENSION_CODE as GPI_10_DRUG_NAME_EXT_CODE 
, GPI_10_DRUG_NAME_EXT_DESC 
, GPI_12_DRUG_DOSAGE_FORM_CODE
, GPI_12_DRUG_DOSAGE_FORM_DESC
, GPI_14_CODE
, GPI_14_DESC
, NDC_VRSN_FK_MDDI_NMBR
, NDC_VRSN_EFCTV_DATE
, NDC_VRSN_ENDNG_DATE
, NDC_VRSN_FK_NDCL_CODE
, NDC_VRSN_FK_DCPR_CODE
, NDC_VRSN_FK_NDCP_CODE
, NDC_VRSN_FK_NDCV_NMBR
, NDC_VRSN_DCTVT_DTTM
, NDC_DCTVT_DTTM
, FK_NDCV_NMBR
, FK_NDCL_CODE
, FK_DCPR_CODE
, FK_NDCP_CODE
, DGPI2_DGPI_EFF_DT
, DGPI4_DGPI_EFF_DT
, DGPI6_DGPI_EFF_DT
, DGPI8_DGPI_EFF_DT
, DGPI10_DGPI_EFF_DT
, DGPI12_DGPI_EFF_DT
, DGPI14_DGPI_EFF_DT
, DGPI2_DGPI_CD
, DGPI4_DGPI_CD
, DGPI6_DGPI_CD
, DGPI8_DGPI_CD
, DGPI10_DGPI_CD
, DGPI12_DGPI_CD
, DGPI14_DGPI_CD
, DGPI2_VOID_IND
, DGPI4_VOID_IND
, DGPI6_VOID_IND
, DGPI8_VOID_IND
, DGPI10_VOID_IND
, DGPI12_VOID_IND
, DGPI14_VOID_IND
 from NDC)
 SELECT * FROM ETL