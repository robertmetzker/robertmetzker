----SRC LAYER----
WITH
SRC_CSH as ( SELECT *     from      DEV_VIEWS.PCMP.CLAIM_CLAIM_STATUS_HISTORY ),
SRC_CLM as ( SELECT *     from      DEV_VIEWS.PCMP.CLAIM),
SRC_CSTT as ( SELECT *     from      DEV_VIEWS.PCMP.CLAIM_STATE_TYPE),
SRC_CSTS as ( SELECT *     from      DEV_VIEWS.PCMP.CLAIM_STATUS_TYPE),
SRC_CTRT as ( SELECT *     from      DEV_VIEWS.PCMP.CLAIM_TRANSITION_REASON_TYPE )
----LOGIC LAYER----
,
LOGIC_CSH as ( SELECT 
		HIST_ID AS HIST_ID,
		CLM_CLM_STS_ID::NUMERIC(31,0) AS CLM_CLM_STS_ID,
		AGRE_ID::NUMERIC(31,0) AS AGRE_ID,
		cast(CLM_CLM_STS_STT_DT as DATE) AS CLM_CLM_STS_STT_DT,
		cast(CLM_CLM_STS_EFF_DT as DATE) AS CLM_CLM_STS_EFF_DT,
		cast(CLM_CLM_STS_END_DT as DATE) AS CLM_CLM_STS_END_DT,
		UPPER(TRIM(CLM_STT_TYP_CD)) AS CLM_STT_TYP_CD,
		UPPER(TRIM(CLM_STS_TYP_CD)) AS CLM_STS_TYP_CD,
		UPPER(TRIM(CLM_TRANS_RSN_TYP_CD)) AS CLM_TRANS_RSN_TYP_CD,
		UPPER(TRIM(CLM_CLM_STS_RSN_COMT)) AS CLM_CLM_STS_RSN_COMT,
		AUDIT_USER_ID_CREA::NUMERIC(31,0) AS AUDIT_USER_ID_CREA,
		AUDIT_USER_CREA_DTM AS AUDIT_USER_CREA_DTM,
		AUDIT_USER_ID_UPDT::NUMERIC(31,0) AS AUDIT_USER_ID_UPDT,
		AUDIT_USER_UPDT_DTM AS AUDIT_USER_UPDT_DTM,
		HIST_EFF_DTM AS HIST_EFF_DTM,
		HIST_END_DTM::timestamp AS HIST_END_DTM 
				from SRC_CSH
            ),
LOGIC_CLM as ( SELECT 
		UPPER(TRIM(CLM_NO)) AS CLM_NO,
		AGRE_ID AS AGRE_ID,
		UPPER(CLM_REL_SNPSHT_IND) AS CLM_REL_SNPSHT_IND 
				from SRC_CLM
            ),
LOGIC_CSTT as ( SELECT 
		UPPER(TRIM(CLM_STT_TYP_NM)) AS CLM_STT_TYP_NM,
		UPPER(TRIM(CLM_STT_TYP_CD)) AS CLM_STT_TYP_CD,
		UPPER(VOID_IND) AS VOID_IND 
				from SRC_CSTT
            ),
LOGIC_CSTS as ( SELECT 
		UPPER(TRIM(CLM_STS_TYP_NM)) AS CLM_STS_TYP_NM,
		UPPER(TRIM(CLM_STS_TYP_CD)) AS CLM_STS_TYP_CD,
		UPPER(VOID_IND) AS VOID_IND 
				from SRC_CSTS
            ),
LOGIC_CTRT as ( SELECT 
		UPPER(TRIM(CLM_TRANS_RSN_TYP_NM)) AS CLM_TRANS_RSN_TYP_NM,
		UPPER(TRIM(CLM_TRANS_RSN_TYP_CD)) AS CLM_TRANS_RSN_TYP_CD,
		UPPER(VOID_IND) AS VOID_IND 
				from SRC_CTRT
            )
----RENAME LAYER ----
,
RENAME_CSH as ( SELECT HIST_ID AS HIST_ID,CLM_CLM_STS_ID AS CLM_CLM_STS_ID,AGRE_ID AS AGRE_ID,CLM_CLM_STS_STT_DT AS CLM_CLM_STS_STT_DT,CLM_CLM_STS_EFF_DT AS CLM_CLM_STS_EFF_DT,CLM_CLM_STS_END_DT AS CLM_CLM_STS_END_DT,CLM_STT_TYP_CD AS CLM_STT_TYP_CD,CLM_STS_TYP_CD AS CLM_STS_TYP_CD,CLM_TRANS_RSN_TYP_CD AS CLM_TRANS_RSN_TYP_CD,CLM_CLM_STS_RSN_COMT AS CLM_CLM_STS_RSN_COMT,AUDIT_USER_ID_CREA AS AUDIT_USER_ID_CREA,AUDIT_USER_CREA_DTM AS AUDIT_USER_CREA_DTM,AUDIT_USER_ID_UPDT AS AUDIT_USER_ID_UPDT,AUDIT_USER_UPDT_DTM AS AUDIT_USER_UPDT_DTM,HIST_EFF_DTM AS HIST_EFF_DTM,HIST_END_DTM AS HIST_END_DTM 
			from      LOGIC_CSH
        ),
RENAME_CLM as ( SELECT CLM_NO AS CLM_NO,
			
			AGRE_ID AS CLM_AGRE_ID,CLM_REL_SNPSHT_IND AS CLM_REL_SNPSHT_IND 
			from      LOGIC_CLM
        ),
RENAME_CSTT as ( SELECT CLM_STT_TYP_NM AS CLM_STT_TYP_NM,
			
			CLM_STT_TYP_CD AS CSTT_CLM_STT_TYP_CD,
			
			VOID_IND AS CSTT_VOID_IND 
			from      LOGIC_CSTT
        ),
RENAME_CSTS as ( SELECT CLM_STS_TYP_NM AS CLM_STS_TYP_NM,
			
			CLM_STS_TYP_CD AS CSTS_CLM_STS_TYP_CD,
			
			VOID_IND AS CSTS_VOID_IND 
			from      LOGIC_CSTS
        ),
RENAME_CTRT as ( SELECT CLM_TRANS_RSN_TYP_NM AS CLM_TRANS_RSN_TYP_NM,
			
			CLM_TRANS_RSN_TYP_CD AS CTRT_CLM_TRANS_RSN_TYP_CD,
			
			VOID_IND AS CTRT_VOID_IND 
			from      LOGIC_CTRT
        )
----FILTER LAYER(uses aliases)----
,

        FILTER_CSH as ( SELECT  * 
			from     RENAME_CSH 
            
        ),

        FILTER_CLM as ( SELECT  * 
			from     RENAME_CLM 
            WHERE CLM_REL_SNPSHT_IND = 'N'
        ),

        FILTER_CSTS as ( SELECT  * 
			from     RENAME_CSTS 
            
        ),

        FILTER_CSTT as ( SELECT  * 
			from     RENAME_CSTT 
            
        ),

        FILTER_CTRT as ( SELECT  * 
			from     RENAME_CTRT 
            
        )
----JOIN LAYER----
,
CSH as ( SELECT * 
			from  FILTER_CSH
				INNER JOIN FILTER_CLM ON FILTER_CSH.AGRE_ID = FILTER_CLM.CLM_AGRE_ID 
				INNER JOIN FILTER_CSTS ON FILTER_CSH.CLM_STS_TYP_CD = FILTER_CSTS.CSTS_CLM_STS_TYP_CD 
				INNER JOIN FILTER_CSTT ON FILTER_CSH.CLM_STT_TYP_CD = FILTER_CSTT.CSTT_CLM_STT_TYP_CD 
				INNER JOIN FILTER_CTRT ON FILTER_CSH.CLM_TRANS_RSN_TYP_CD = FILTER_CTRT.CTRT_CLM_TRANS_RSN_TYP_CD  )
select * from CSH