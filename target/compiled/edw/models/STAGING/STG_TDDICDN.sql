----SRC LAYER----
WITH
SRC_ICDN as ( SELECT *     from      DEV_VIEWS.DBDWQP00.TDDICDN )
//SRC_ICDN as ( SELECT *     from      TDDICDN)
----LOGIC LAYER----
,
LOGIC_ICDN as ( SELECT 
		NULLIF(TRIM(ICDC_CODE), '')  AS ICDC_CODE,
		TRIM(ICDV_CODE) AS ICDV_CODE,
		TRIM(REGEXP_REPLACE(ICDV_CODE, '[^[:digit:]]', ' '))::INTEGER AS ICD_CODE_VERSION_NUMBER,
		cast(ICDN_VRSN_BGN_DATE as DATE) AS ICDN_VRSN_BGN_DATE,
		ICDN_VRSN_BGN_TMS AS ICDN_VRSN_BGN_TMS,
		cast(ICDN_VRSN_END_DATE as DATE) AS ICDN_VRSN_END_DATE,
		ICDN_VRSN_END_TMS AS ICDN_VRSN_END_TMS,
		UPPER(TRIM(ICD_DESC)) AS ICD_DESC,
		UPPER(TRIM(ICD_LONG_DESC)) AS ICD_LONG_DESC,
		cast(ICDN_EFCTV_DATE as DATE) AS ICDN_EFCTV_DATE,
		cast(ICDN_ENDNG_DATE as DATE) AS ICDN_ENDNG_DATE,
		UPPER(TRIM(ICDN_CRNT_FLAG)) AS ICDN_CRNT_FLAG,
		UPPER(TRIM(ICDN_CRNT_MAX_FLAG)) AS ICDN_CRNT_MAX_FLAG,
		UPPER(TRIM(ICDN_FTR_FLAG)) AS ICDN_FTR_FLAG,
		TRIM(CRT_USER_ID) AS CRT_USER_ID,
		NULLIF(TRIM(DCTVT_USER_ID), '') AS DCTVT_USER_ID 
				from SRC_ICDN
            )
----RENAME LAYER ----
,
RENAME_ICDN as ( SELECT 
			
			ICDC_CODE AS ICD_CODE,ICDV_CODE AS ICDV_CODE,
			
			ICD_CODE_VERSION_NUMBER AS ICD_CODE_VERSION_NUMBER,ICDN_VRSN_BGN_DATE AS ICDN_VRSN_BGN_DATE,ICDN_VRSN_BGN_TMS AS ICDN_VRSN_BGN_TMS,ICDN_VRSN_END_DATE AS ICDN_VRSN_END_DATE,ICDN_VRSN_END_TMS AS ICDN_VRSN_END_TMS,
			
			ICD_DESC AS ICD_CODE_SHORT_DESC,
			
			ICD_LONG_DESC AS ICD_CODE_LONG_DESC,ICDN_EFCTV_DATE AS ICDN_EFCTV_DATE,ICDN_ENDNG_DATE AS ICDN_ENDNG_DATE,ICDN_CRNT_FLAG AS ICDN_CRNT_FLAG,ICDN_CRNT_MAX_FLAG AS ICDN_CRNT_MAX_FLAG,ICDN_FTR_FLAG AS ICDN_FTR_FLAG,CRT_USER_ID AS CRT_USER_ID,DCTVT_USER_ID AS DCTVT_USER_ID 
			from      LOGIC_ICDN
        )
----FILTER LAYER(uses aliases)----
,

        FILTER_ICDN as ( SELECT  * 
			from     RENAME_ICDN 
            
        )
----JOIN LAYER----
,
 JOIN_ICDN as ( SELECT * 
			from  FILTER_ICDN )
 SELECT * FROM JOIN_ICDN