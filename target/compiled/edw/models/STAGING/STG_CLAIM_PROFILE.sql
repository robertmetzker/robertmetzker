----SRC LAYER----
WITH
SRC_CP as ( SELECT *     from      DEV_VIEWS.PCMP.CLAIM_PROFILE ),
SRC_CPCT as ( SELECT *     from      DEV_VIEWS.PCMP.CLAIM_PROFILE_CATEGORY_TYPE ),
SRC_PS as ( SELECT *     from      DEV_VIEWS.PCMP.PROFILE_STATEMENT ),
SRC_PSVT as ( SELECT *     from      DEV_VIEWS.PCMP.PROFILE_SELECTION_VALUE_TYPE )
----LOGIC LAYER----
,
LOGIC_CP as ( SELECT 
		CLM_PRFL_ID AS CLM_PRFL_ID,
		AGRE_ID AS AGRE_ID,
		UPPER(TRIM(CLM_PRFL_CTG_TYP_CD)) AS CLM_PRFL_CTG_TYP_CD,
		PRFL_STMT_ID AS PRFL_STMT_ID,
		PRFL_STMT_SEL_ID AS PRFL_STMT_SEL_ID,
		PRFL_STMT_SEL_NEST_ID AS PRFL_STMT_SEL_NEST_ID,
		UPPER(TRIM(PRFL_SEL_VAL_TYP_CD)) AS PRFL_SEL_VAL_TYP_CD,
		UPPER(TRIM(CLM_PRFL_ANSW_TEXT)) AS CLM_PRFL_ANSW_TEXT,
		AUDIT_USER_ID_CREA AS AUDIT_USER_ID_CREA,
		AUDIT_USER_CREA_DTM AS AUDIT_USER_CREA_DTM,
		AUDIT_USER_ID_UPDT AS AUDIT_USER_ID_UPDT,
		AUDIT_USER_UPDT_DTM AS AUDIT_USER_UPDT_DTM,
		UPPER(VOID_IND) AS VOID_IND 
				from SRC_CP
            ),
LOGIC_CPCT as ( SELECT 
		UPPER(TRIM(CLM_PRFL_CTG_TYP_NM)) AS CLM_PRFL_CTG_TYP_NM,
		UPPER(TRIM(CLM_PRFL_CTG_TYP_CD)) AS CLM_PRFL_CTG_TYP_CD,
		UPPER(VOID_IND) AS VOID_IND 
				from SRC_CPCT
            ),
LOGIC_PS as ( SELECT 
		UPPER(TRIM(PRFL_STMT_DESC)) AS PRFL_STMT_DESC,
		PRFL_STMT_ID AS PRFL_STMT_ID,
		UPPER(PRFL_STMT_VOID_IND) AS PRFL_STMT_VOID_IND 
				from SRC_PS
            ),
LOGIC_PSVT as ( SELECT 
		UPPER(TRIM(PRFL_SEL_VAL_TYP_NM)) AS PRFL_SEL_VAL_TYP_NM,
		UPPER(TRIM(PRFL_SEL_VAL_TYP_CD)) AS PRFL_SEL_VAL_TYP_CD,
		UPPER(PRFL_SEL_VAL_TYP_VOID_IND) AS PRFL_SEL_VAL_TYP_VOID_IND 
				from SRC_PSVT
            )
----RENAME LAYER ----
,
RENAME_CP as ( SELECT CLM_PRFL_ID AS CLM_PRFL_ID,AGRE_ID AS AGRE_ID,CLM_PRFL_CTG_TYP_CD AS CLM_PRFL_CTG_TYP_CD,PRFL_STMT_ID AS PRFL_STMT_ID,
PRFL_STMT_SEL_ID AS PRFL_STMT_SEL_ID,
PRFL_STMT_SEL_NEST_ID AS PRFL_STMT_SEL_NEST_ID,PRFL_SEL_VAL_TYP_CD AS PRFL_SEL_VAL_TYP_CD,
CLM_PRFL_ANSW_TEXT AS CLM_PRFL_ANSW_TEXT,AUDIT_USER_ID_CREA AS AUDIT_USER_ID_CREA,
AUDIT_USER_CREA_DTM AS AUDIT_USER_CREA_DTM,AUDIT_USER_ID_UPDT AS AUDIT_USER_ID_UPDT,AUDIT_USER_UPDT_DTM AS AUDIT_USER_UPDT_DTM,VOID_IND AS VOID_IND 
			from      LOGIC_CP
        ),
RENAME_CPCT as ( SELECT CLM_PRFL_CTG_TYP_NM AS CLM_PRFL_CTG_TYP_NM,
			
			CLM_PRFL_CTG_TYP_CD AS CPCT_CLM_PRFL_CTG_TYP_CD,
			
			VOID_IND AS CPCT_VOID_IND 
			from      LOGIC_CPCT
        ),
RENAME_PS as ( SELECT PRFL_STMT_DESC AS PRFL_STMT_DESC,
			
			PRFL_STMT_ID AS PS_PRFL_STMT_ID,
			
			PRFL_STMT_VOID_IND AS PS_PRFL_STMT_VOID_IND 
			from      LOGIC_PS
        ),
RENAME_PSVT as ( SELECT PRFL_SEL_VAL_TYP_NM AS PRFL_SEL_VAL_TYP_NM,
			
			PRFL_SEL_VAL_TYP_CD AS PSVT_PRFL_SEL_VAL_TYP_CD,
			
			PRFL_SEL_VAL_TYP_VOID_IND AS PSVT_PRFL_SEL_VAL_TYP_VOID_IND 
			from      LOGIC_PSVT
        )
----FILTER LAYER(uses aliases)----
,

        FILTER_CP as ( SELECT  * 
			from     RENAME_CP 
            
        ),

        FILTER_CPCT as ( SELECT  * 
			from     RENAME_CPCT 
            WHERE CPCT_VOID_IND = 'N'
        ),

        FILTER_PS as ( SELECT  * 
			from     RENAME_PS 
            WHERE PS_PRFL_STMT_VOID_IND = 'N'
        ),

        FILTER_PSVT as ( SELECT  * 
			from     RENAME_PSVT 
            WHERE PSVT_PRFL_SEL_VAL_TYP_VOID_IND = 'N'
        )
----JOIN LAYER----
,
CP as ( SELECT * 
			from  FILTER_CP
				LEFT JOIN  FILTER_CPCT ON FILTER_CP.CLM_PRFL_CTG_TYP_CD = FILTER_CPCT.CPCT_CLM_PRFL_CTG_TYP_CD 
				LEFT JOIN  FILTER_PS ON FILTER_CP.PRFL_STMT_ID = FILTER_PS.PS_PRFL_STMT_ID 
				LEFT JOIN  FILTER_PSVT ON FILTER_CP.CLM_PRFL_ANSW_TEXT = FILTER_PSVT.PSVT_PRFL_SEL_VAL_TYP_CD  ),        

-- ETL LAYER --
ETL AS ( SELECT CLM_PRFL_ID::NUMERIC(31) AS CLM_PRFL_ID
,AGRE_ID::NUMERIC(31) AS AGRE_ID
,CLM_PRFL_CTG_TYP_CD
,CLM_PRFL_CTG_TYP_NM
,PRFL_STMT_ID::NUMERIC(31) AS PRFL_STMT_ID
,PRFL_STMT_DESC
,PRFL_STMT_SEL_ID::NUMERIC(31) AS PRFL_STMT_SEL_ID
,PRFL_STMT_SEL_NEST_ID::NUMERIC(31) AS PRFL_STMT_SEL_NEST_ID
,PRFL_SEL_VAL_TYP_CD
,PRFL_SEL_VAL_TYP_NM
,CLM_PRFL_ANSW_TEXT
,AUDIT_USER_ID_CREA::NUMERIC(31) AS AUDIT_USER_ID_CREA
,AUDIT_USER_CREA_DTM::TIMESTAMP AS AUDIT_USER_CREA_DTM
,AUDIT_USER_ID_UPDT::NUMERIC(31) AS AUDIT_USER_ID_UPDT
,AUDIT_USER_UPDT_DTM::TIMESTAMP AS AUDIT_USER_UPDT_DTM
,VOID_IND
,CPCT_CLM_PRFL_CTG_TYP_CD
,CPCT_VOID_IND
,PS_PRFL_STMT_ID::NUMERIC(31) AS PS_PRFL_STMT_ID
,PS_PRFL_STMT_VOID_IND
,PSVT_PRFL_SEL_VAL_TYP_CD
,PSVT_PRFL_SEL_VAL_TYP_VOID_IND
 FROM CP)

SELECT * FROM ETL