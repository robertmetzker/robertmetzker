----SRC LAYER----
WITH
SRC_IL as ( SELECT *     from      STAGING.STG_INVOICE_LINE ),
SRC_IH as ( SELECT *     from      STAGING.STG_INVOICE_HEADER ),
SRC_REF1 as ( SELECT *     from      STAGING.STG_CAM_REF ),
SRC_REF2 as ( SELECT *     from      STAGING.STG_CAM_REF ),
SRC_REF3 as ( SELECT *     from      STAGING.STG_CAM_REF ),
SRC_REF4 as ( SELECT *     from      STAGING.STG_CAM_REF )

----LOGIC LAYER----
,
LOGIC_IL as ( SELECT 
		INVOICE_HEADER_ID AS INVOICE_HEADER_ID ,
        MOD1_MODIFIER_CODE,
        MOD2_MODIFIER_CODE,
        MOD3_MODIFIER_CODE,
        MOD4_MODIFIER_CODE
				from SRC_IL
            ),
LOGIC_IH as ( SELECT 
		INVOICE_HEADER_ID AS INVOICE_HEADER_ID,
		MOD_SET AS MOD_SET 
				from SRC_IH
            ),
LOGIC_REF1 as ( SELECT 
		REF_DGN_DESC AS REF_DGN_DESC,
		REF_IDN AS REF_IDN,
		REF_DSC AS REF_DSC,
		REF_EFF_DTE AS REF_EFF_DTE,
		REF_EXP_DTE AS REF_EXP_DTE,
		REF_DGN AS REF_DGN,
        REF_RID as REF_RID 
				from SRC_REF1
            ),
LOGIC_REF2 as ( SELECT 
		REF_DGN_DESC AS REF_DGN_DESC,
		REF_IDN AS REF_IDN,
		REF_DSC AS REF_DSC,
		REF_EFF_DTE AS REF_EFF_DTE,
		REF_EXP_DTE AS REF_EXP_DTE,
		REF_DGN AS REF_DGN,
        REF_RID as REF_RID 
				from SRC_REF2
            ),
LOGIC_REF3 as ( SELECT 
		REF_DGN_DESC AS REF_DGN_DESC,
		REF_IDN AS REF_IDN,
		REF_DSC AS REF_DSC,
		REF_EFF_DTE AS REF_EFF_DTE,
		REF_EXP_DTE AS REF_EXP_DTE,
		REF_DGN AS REF_DGN,
        REF_RID as REF_RID 
				from SRC_REF3
            ),
LOGIC_REF4 as ( SELECT 
		REF_DGN_DESC AS REF_DGN_DESC,
		REF_IDN AS REF_IDN,
		REF_DSC AS REF_DSC,
		REF_EFF_DTE AS REF_EFF_DTE,
		REF_EXP_DTE AS REF_EXP_DTE,
		REF_DGN AS REF_DGN,
        REF_RID as REF_RID 
				from SRC_REF4
            )

----RENAME LAYER ----
,
RENAME_IL as ( SELECT 
			
			INVOICE_HEADER_ID AS LINE_INVOICE_HEADER_ID, 
            MOD1_MODIFIER_CODE AS MOD1_MODIFIER_CODE,
            MOD2_MODIFIER_CODE AS MOD2_MODIFIER_CODE,
            MOD3_MODIFIER_CODE AS MOD3_MODIFIER_CODE,
            MOD4_MODIFIER_CODE AS MOD4_MODIFIER_CODE

			from      LOGIC_IL
        ),
RENAME_IH as ( SELECT INVOICE_HEADER_ID AS INVOICE_HEADER_ID,MOD_SET AS MOD_SET 
			from      LOGIC_IH
        ),
RENAME_REF1 as ( SELECT 
			
			REF_DGN_DESC AS REF1_DGN_DESC,
			
			REF_IDN AS REF1_IDN,
			
			REF_DSC AS REF1_DSC,
			
			REF_EFF_DTE AS REF1_EFF_DTE,
			
			REF_EXP_DTE AS REF1_EXP_DTE,
			
			REF_DGN AS REF1_DGN ,
            REF_RID as REF1_RID
			from      LOGIC_REF1
        ),
		RENAME_REF2 as ( SELECT 
			
			REF_DGN_DESC AS REF2_DGN_DESC,
			
			REF_IDN AS REF2_IDN,
			
			REF_DSC AS REF2_DSC,
			
			REF_EFF_DTE AS REF2_EFF_DTE,
			
			REF_EXP_DTE AS REF2_EXP_DTE,
			
			REF_DGN AS REF2_DGN ,
            REF_RID as REF2_RID
			from      LOGIC_REF2
        ),
		RENAME_REF3 as ( SELECT 
			
			REF_DGN_DESC AS REF3_DGN_DESC,
			
			REF_IDN AS REF3_IDN,
			
			REF_DSC AS REF3_DSC,
			
			REF_EFF_DTE AS REF3_EFF_DTE,
			
			REF_EXP_DTE AS REF3_EXP_DTE,
			
			REF_DGN AS REF3_DGN ,
            REF_RID as REF3_RID
			from      LOGIC_REF3
        ),
		RENAME_REF4 as ( SELECT 
			
			REF_DGN_DESC AS REF4_DGN_DESC,
			
			REF_IDN AS REF4_IDN,
			
			REF_DSC AS REF4_DSC,
			
			REF_EFF_DTE AS REF4_EFF_DTE,
			
			REF_EXP_DTE AS REF4_EXP_DTE,
			
			REF_DGN AS REF4_DGN ,
            REF_RID as REF4_RID
			from      LOGIC_REF4
        ),

----FILTER LAYER(uses aliases)----


        FILTER_IL as ( SELECT  * 
			from     RENAME_IL 
            
        ),

        FILTER_IH as ( SELECT  * 
			from     RENAME_IH 
            
        ),
         FILTER_REF1 as ( select REF1_DGN , REF1_IDN , REF1_DSC , REF1_DGN_DESC  from (SELECT  ROW_NUMBER() OVER (PARTITION BY REF1_DGN,REF1_IDN ORDER BY REF1_EXP_DTE DESC, REF1_RID DESC) ROWN1,*
			from     RENAME_REF1 
            WHERE REF1_DGN IN ('OMD', 'MOD', 'TMD', 'BMD')) A WHERE ROWN1=1
        ),
		FILTER_REF2 as ( select REF2_DGN , REF2_IDN , REF2_DSC , REF2_DGN_DESC  from (SELECT  ROW_NUMBER() OVER (PARTITION BY REF2_DGN,REF2_IDN ORDER BY REF2_EXP_DTE DESC, REF2_RID DESC) ROWN1,*
			from     RENAME_REF2 
            WHERE REF2_DGN IN ('OMD', 'MOD', 'TMD', 'BMD')) A WHERE ROWN1=1
        ),
		FILTER_REF3 as ( select REF3_DGN , REF3_IDN , REF3_DSC , REF3_DGN_DESC  from (SELECT  ROW_NUMBER() OVER (PARTITION BY REF3_DGN,REF3_IDN ORDER BY REF3_EXP_DTE DESC, REF3_RID DESC) ROWN1,*
			from     RENAME_REF3 
            WHERE REF3_DGN IN ('OMD', 'MOD', 'TMD', 'BMD')) A WHERE ROWN1=1
        ),
		FILTER_REF4 as ( select REF4_DGN , REF4_IDN , REF4_DSC , REF4_DGN_DESC  from (SELECT  ROW_NUMBER() OVER (PARTITION BY REF4_DGN,REF4_IDN ORDER BY REF4_EXP_DTE DESC, REF4_RID DESC) ROWN1,*
			from     RENAME_REF4 
            WHERE REF4_DGN IN ('OMD', 'MOD', 'TMD', 'BMD')) A WHERE ROWN1=1
        ),

                
----JOIN LAYER----

IL as ( SELECT   *
			from  FILTER_IL
				INNER JOIN FILTER_IH on FILTER_IH.INVOICE_HEADER_ID = FILTER_IL.LINE_INVOICE_HEADER_ID
				LEFT JOIN FILTER_REF1 REF1 ON FILTER_IL.MOD1_MODIFIER_CODE = REF1.REF1_IDN AND (coalesce(FILTER_IH.MOD_SET,'BMD')=REF1.REF1_DGN)
				LEFT JOIN FILTER_REF2 REF2 ON FILTER_IL.MOD2_MODIFIER_CODE = REF2.REF2_IDN AND (coalesce(FILTER_IH.MOD_SET,'BMD')=REF2.REF2_DGN)
				LEFT JOIN FILTER_REF3 REF3 ON FILTER_IL.MOD3_MODIFIER_CODE = REF3.REF3_IDN AND (coalesce(FILTER_IH.MOD_SET,'BMD')=REF3.REF3_DGN)
				LEFT JOIN FILTER_REF4 REF4 ON FILTER_IL.MOD4_MODIFIER_CODE = REF4.REF4_IDN AND (coalesce(FILTER_IH.MOD_SET,'BMD')=REF4.REF4_DGN)
								),
-------------ETL LAYER ----------------
ETL AS (SELECT MOD_SET,REF1_DGN_DESC AS REF_DGN_DESC ,MOD1_MODIFIER_CODE as MOD_CODE_1 ,REF1_DSC AS MOD_DESC_1 ,MOD2_MODIFIER_CODE AS MOD_CODE_2,REF2_DSC AS MOD_DESC_2,MOD3_MODIFIER_CODE AS MOD_CODE_3,REF3_DSC AS MOD_DESC_3,
			MOD4_MODIFIER_CODE AS MOD_CODE_4,REF4_DSC AS MOD_DESC_4 FROM IL
			group by MOD_SET,REF1_DGN_DESC,MOD1_MODIFIER_CODE,REF1_DSC,MOD2_MODIFIER_CODE,REF2_DSC,MOD3_MODIFIER_CODE,REF3_DSC,MOD4_MODIFIER_CODE,REF4_DSC ),
ETL1 AS (SELECT md5(cast(
    
    coalesce(cast(MOD_SET as 
    varchar
), '') || '-' || coalesce(cast(MOD_CODE_1 as 
    varchar
), '') || '-' || coalesce(cast(MOD_CODE_2 as 
    varchar
), '') || '-' || coalesce(cast(MOD_CODE_3 as 
    varchar
), '') || '-' || coalesce(cast(MOD_CODE_4 as 
    varchar
), '')

 as 
    varchar
)) as UNIQUE_ID_KEY,*   FROM ETL)
SELECT * FROM ETL1