----SRC LAYER----
WITH
SRC_ICDP as ( SELECT *     from      DEV_VIEWS.DBDWQP00.THFICDP ),
SRC_ICSC as ( SELECT *     from      DEV_VIEWS.DBDWQP00.TCDICSC )
//SRC_ICDP as ( SELECT *     from      THFICDP),
//SRC_ICSC as ( SELECT *     from      TCDICSC)
----LOGIC LAYER----
,
LOGIC_ICDP as ( SELECT 
		NULLIF(TRIM(ICDC_CODE), '') AS ICDC_CODE,
		TRIM(ICDV_CODE) AS ICDV_CODE,
		cast(ICDP_VRSN_BGN_DATE as DATE) AS ICDP_VRSN_BGN_DATE,
		ICDP_VRSN_BGN_TMS::timestamp AS ICDP_VRSN_BGN_TMS,
		cast(ICDP_VRSN_END_DATE as DATE) AS ICDP_VRSN_END_DATE,
		ICDP_VRSN_END_TMS::timestamp AS ICDP_VRSN_END_TMS,
		UPPER(TRIM(ICD_CMS_PRHBT_FLAG)) AS ICD_CMS_PRHBT_FLAG,
		cast(ICDP_EFCTV_DATE as DATE) AS ICDP_EFCTV_DATE,
		cast(ICDP_ENDNG_DATE as DATE) AS ICDP_ENDNG_DATE,
		UPPER(TRIM(ICDP_CRNT_FLAG)) AS ICDP_CRNT_FLAG,
		UPPER(TRIM(ICDP_CRNT_MAX_FLAG)) AS ICDP_CRNT_MAX_FLAG,
		UPPER(TRIM(ICDP_FTR_FLAG)) AS ICDP_FTR_FLAG,
		TRIM(CRT_USER_ID) AS CRT_USER_ID,
		NULLIF(TRIM(DCTVT_USER_ID), '') AS DCTVT_USER_ID,
		UPPER(TRIM(ATHR_CLM_USE_FLAG)) AS ATHR_CLM_USE_FLAG,
		UPPER(TRIM(ATHR_BLNG_USE_FLAG)) AS ATHR_BLNG_USE_FLAG,
		UPPER(TRIM(ENCDR_VLDTN_FLAG)) AS ENCDR_VLDTN_FLAG,
		UPPER(TRIM(GNDR_DGAT_CODE)) AS GNDR_DGAT_CODE,
		UPPER(TRIM(GNDR_DGAT_TYPE)) AS GNDR_DGAT_TYPE,
		UPPER(TRIM(PRIOR_ATHR_FLAG)) AS PRIOR_ATHR_FLAG,
		UPPER(TRIM(CTSTR_ICD_FLAG)) AS CTSTR_ICD_FLAG,
		UPPER(TRIM(PSYCH_ICD_FLAG)) AS PSYCH_ICD_FLAG,
		UPPER(TRIM(ICD_PRVCY_FLAG)) AS ICD_PRVCY_FLAG,
		UPPER(TRIM(BODY_SITE_FLAG)) AS BODY_SITE_FLAG,
		UPPER(TRIM(BODY_LCTN_FLAG)) AS BODY_LCTN_FLAG,
		UPPER(TRIM(SBRGN_RVW_FLAG)) AS SBRGN_RVW_FLAG 
				from SRC_ICDP
            ),
LOGIC_ICSC as ( SELECT 
		UPPER(COALESCE(TRIM(CRNT_PSC_FLAG),'N')) AS CRNT_PSC_FLAG,
		cast(PSC_BGNG_DATE as DATE) AS PSC_BGNG_DATE,
		cast(PSC_ENDNG_DATE as DATE) AS PSC_ENDNG_DATE,
		TRIM(ICD_CODE) AS ICD_CODE,
		TRIM(ICDV_CODE) AS ICDV_CODE 
				from SRC_ICSC
            )
----RENAME LAYER ----
,
RENAME_ICDP as ( SELECT ICDC_CODE AS ICDC_CODE,ICDV_CODE AS ICDV_CODE,ICDP_VRSN_BGN_DATE AS ICDP_VRSN_BGN_DATE,ICDP_VRSN_BGN_TMS AS ICDP_VRSN_BGN_TMS
,ICDP_VRSN_END_DATE AS ICDP_VRSN_END_DATE,ICDP_VRSN_END_TMS AS ICDP_VRSN_END_TMS,ICD_CMS_PRHBT_FLAG AS ICD_CMS_PRHBT_FLAG,ICDP_EFCTV_DATE AS ICDP_EFCTV_DATE
,ICDP_ENDNG_DATE AS ICDP_ENDNG_DATE,ICDP_CRNT_FLAG AS ICDP_CRNT_FLAG,ICDP_CRNT_MAX_FLAG AS ICDP_CRNT_MAX_FLAG,ICDP_FTR_FLAG AS ICDP_FTR_FLAG,CRT_USER_ID AS CRT_USER_ID
,DCTVT_USER_ID AS DCTVT_USER_ID,ATHR_CLM_USE_FLAG AS ATHR_CLM_USE_FLAG,ATHR_BLNG_USE_FLAG AS ATHR_BLNG_USE_FLAG,ENCDR_VLDTN_FLAG AS ENCDR_VLDTN_FLAG
,GNDR_DGAT_CODE AS GNDR_DGAT_CODE,GNDR_DGAT_TYPE AS GNDR_DGAT_TYPE,PRIOR_ATHR_FLAG AS PRIOR_ATHR_FLAG,CTSTR_ICD_FLAG AS CTSTR_ICD_FLAG,PSYCH_ICD_FLAG AS PSYCH_ICD_FLAG
,ICD_PRVCY_FLAG AS ICD_PRVCY_FLAG,BODY_SITE_FLAG AS BODY_SITE_FLAG,BODY_LCTN_FLAG AS BODY_LCTN_FLAG,SBRGN_RVW_FLAG AS SBRGN_RVW_FLAG 
			from      LOGIC_ICDP
        ),
RENAME_ICSC as ( SELECT CRNT_PSC_FLAG AS CRNT_PSC_FLAG,PSC_BGNG_DATE AS PSC_BGNG_DATE,PSC_ENDNG_DATE AS PSC_ENDNG_DATE,
			
			ICD_CODE AS ICSC_ICD_CODE,
			
			ICDV_CODE AS ICSC_ICDV_CODE 
			from      LOGIC_ICSC
        )
----FILTER LAYER(uses aliases)----
,

        FILTER_ICDP as ( SELECT  * 
			from     RENAME_ICDP 
            
        ),

        FILTER_ICSC as ( SELECT  * 
			from     RENAME_ICSC 
            WHERE PSC_ENDNG_DATE > CURRENT_DATE
        )
----JOIN LAYER----
,
ICDP as ( SELECT * 
			from  FILTER_ICDP
				LEFT JOIN FILTER_ICSC ON FILTER_ICDP.ICDC_CODE = FILTER_ICSC.ICSC_ICD_CODE AND FILTER_ICDP.ICDV_CODE = FILTER_ICSC.ICSC_ICDV_CODE
  )
select * from ICDP