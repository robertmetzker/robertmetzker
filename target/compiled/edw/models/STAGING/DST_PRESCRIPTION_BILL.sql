----SRC LAYER----
WITH
SRC_IP as ( SELECT *     from      STAGING.DST_INVOICE_PRESCRIPTION ),
SRC_LOS as ( SELECT *     from      STAGING.STG_CAM_REF ),
SRC_DAW as ( SELECT *     from      STAGING.STG_CAM_REF ),
SRC_PCL as ( SELECT *     from      STAGING.STG_CAM_REF )
//SRC_IP as ( SELECT *     from      DST_INVOICE_PRESCRIPTION),
//SRC_LOS as ( SELECT *     from      STG_CAM_REF),
//SRC_DAW as ( SELECT *     from      STG_CAM_REF),
//SRC_PCL as ( SELECT *     from      STG_CAM_REF)
----LOGIC LAYER----
,
LOGIC_IP as ( SELECT 
		
		TRIM(SERVICE_LEVEL) AS SERVICE_LEVEL,
		TRIM(PROF_SERVICE) AS PROF_SERVICE,
		TRIM(REASON_SERVICE) AS REASON_SERVICE,
		TRIM(RESULT_SERVICE) AS RESULT_SERVICE,
		TRIM(GENERIC_DRUG_IND) AS GENERIC_DRUG_IND,
		TRIM(CLARIFICATION) AS CLARIFICATION,
		TRIM(PLAN_CODE) AS PLAN_CODE,
		CASE WHEN ORIGINATION_FLAG = '3' THEN '3 - BATCH'
             WHEN ORIGINATION_FLAG = '1' THEN '1 - ONLINE'
             WHEN ORIGINATION_FLAG = 'T' THEN 'T - ELECTRONIC TRANSACTION'
             ELSE  ORIGINATION_FLAG END  AS ORIGINATION_FLAG,
        TRIM(SPECIAL_PROGRAM) AS SPECIAL_PROGRAM,
        TRIM(PROVIDER_LOCK) AS PROVIDER_LOCK,
         REFILL_IND,
        NULL::VARCHAR() AS  PHARMACIST_SERVICE_DESC ,
        NULL::VARCHAR() AS SERVICE_REASON_DESC,
        NULL::VARCHAR() AS SERVICE_RESULT_DESC 

				from SRC_IP
            ),
LOGIC_LOS as ( SELECT 
		REF_IDN AS REF_IDN,
		REF_DGN AS REF_DGN,
		REF_DSC AS REF_DSC 
				from SRC_LOS
            ),
LOGIC_DAW as ( SELECT 
		REF_IDN AS REF_IDN,
		REF_DGN AS REF_DGN,
		REF_DSC AS REF_DSC 
				from SRC_DAW
            ),
LOGIC_PCL as ( SELECT 
		REF_IDN AS REF_IDN,
		REF_DGN AS REF_DGN,
		REF_DSC AS REF_DSC 
				from SRC_PCL
            )
----RENAME LAYER ----
,
RENAME_IP as ( SELECT 
			
			SERVICE_LEVEL AS SERVICE_LEVEL,PROF_SERVICE AS PROF_SERVICE,REASON_SERVICE AS REASON_SERVICE,RESULT_SERVICE AS RESULT_SERVICE,GENERIC_DRUG_IND AS GENERIC_DRUG_IND,CLARIFICATION AS CLARIFICATION,PLAN_CODE AS PLAN_CODE,ORIGINATION_FLAG AS ORIGINATION_FLAG,SPECIAL_PROGRAM AS SPECIAL_PROGRAM,PROVIDER_LOCK AS PROVIDER_LOCK,REFILL_IND AS REFILL_IND,
			
			PHARMACIST_SERVICE_DESC AS PHARMACIST_SERVICE_DESC,
			
			SERVICE_REASON_DESC AS SERVICE_REASON_DESC,
			
			SERVICE_RESULT_DESC AS SERVICE_RESULT_DESC 
			from      LOGIC_IP
        ),
RENAME_LOS as ( SELECT 
			
			REF_IDN AS LOS_REF_IDN,
			
			REF_DGN AS LOS_REF_DGN,
			
			REF_DSC AS LOS_REF_DSC 
			from      LOGIC_LOS
        ),
RENAME_DAW as ( SELECT 
			
			REF_IDN AS DAW_REF_IDN,
			
			REF_DGN AS DAW_REF_DGN,
			
			REF_DSC AS DAW_REF_DSC 
			from      LOGIC_DAW
        ),
RENAME_PCL as ( SELECT 
			
			REF_IDN AS PCL_REF_IDN,
			
			REF_DGN AS PCL_REF_DGN,
			
			REF_DSC AS PCL_REF_DSC 
			from      LOGIC_PCL
        )
----FILTER LAYER(uses aliases)----
,

        FILTER_IP as ( SELECT  * 
			from     RENAME_IP 
            
        ),

        FILTER_LOS as ( SELECT  * 
			from     RENAME_LOS 
            WHERE LOS_REF_DGN = 'LOS'
        ),

        FILTER_DAW as ( SELECT  * 
			from     RENAME_DAW 
            WHERE DAW_REF_DGN = 'DAW'
        ),

        FILTER_PCL as ( SELECT  * 
			from     RENAME_PCL 
            WHERE PCL_REF_DGN = 'PCL'
        )
----JOIN LAYER----
,
IP as ( SELECT * 
			from  FILTER_IP
				LEFT JOIN FILTER_LOS ON FILTER_IP.SERVICE_LEVEL = FILTER_LOS.LOS_REF_IDN 
				LEFT JOIN FILTER_DAW ON FILTER_IP.SERVICE_LEVEL = FILTER_DAW.DAW_REF_IDN 
				LEFT JOIN FILTER_PCL ON FILTER_IP.SERVICE_LEVEL = FILTER_PCL.PCL_REF_IDN  ),
ETL AS ( SELECT distinct md5(cast(
    
    coalesce(cast(SERVICE_LEVEL as 
    varchar
), '') || '-' || coalesce(cast(PROF_SERVICE as 
    varchar
), '') || '-' || coalesce(cast(REASON_SERVICE as 
    varchar
), '') || '-' || coalesce(cast(RESULT_SERVICE as 
    varchar
), '') || '-' || coalesce(cast(GENERIC_DRUG_IND as 
    varchar
), '') || '-' || coalesce(cast(CLARIFICATION as 
    varchar
), '') || '-' || coalesce(cast(PLAN_CODE as 
    varchar
), '') || '-' || coalesce(cast(ORIGINATION_FLAG as 
    varchar
), '') || '-' || coalesce(cast(SPECIAL_PROGRAM as 
    varchar
), '') || '-' || coalesce(cast(PROVIDER_LOCK as 
    varchar
), '') || '-' || coalesce(cast(REFILL_IND as 
    varchar
), '')

 as 
    varchar
)) as UNIQUE_ID_KEY,SERVICE_LEVEL
,PROF_SERVICE
,REASON_SERVICE
,RESULT_SERVICE
,GENERIC_DRUG_IND
,CLARIFICATION
,PLAN_CODE
,ORIGINATION_FLAG
,SPECIAL_PROGRAM
,PROVIDER_LOCK
,REFILL_IND
,PHARMACIST_SERVICE_DESC
,SERVICE_REASON_DESC
,SERVICE_RESULT_DESC
,LOS_REF_IDN
,LOS_REF_DGN
,LOS_REF_DSC
,DAW_REF_IDN
,DAW_REF_DGN
,DAW_REF_DSC
,PCL_REF_IDN
,PCL_REF_DGN
,PCL_REF_DSC
 FROM IP
)
select * from ETL