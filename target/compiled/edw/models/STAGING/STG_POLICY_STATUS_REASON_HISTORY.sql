----SRC LAYER----
WITH
SRC_PP1 as ( SELECT *     from      DEV_VIEWS.PCMP.POLICY_PERIOD ),
SRC_CEST1 as ( SELECT *     from      DEV_VIEWS.PCMP.CONTROL_ELEMENT_SUB_TYPE ),
SRC_PS1 as ( SELECT *     from      DEV_VIEWS.PCMP.POLICY_STATUS ),
SRC_PSR1 as ( SELECT *     from      DEV_VIEWS.PCMP.POLICY_STATUS_REASON ),
SRC_PSH1 as ( SELECT *     from      DEV_VIEWS.PCMP.BWC_POLICY_STATUS ),
SRC_PST1 as ( SELECT *     from      DEV_VIEWS.PCMP.POLICY_STATUS_TYPE ),
SRC_PSRT1 as ( SELECT *     from      DEV_VIEWS.PCMP.POLICY_STATUS_REASON_TYPE ),
SRC_CMT1 as ( SELECT *     from      DEV_VIEWS.PCMP.CANCELLATION_METHOD_TYPE ),
SRC_PYOFF1 as ( SELECT *     from      DEV_VIEWS.PCMP.BWC_PAYOFF_OPTION_TYPE ),
SRC_AG1 as ( SELECT *     from      DEV_VIEWS.PCMP.AGREEMENT ),
SRC_PCE1 as ( SELECT *     from      DEV_VIEWS.PCMP.POLICY_CONTROL_ELEMENT ),
-- HIST LAYER
SRC_PP as ( SELECT *     from      DEV_VIEWS.PCMP.POLICY_PERIOD ),
SRC_CEST as ( SELECT *     from      DEV_VIEWS.PCMP.CONTROL_ELEMENT_SUB_TYPE ),
SRC_PS as ( SELECT *     from      DEV_VIEWS.PCMP.POLICY_STATUS_HISTORY ),
SRC_PSR as ( SELECT *     from      DEV_VIEWS.PCMP.POLICY_STATUS_REASON_HISTORY ),
SRC_PSH as ( SELECT *     from      DEV_VIEWS.PCMP.BWC_POLICY_STATUS_HIST ),
SRC_PST as ( SELECT *     from      DEV_VIEWS.PCMP.POLICY_STATUS_TYPE ),
SRC_PSRT as ( SELECT *     from      DEV_VIEWS.PCMP.POLICY_STATUS_REASON_TYPE ),
SRC_CMT as ( SELECT *     from      DEV_VIEWS.PCMP.CANCELLATION_METHOD_TYPE ),
SRC_PYOFF as ( SELECT *     from      DEV_VIEWS.PCMP.BWC_PAYOFF_OPTION_TYPE ),
SRC_AG as ( SELECT *     from      DEV_VIEWS.PCMP.AGREEMENT ),
SRC_PCE as ( SELECT *     from      DEV_VIEWS.PCMP.POLICY_CONTROL_ELEMENT )
----LOGIC LAYER----
,
LOGIC_PP1 as ( SELECT 
		PLCY_PRD_ID AS PLCY_PRD_ID,
		PLCY_NO AS PLCY_NO,
		AGRE_ID AS AGRE_ID,
		cast(PLCY_PRD_EFF_DT as DATE) AS PLCY_PRD_EFF_DT,
		cast(PLCY_PRD_END_DT as DATE) AS PLCY_PRD_END_DT,
		UPPER(VOID_IND) AS VOID_IND 
				from SRC_PP1
            ),
LOGIC_CEST1 as ( SELECT 
		UPPER(CTL_ELEM_SUB_TYP_CD) AS CTL_ELEM_SUB_TYP_CD,
		UPPER(CTL_ELEM_SUB_TYP_NM) AS CTL_ELEM_SUB_TYP_NM,
		UPPER(CTL_ELEM_SUB_TYP_VOID_IND) AS CTL_ELEM_SUB_TYP_VOID_IND,
		CTL_ELEM_SUB_TYP_ID AS CTL_ELEM_SUB_TYP_ID 
				from SRC_CEST1
            ),
LOGIC_PS1 as ( SELECT 
		cast(PLCY_STS_EFF_DT as DATE) AS PLCY_STS_TRANS_DT,
		UPPER(PLCY_STS_TYP_CD) AS PLCY_STS_TYP_CD,
		UPPER(CANC_METH_TYP_CD) AS CANC_METH_TYP_CD,
		cast(PLCY_STS_CANC_DT as DATE) AS PLCY_STS_CANC_DT,
		UPPER(CANC_CMT) AS CANC_CMT,
		PLCY_STS_EFF_DT AS PLCY_STS_EFF_DT,
		PLCY_STS_END_DT AS PLCY_STS_END_DT,
		AUTH_ID AS AUTH_ID,
		AUDIT_USER_ID_CREA AS AUDIT_USER_ID_CREA,
		AUDIT_USER_CREA_DTM AS AUDIT_USER_CREA_DTM,
		AUDIT_USER_ID_UPDT AS AUDIT_USER_ID_UPDT,
		AUDIT_USER_UPDT_DTM AS AUDIT_USER_UPDT_DTM,
		PLCY_STS_ID AS PLCY_STS_ID,
		PLCY_PRD_ID AS PLCY_PRD_ID,
		UPPER(VOID_IND) AS VOID_IND 
				from SRC_PS1
            ),
LOGIC_PSR1 as ( SELECT 
		cast(PLCY_STS_RSN_EFF_DT as DATE) AS PLCY_STS_RSN_TRANS_DT,
		cast(PLCY_STS_RSN_TRAN_DUE_DT as DATE) AS PLCY_STS_RSN_TRAN_DUE_DT,
		UPPER(PLCY_STS_RSN_TYP_CD) AS PLCY_STS_RSN_TYP_CD,
		PLCY_STS_RSN_EFF_DT AS PLCY_STS_RSN_EFF_DT,
		PLCY_STS_RSN_END_DT AS PLCY_STS_RSN_END_DT,
		PFT_ID AS PFT_ID,
		PYRL_RPT_ID AS PYRL_RPT_ID,
		AUDIT_USER_ID_CREA AS AUDIT_USER_ID_CREA,
		AUDIT_USER_CREA_DTM AS AUDIT_USER_CREA_DTM,
		AUDIT_USER_ID_UPDT AS AUDIT_USER_ID_UPDT,
		AUDIT_USER_UPDT_DTM AS AUDIT_USER_UPDT_DTM,
		PLCY_STS_ID AS PLCY_STS_ID,
		UPPER(VOID_IND) AS VOID_IND 
				from SRC_PSR1
            ),
LOGIC_PSH1 as ( SELECT 
		cast(PLCY_STS_RSN_CHG_EFF_DT as DATE) AS PLCY_STS_RSN_CHG_EFF_DT,
		UPPER(PAYOFF_OPT_TYP_CD) AS PAYOFF_OPT_TYP_CD,
		PLCY_STS_ID AS PLCY_STS_ID 
				from SRC_PSH1
            ),
LOGIC_PST1 as ( SELECT 
		UPPER(PLCY_STS_TYP_NM) AS PLCY_STS_TYP_NM,
		UPPER(PLCY_STS_TYP_CD) AS PLCY_STS_TYP_CD,
		UPPER(PLCY_STS_TYP_VOID_IND) AS PLCY_STS_TYP_VOID_IND 
				from SRC_PST1
            ),
LOGIC_PSRT1 as ( SELECT 
		UPPER(PLCY_STS_RSN_TYP_NM) AS PLCY_STS_RSN_TYP_NM,
		UPPER(PLCY_STS_RSN_TYP_CD) AS PLCY_STS_RSN_TYP_CD,
		UPPER(PLCY_STS_RSN_TYP_VOID_IND) AS PLCY_STS_RSN_TYP_VOID_IND 
				from SRC_PSRT1
            ),
LOGIC_CMT1 as ( SELECT 
		UPPER(CANC_METH_TYP_NM) AS CANC_METH_TYP_NM,
		UPPER(CANC_METH_TYP_CD) AS CANC_METH_TYP_CD,
		UPPER(VOID_IND) AS VOID_IND 
				from SRC_CMT1
            ),
LOGIC_PYOFF1 as ( SELECT 
		UPPER(PAYOFF_OPT_TYP_NM) AS PAYOFF_OPT_TYP_NM,
		UPPER(PAYOFF_OPT_TYP_DFLT) AS PAYOFF_OPT_TYP_DFLT,
		UPPER(PAYOFF_OPT_TYP_CD) AS PAYOFF_OPT_TYP_CD,
		UPPER(VOID_IND) AS VOID_IND 
				from SRC_PYOFF1
            ),
LOGIC_AG1 as ( SELECT 
		AGRE_ID AS AGRE_ID,
		UPPER(AGRE_TYP_CD ) AS AGRE_TYP_CD  
				from SRC_AG1
            ),
LOGIC_PCE1 as ( SELECT 
		CTL_ELEM_SUB_TYP_ID AS CTL_ELEM_SUB_TYP_ID,
		PLCY_PRD_ID AS PLCY_PRD_ID,
		UPPER(CTL_ELEM_TYP_CD) AS CTL_ELEM_TYP_CD,
		UPPER(VOID_IND ) AS VOID_IND  
				from SRC_PCE1
            )

-- HIST LOGIC LAYER ----
,
LOGIC_PP as ( SELECT 
		PLCY_PRD_ID AS PLCY_PRD_ID,
		PLCY_NO AS PLCY_NO,
		AGRE_ID AS AGRE_ID,
		cast(PLCY_PRD_EFF_DT as DATE) AS PLCY_PRD_EFF_DT,
		cast(PLCY_PRD_END_DT as DATE) AS PLCY_PRD_END_DT,
		UPPER(VOID_IND) AS VOID_IND 
				from SRC_PP
            ),
LOGIC_CEST as ( SELECT 
		UPPER(CTL_ELEM_SUB_TYP_CD) AS CTL_ELEM_SUB_TYP_CD,
		UPPER(CTL_ELEM_SUB_TYP_NM) AS CTL_ELEM_SUB_TYP_NM,
		UPPER(CTL_ELEM_SUB_TYP_VOID_IND) AS CTL_ELEM_SUB_TYP_VOID_IND,
		CTL_ELEM_SUB_TYP_ID AS CTL_ELEM_SUB_TYP_ID 
				from SRC_CEST
            ),
LOGIC_PS as ( SELECT 
		HIST_ID  AS HIST_ID,
		PLCY_STS_ID  as PLCY_STS_ID,
		cast(PLCY_STS_EFF_DT as DATE) AS PLCY_STS_EFF_DT,
		UPPER(PLCY_STS_TYP_CD) AS PLCY_STS_TYP_CD,
		UPPER(CANC_METH_TYP_CD) AS CANC_METH_TYP_CD,
		cast(PLCY_STS_CANC_DT as DATE) AS PLCY_STS_CANC_DT,
		UPPER(CANC_CMT) AS CANC_CMT,
		HIST_EFF_DTM AS HIST_EFF_DTM,
		HIST_END_DTM AS HIST_END_DTM,
		AUTH_ID AS AUTH_ID,
		AUDIT_USER_ID_CREA AS AUDIT_USER_ID_CREA,
		AUDIT_USER_CREA_DTM AS AUDIT_USER_CREA_DTM,
		AUDIT_USER_ID_UPDT AS AUDIT_USER_ID_UPDT,
		AUDIT_USER_UPDT_DTM AS AUDIT_USER_UPDT_DTM,
		UPPER(VOID_IND) AS VOID_IND,
		PLCY_PRD_ID AS PLCY_PRD_ID 
				from SRC_PS
            ),
LOGIC_PSR as ( SELECT 
		cast(PLCY_STS_RSN_EFF_DT as DATE) AS PLCY_STS_RSN_EFF_DT,
		cast(PLCY_STS_RSN_TRAN_DUE_DT as DATE) AS PLCY_STS_RSN_TRAN_DUE_DT,
		UPPER(PLCY_STS_RSN_TYP_CD) AS PLCY_STS_RSN_TYP_CD,
		HIST_EFF_DTM AS HIST_EFF_DTM,
		HIST_END_DTM AS HIST_END_DTM,
		PFT_ID AS PFT_ID,
		PYRL_RPT_ID AS PYRL_RPT_ID,
		AUDIT_USER_ID_CREA AS AUDIT_USER_ID_CREA,
		AUDIT_USER_CREA_DTM AS AUDIT_USER_CREA_DTM,
		AUDIT_USER_ID_UPDT AS AUDIT_USER_ID_UPDT,
		AUDIT_USER_UPDT_DTM AS AUDIT_USER_UPDT_DTM,
		UPPER(VOID_IND) AS VOID_IND,
		PLCY_STS_ID AS PLCY_STS_ID ,
		ROW_NUMBER() OVER (PARTITION BY PLCY_STS_ID ORDER BY HIST_EFF_DTM) ROWN	

				from SRC_PSR
			
            ),
LOGIC_PSH as ( SELECT 
		cast(PLCY_STS_RSN_CHG_EFF_DT as DATE) AS PLCY_STS_RSN_CHG_EFF_DT,
		UPPER(PAYOFF_OPT_TYP_CD) AS PAYOFF_OPT_TYP_CD,
		HIST_ID AS HIST_ID 
				from SRC_PSH
            ),
LOGIC_PST as ( SELECT 
		UPPER(PLCY_STS_TYP_NM) AS PLCY_STS_TYP_NM,
		UPPER(PLCY_STS_TYP_VOID_IND) AS PLCY_STS_TYP_VOID_IND,
		UPPER(PLCY_STS_TYP_CD) AS PLCY_STS_TYP_CD 
				from SRC_PST
            ),
LOGIC_PSRT as ( SELECT 
		UPPER(PLCY_STS_RSN_TYP_NM) AS PLCY_STS_RSN_TYP_NM,
		UPPER(PLCY_STS_RSN_TYP_VOID_IND) AS PLCY_STS_RSN_TYP_VOID_IND,
		UPPER(PLCY_STS_RSN_TYP_CD) AS PLCY_STS_RSN_TYP_CD 
				from SRC_PSRT
            ),
LOGIC_CMT as ( SELECT 
		UPPER(CANC_METH_TYP_NM) AS CANC_METH_TYP_NM,
		UPPER(VOID_IND) AS VOID_IND,
		UPPER(CANC_METH_TYP_CD) AS CANC_METH_TYP_CD 
				from SRC_CMT
            ),
LOGIC_PYOFF as ( SELECT 
		UPPER(PAYOFF_OPT_TYP_NM) AS PAYOFF_OPT_TYP_NM,
		UPPER(PAYOFF_OPT_TYP_DFLT) AS PAYOFF_OPT_TYP_DFLT,
		UPPER(PAYOFF_OPT_TYP_CD) AS PAYOFF_OPT_TYP_CD,
		UPPER(VOID_IND) AS VOID_IND 
				from SRC_PYOFF
            ),
LOGIC_AG as ( SELECT AGRE_ID AS AG_AGRE_ID,
		UPPER(AGRE_TYP_CD) AS AGRE_TYP_CD 
				from SRC_AG
            ),
LOGIC_PCE as ( SELECT 
		CTL_ELEM_SUB_TYP_ID AS CTL_ELEM_SUB_TYP_ID,
		PLCY_PRD_ID AS PLCY_PRD_ID,
		UPPER(CTL_ELEM_TYP_CD) AS CTL_ELEM_TYP_CD,
		UPPER(VOID_IND ) AS VOID_IND  
				from SRC_PCE)
----RENAME LAYER ----
,
RENAME_PP1 as ( SELECT PLCY_PRD_ID AS PLCY_PRD_ID,PLCY_NO AS PLCY_NO,AGRE_ID AS AGRE_ID,
			
			PLCY_PRD_EFF_DT AS PLCY_PRD_EFF_DATE,
			
			PLCY_PRD_END_DT AS PLCY_PRD_END_DATE,
			
			AGRE_ID AS PP1_AGRE_ID,
			
			PLCY_PRD_ID AS PP1_PLCY_PRD_ID,
			
			VOID_IND AS PP1_VOID_IND 
			from      LOGIC_PP1
        ),
RENAME_CEST1 as ( SELECT 
			
			CTL_ELEM_SUB_TYP_CD AS PLCY_TYP_CODE,
			
			CTL_ELEM_SUB_TYP_NM AS PLCY_TYP_NAME,
			
			CTL_ELEM_SUB_TYP_VOID_IND AS CEST1_CTL_ELEM_SUB_TYP_VOID_IND,
			
			CTL_ELEM_SUB_TYP_ID AS CEST1_CTL_ELEM_SUB_TYP_ID 
			from      LOGIC_CEST1
        ),
RENAME_PS1 as ( SELECT 
			
			PLCY_STS_TRANS_DT AS PLCY_STS_TRANS_DT,PLCY_STS_TYP_CD AS PLCY_STS_TYP_CD,CANC_METH_TYP_CD AS CANC_METH_TYP_CD,
			
			PLCY_STS_CANC_DT AS PLCY_STS_CANC_DATE,CANC_CMT AS CANC_CMT,
			
			PLCY_STS_EFF_DT AS PSH_HIST_EFF_DTM,
			
			PLCY_STS_END_DT AS PSH_HIST_END_DTM,AUTH_ID AS AUTH_ID,
			
			AUDIT_USER_ID_CREA AS PSH_AUDIT_USER_ID_CREA,
			
			AUDIT_USER_CREA_DTM AS PSH_AUDIT_USER_CREA_DTM,
			
			AUDIT_USER_ID_UPDT AS PSH_AUDIT_USER_ID_UPDT,
			
			AUDIT_USER_UPDT_DTM AS PSH_AUDIT_USER_UPDT_DTM,
			
			-- PLCY_STS_ID AS PS1_PLCY_STS_ID,
			
			PLCY_STS_TYP_CD AS PS1_PLCY_STS_TYP_CD,
			
			CANC_METH_TYP_CD AS PS1_CANC_METH_TYP_CD,
			
			PLCY_STS_ID AS PS1_PLCY_STS_ID,
			
			PLCY_PRD_ID AS PS1_PLCY_PRD_ID,
			
			VOID_IND AS PS1_VOID_IND 
			from      LOGIC_PS1
        ),
RENAME_PSR1 as ( SELECT 
			
			PLCY_STS_RSN_TRANS_DT AS PLCY_STS_RSN_TRANS_DT,PLCY_STS_RSN_TRAN_DUE_DT AS PLCY_STS_RSN_TRAN_DUE_DT,PLCY_STS_RSN_TYP_CD AS PLCY_STS_RSN_TYP_CD,
			
			PLCY_STS_RSN_EFF_DT AS PSR_HIST_EFF_DTM,
			
			PLCY_STS_RSN_END_DT AS PSR_HIST_END_DTM,PFT_ID AS PFT_ID,PYRL_RPT_ID AS PYRL_RPT_ID,
			
			AUDIT_USER_ID_CREA AS PSR_AUDIT_USER_ID_CREA,
			
			AUDIT_USER_CREA_DTM AS PSR_AUDIT_USER_CREA_DTM,
			
			AUDIT_USER_ID_UPDT AS PSR_AUDIT_USER_ID_UPDT,
			
			AUDIT_USER_UPDT_DTM AS PSR_AUDIT_USER_UPDT_DTM,
			
			PLCY_STS_RSN_TYP_CD AS PSR1_PLCY_STS_RSN_TYP_CD,
			
			PLCY_STS_ID AS PSR1_PLCY_STS_ID,
			
			VOID_IND AS PSR1_VOID_IND 
			from      LOGIC_PSR1
        ),
RENAME_PSH1 as ( SELECT PLCY_STS_RSN_CHG_EFF_DT AS PLCY_STS_RSN_CHG_EFF_DT,PAYOFF_OPT_TYP_CD AS PAYOFF_OPT_TYP_CD,
			
			PAYOFF_OPT_TYP_CD AS PSH1_PAYOFF_OPT_TYP_CD,
			
			PLCY_STS_ID AS PSH1_PLCY_STS_ID 
			from      LOGIC_PSH1
        ),
RENAME_PST1 as ( SELECT PLCY_STS_TYP_NM AS PLCY_STS_TYP_NM,
			
			PLCY_STS_TYP_CD AS PST1_PLCY_STS_TYP_CD,
			
			PLCY_STS_TYP_VOID_IND AS PST1_PLCY_STS_TYP_VOID_IND 
			from      LOGIC_PST1
        ),
RENAME_PSRT1 as ( SELECT PLCY_STS_RSN_TYP_NM AS PLCY_STS_RSN_TYP_NM,
			
			PLCY_STS_RSN_TYP_CD AS PSRT1_PLCY_STS_RSN_TYP_CD,
			
			PLCY_STS_RSN_TYP_VOID_IND AS PSRT1_PLCY_STS_RSN_TYP_VOID_IND 
			from      LOGIC_PSRT1
        ),
RENAME_CMT1 as ( SELECT CANC_METH_TYP_NM AS CANC_METH_TYP_NM,
			
			CANC_METH_TYP_CD AS CMT1_CANC_METH_TYP_CD,
			
			VOID_IND AS CMT1_VOID_IND 
			from      LOGIC_CMT1
        ),
RENAME_PYOFF1 as ( SELECT PAYOFF_OPT_TYP_NM AS PAYOFF_OPT_TYP_NM,
			
			PAYOFF_OPT_TYP_DFLT AS PAYOFF_OPT_TYP_DFLT_IND,
			
			PAYOFF_OPT_TYP_CD AS PYOFF1_PAYOFF_OPT_TYP_CD,
			
			VOID_IND AS PYOFF1_VOID_IND 
			from      LOGIC_PYOFF1
        ),
RENAME_AG1 as ( SELECT 
			
			AGRE_ID AS AG1_AGRE_ID,
			
			AGRE_TYP_CD AS AG1_AGRE_TYP_CD  
			from      LOGIC_AG1
        ),
RENAME_PCE1 as ( SELECT 
			
			CTL_ELEM_SUB_TYP_ID AS PCE1_CTL_ELEM_SUB_TYP_ID,
			
			PLCY_PRD_ID AS PCE1_PLCY_PRD_ID,
			
			CTL_ELEM_TYP_CD AS PCE1_CTL_ELEM_TYP_CD,
			
			VOID_IND AS PCE1_VOID_IND  
			from      LOGIC_PCE1
        )

----HIST RENAME LAYER ----

,
RENAME_PP as ( SELECT PLCY_PRD_ID AS PLCY_PRD_ID,PLCY_NO AS PLCY_NO,AGRE_ID AS AGRE_ID,
			
			PLCY_PRD_EFF_DT AS PLCY_PRD_EFF_DATE,
			
			PLCY_PRD_END_DT AS PLCY_PRD_END_DATE,VOID_IND AS VOID_IND 
			from      LOGIC_PP
        ),
RENAME_CEST as ( SELECT 
			
			CTL_ELEM_SUB_TYP_CD AS PLCY_TYP_CODE,
			
			CTL_ELEM_SUB_TYP_NM AS PLCY_TYP_NAME,
			
			CTL_ELEM_SUB_TYP_VOID_IND AS CEST_CTL_ELEM_SUB_TYP_VOID_IND,
			
			CTL_ELEM_SUB_TYP_ID AS CEST_CTL_ELEM_SUB_TYP_ID 
			from      LOGIC_CEST
        ),
RENAME_PS as ( SELECT 
				HIST_ID  AS HIST_ID,
		PLCY_STS_ID  as PLCY_STS_ID,
			
			PLCY_STS_EFF_DT AS PLCY_STS_TRANS_DT,PLCY_STS_TYP_CD AS PLCY_STS_TYP_CD,CANC_METH_TYP_CD AS CANC_METH_TYP_CD,
			
			PLCY_STS_CANC_DT AS PLCY_STS_CANC_DATE,CANC_CMT AS CANC_CMT,
			
			HIST_EFF_DTM AS PSH_HIST_EFF_DTM,
			
			HIST_END_DTM AS PSH_HIST_END_DTM,AUTH_ID AS AUTH_ID,
			
			AUDIT_USER_ID_CREA AS PSH_AUDIT_USER_ID_CREA,
			
			AUDIT_USER_CREA_DTM AS PSH_AUDIT_USER_CREA_DTM,
			
			AUDIT_USER_ID_UPDT AS PSH_AUDIT_USER_ID_UPDT,
			
			AUDIT_USER_UPDT_DTM AS PSH_AUDIT_USER_UPDT_DTM,
			
			VOID_IND AS PS_VOID_IND,
			
			PLCY_PRD_ID AS PS_PLCY_PRD_ID 
			from      LOGIC_PS
        ),
RENAME_PSR as ( SELECT 
			
			PLCY_STS_RSN_EFF_DT AS PLCY_STS_RSN_TRANS_DT,PLCY_STS_RSN_TRAN_DUE_DT AS PLCY_STS_RSN_TRAN_DUE_DT,PLCY_STS_RSN_TYP_CD AS PLCY_STS_RSN_TYP_CD,
			
			HIST_EFF_DTM AS PSR_HIST_EFF_DTM,
			
			HIST_END_DTM AS PSR_HIST_END_DTM,PFT_ID AS PFT_ID,PYRL_RPT_ID AS PYRL_RPT_ID,
			
			AUDIT_USER_ID_CREA AS PSR_AUDIT_USER_ID_CREA,
			
			AUDIT_USER_CREA_DTM AS PSR_AUDIT_USER_CREA_DTM,
			
			AUDIT_USER_ID_UPDT AS PSR_AUDIT_USER_ID_UPDT,
			
			AUDIT_USER_UPDT_DTM AS PSR_AUDIT_USER_UPDT_DTM,
			
			VOID_IND AS PSR_VOID_IND,
			
			PLCY_STS_ID AS PSR_PLCY_STS_ID ,
			ROWN AS  ROWN
			from      LOGIC_PSR
        ),
RENAME_PSH as ( SELECT PLCY_STS_RSN_CHG_EFF_DT AS PLCY_STS_RSN_CHG_EFF_DT,PAYOFF_OPT_TYP_CD AS PAYOFF_OPT_TYP_CD,
			
			HIST_ID AS PSH_HIST_ID 
			from      LOGIC_PSH
        ),
RENAME_PST as ( SELECT PLCY_STS_TYP_NM AS PLCY_STS_TYP_NM,PLCY_STS_TYP_VOID_IND AS PLCY_STS_TYP_VOID_IND,
			
			PLCY_STS_TYP_CD AS PST_PLCY_STS_TYP_CD 
			from      LOGIC_PST
        ),
RENAME_PSRT as ( SELECT PLCY_STS_RSN_TYP_NM AS PLCY_STS_RSN_TYP_NM,PLCY_STS_RSN_TYP_VOID_IND AS PLCY_STS_RSN_TYP_VOID_IND,
			
			PLCY_STS_RSN_TYP_CD AS PSRT_PLCY_STS_RSN_TYP_CD 
			from      LOGIC_PSRT
        ),
RENAME_CMT as ( SELECT CANC_METH_TYP_NM AS CANC_METH_TYP_NM,
			
			VOID_IND AS CMT_VOID_IND,
			
			CANC_METH_TYP_CD AS CMT_CANC_METH_TYP_CD 
			from      LOGIC_CMT
        ),
RENAME_PYOFF as ( SELECT PAYOFF_OPT_TYP_NM AS PAYOFF_OPT_TYP_NM,
			
			PAYOFF_OPT_TYP_DFLT AS PAYOFF_OPT_TYP_DFLT_IND,
			
			PAYOFF_OPT_TYP_CD AS PYOFF_PAYOFF_OPT_TYP_CD,
			
			VOID_IND AS PYOFF_VOID_IND 
			from      LOGIC_PYOFF
        ),
RENAME_AG as ( SELECT AG_AGRE_ID AS AG_AGRE_ID, 
				AGRE_TYP_CD AS AGRE_TYP_CD 
			from      LOGIC_AG
        ),
RENAME_PCE as ( SELECT CTL_ELEM_SUB_TYP_ID AS CTL_ELEM_SUB_TYP_ID,
			
			PLCY_PRD_ID AS PCE_PLCY_PRD_ID,CTL_ELEM_TYP_CD AS CTL_ELEM_TYP_CD,
			
			VOID_IND AS PCE_VOID_IND  
			from      LOGIC_PCE
        )


----FILTER LAYER(uses aliases)----
,

        FILTER_PP1 as ( SELECT  * 
			from     RENAME_PP1 
            WHERE PP1_VOID_IND = 'N'
        ),

        FILTER_AG1 as ( SELECT  * 
			from     RENAME_AG1 
        --    WHERE AG1_AGRE_TYP_CD = 'PLCY'
        ),

        FILTER_PCE1 as ( SELECT  * 
			from     RENAME_PCE1 
            WHERE PCE1_VOID_IND = 'N' 
AND PCE1_CTL_ELEM_TYP_CD = 'PLCY_TYP'
        ),

        FILTER_CEST1 as ( SELECT  * 
			from     RENAME_CEST1 
            WHERE CEST1_CTL_ELEM_SUB_TYP_VOID_IND = 'N'
        ),

        FILTER_PS1 as ( SELECT  * 
			from     RENAME_PS1 
            WHERE PS1_VOID_IND = 'N'
        ),

        FILTER_PSH1 as ( SELECT  * 
			from     RENAME_PSH1 
            
        ),

        FILTER_PYOFF1 as ( SELECT  * 
			from     RENAME_PYOFF1 
            WHERE PYOFF1_VOID_IND = 'N'
        ),

        FILTER_PST1 as ( SELECT  * 
			from     RENAME_PST1 
            WHERE PST1_PLCY_STS_TYP_VOID_IND= 'N'
        ),

        FILTER_CMT1 as ( SELECT  * 
			from     RENAME_CMT1 
            WHERE CMT1_VOID_IND = 'N'
        ),

        FILTER_PSR1 as ( SELECT  * 
			from     RENAME_PSR1 
            WHERE PSR1_VOID_IND = 'N'
        ),

        FILTER_PSRT1 as ( SELECT  * 
			from     RENAME_PSRT1 
            WHERE PSRT1_PLCY_STS_RSN_TYP_VOID_IND = 'N'
        )


----HIST FILTER LAYER(uses aliases)----
,

        FILTER_PP as ( SELECT  * 
			from     RENAME_PP 
            WHERE VOID_IND = 'N'
        ),

        FILTER_AG as ( SELECT  * 
			from     RENAME_AG 
           -- WHERE AGRE_TYP_CD = 'PLCY'
        ),

        FILTER_PCE as ( SELECT  * 
			from     RENAME_PCE 
            WHERE PCE_VOID_IND = 'N' 
AND CTL_ELEM_TYP_CD = 'PLCY_TYP'
        ),

        FILTER_CEST as ( SELECT  * 
			from     RENAME_CEST 
            WHERE CEST_CTL_ELEM_SUB_TYP_VOID_IND = 'N'
        ),

        FILTER_PS as ( SELECT  * 
			from     RENAME_PS 
            WHERE PS_VOID_IND = 'N'
        ),

        FILTER_PSH as ( SELECT  * 
			from     RENAME_PSH 
            
        ),

        FILTER_PYOFF as ( SELECT  * 
			from     RENAME_PYOFF 
            WHERE PYOFF_VOID_IND = 'N'
        ),

        FILTER_PST as ( SELECT  * 
			from     RENAME_PST 
            WHERE PLCY_STS_TYP_VOID_IND= 'N'
        ),

        FILTER_CMT as ( SELECT  * 
			from     RENAME_CMT 
            WHERE CMT_VOID_IND = 'N'
        ),

        FILTER_PSR as ( SELECT  * 
			from     RENAME_PSR 
            WHERE PSR_VOID_IND = 'N'  AND (PSR_HIST_END_DTM IS NOT NULL or ROWN=1)
        ),

        FILTER_PSRT as ( SELECT  * 
			from     RENAME_PSRT 
            WHERE PLCY_STS_RSN_TYP_VOID_IND = 'N'
        )


----JOIN LAYER----
,
PP1 as ( SELECT * 
			from  FILTER_PP1
				INNER JOIN FILTER_AG1 ON FILTER_PP1.AGRE_ID = FILTER_AG1.AG1_AGRE_ID 
				LEFT JOIN FILTER_PCE1 ON FILTER_PP1.PLCY_PRD_ID = FILTER_PCE1.PCE1_PLCY_PRD_ID 
				LEFT JOIN FILTER_CEST1 ON FILTER_PCE1.PCE1_CTL_ELEM_SUB_TYP_ID = FILTER_CEST1.CEST1_CTL_ELEM_SUB_TYP_ID 
				INNER JOIN FILTER_PS1 ON FILTER_PP1.PLCY_PRD_ID = FILTER_PS1.PS1_PLCY_PRD_ID
				LEFT JOIN FILTER_PSH1 ON FILTER_PS1.PS1_PLCY_STS_ID = FILTER_PSH1.PSH1_PLCY_STS_ID 
				LEFT JOIN FILTER_PST1 ON FILTER_PS1.PLCY_STS_TYP_CD = FILTER_PST1.PST1_PLCY_STS_TYP_CD 
				LEFT JOIN FILTER_CMT1 ON FILTER_PS1.CANC_METH_TYP_CD = FILTER_CMT1.CMT1_CANC_METH_TYP_CD 
				INNER JOIN FILTER_PSR1 ON FILTER_PS1.PS1_PLCY_STS_ID = FILTER_PSR1.PSR1_PLCY_STS_ID 
				LEFT JOIN FILTER_PYOFF1 ON FILTER_PSH1.PAYOFF_OPT_TYP_CD = FILTER_PYOFF1.PYOFF1_PAYOFF_OPT_TYP_CD 
				LEFT JOIN FILTER_PSRT1 ON FILTER_PSR1.PLCY_STS_RSN_TYP_CD = FILTER_PSRT1.PSRT1_PLCY_STS_RSN_TYP_CD  ),

-- HIST JOIN LAYER---
PP as ( SELECT * 
			from  FILTER_PP
				INNER JOIN FILTER_AG ON FILTER_PP.AGRE_ID = FILTER_AG.AG_AGRE_ID 
				LEFT JOIN FILTER_PCE ON FILTER_PP.PLCY_PRD_ID = FILTER_PCE.PCE_PLCY_PRD_ID 
				LEFT JOIN FILTER_CEST ON FILTER_PCE.CTL_ELEM_SUB_TYP_ID = FILTER_CEST.CEST_CTL_ELEM_SUB_TYP_ID 
				INNER JOIN FILTER_PS ON FILTER_PP.PLCY_PRD_ID = FILTER_PS.PS_PLCY_PRD_ID 
				LEFT JOIN FILTER_PSH ON FILTER_PS.HIST_ID = FILTER_PSH.PSH_HIST_ID 
				LEFT JOIN FILTER_PST ON FILTER_PS.PLCY_STS_TYP_CD = FILTER_PST.PST_PLCY_STS_TYP_CD 
				LEFT JOIN FILTER_CMT ON FILTER_PS.CANC_METH_TYP_CD = FILTER_CMT.CMT_CANC_METH_TYP_CD 
				INNER JOIN FILTER_PSR ON FILTER_PS.PLCY_STS_ID = FILTER_PSR.PSR_PLCY_STS_ID AND FILTER_PS.PSH_HIST_EFF_DTM = FILTER_PSR.PSR_HIST_EFF_DTM
				AND  FILTER_PS.PSH_HIST_END_DTM IS NOT NULL
				LEFT JOIN FILTER_PYOFF ON FILTER_PSH.PAYOFF_OPT_TYP_CD = FILTER_PYOFF.PYOFF_PAYOFF_OPT_TYP_CD 
				LEFT JOIN FILTER_PSRT ON FILTER_PSR.PLCY_STS_RSN_TYP_CD = FILTER_PSRT.PSRT_PLCY_STS_RSN_TYP_CD ),


--- ETL LAYER ---


UNION_Final as (

select 
PLCY_PRD_ID
, PLCY_NO
, PLCY_TYP_CODE
, PLCY_TYP_NAME
, AGRE_ID
, PLCY_PRD_EFF_DATE
, PLCY_PRD_END_DATE
, PLCY_STS_TRANS_DT
, PLCY_STS_RSN_TRANS_DT
, PLCY_STS_RSN_CHG_EFF_DT
, PLCY_STS_RSN_TRAN_DUE_DT
, PAYOFF_OPT_TYP_CD
, PLCY_STS_TYP_CD
, PLCY_STS_TYP_NM
, PLCY_STS_RSN_TYP_CD
, PLCY_STS_RSN_TYP_NM
, CANC_METH_TYP_CD
, CANC_METH_TYP_NM
, PLCY_STS_CANC_DATE
, CANC_CMT
, PSH_HIST_EFF_DTM
, PSH_HIST_END_DTM::TIMESTAMP AS PSH_HIST_END_DTM
, PSR_HIST_EFF_DTM
, PSR_HIST_END_DTM
, IFF(AG1_AGRE_TYP_CD='QUOT' ,'N' , 'Y') AS CRNT_PLCY_PRD_STS_RSN_IND
, AUTH_ID
, PFT_ID
, PYRL_RPT_ID
, PSH_AUDIT_USER_ID_CREA
, PSH_AUDIT_USER_CREA_DTM
, PSH_AUDIT_USER_ID_UPDT
, PSH_AUDIT_USER_UPDT_DTM
, PSR_AUDIT_USER_ID_CREA
, PSR_AUDIT_USER_CREA_DTM
, PSR_AUDIT_USER_ID_UPDT
, PSR_AUDIT_USER_UPDT_DTM
, PAYOFF_OPT_TYP_NM
, PAYOFF_OPT_TYP_DFLT_IND
, AG1_AGRE_TYP_CD AS AGRE_TYP_CD
 from PP1
 
 UNION ALL 

SELECT 
PLCY_PRD_ID
, PLCY_NO
, PLCY_TYP_CODE
, PLCY_TYP_NAME
, AGRE_ID
, PLCY_PRD_EFF_DATE
, PLCY_PRD_END_DATE
, PLCY_STS_TRANS_DT
, PLCY_STS_RSN_TRANS_DT
, PLCY_STS_RSN_CHG_EFF_DT
, PLCY_STS_RSN_TRAN_DUE_DT
, PAYOFF_OPT_TYP_CD
, PLCY_STS_TYP_CD
, PLCY_STS_TYP_NM
, PLCY_STS_RSN_TYP_CD
, PLCY_STS_RSN_TYP_NM
, CANC_METH_TYP_CD
, CANC_METH_TYP_NM
, PLCY_STS_CANC_DATE
, CANC_CMT
, PSH_HIST_EFF_DTM
, PSH_HIST_END_DTM
, PSR_HIST_EFF_DTM
, PSR_HIST_END_DTM
, 'N' AS CRNT_PLCY_PRD_STS_RSN_IND
, AUTH_ID
, PFT_ID
, PYRL_RPT_ID
, PSH_AUDIT_USER_ID_CREA
, PSH_AUDIT_USER_CREA_DTM
, PSH_AUDIT_USER_ID_UPDT
, PSH_AUDIT_USER_UPDT_DTM
, PSR_AUDIT_USER_ID_CREA
, PSR_AUDIT_USER_CREA_DTM
, PSR_AUDIT_USER_ID_UPDT
, PSR_AUDIT_USER_UPDT_DTM
, PAYOFF_OPT_TYP_NM
, PAYOFF_OPT_TYP_DFLT_IND
, AGRE_TYP_CD
FROM PP
)

select 
  PLCY_PRD_ID
, PLCY_NO
, PLCY_TYP_CODE
, PLCY_TYP_NAME
, AGRE_ID
, PLCY_PRD_EFF_DATE
, PLCY_PRD_END_DATE
, PLCY_STS_TRANS_DT
, PLCY_STS_RSN_TRANS_DT
, PLCY_STS_RSN_CHG_EFF_DT
, PLCY_STS_RSN_TRAN_DUE_DT
, PAYOFF_OPT_TYP_CD
, PLCY_STS_TYP_CD
, PLCY_STS_TYP_NM
, PLCY_STS_RSN_TYP_CD
, PLCY_STS_RSN_TYP_NM
, CANC_METH_TYP_CD
, CANC_METH_TYP_NM
, PLCY_STS_CANC_DATE
, CANC_CMT
, PSH_HIST_EFF_DTM
, PSH_HIST_END_DTM
, PSR_HIST_EFF_DTM
, PSR_HIST_END_DTM
, CRNT_PLCY_PRD_STS_RSN_IND
, case when CRNT_PLCY_PRD_STS_RSN_IND = 'Y' and AGRE_TYP_CD = 'PLCY' and
  row_number()over(partition by AGRE_ID  order by PLCY_PRD_EFF_DATE desc,PLCY_PRD_END_DATE desc, NVL(PSH_HIST_END_DTM, CURRENT_DATE) desc, NVL(PSR_HIST_END_DTM, CURRENT_DATE) desc ) =1
  then 'Y' else 'N' end as MOST_RCNT_PLCY_STS_RSN_IND
, AUTH_ID
, PFT_ID
, PYRL_RPT_ID
, PSH_AUDIT_USER_ID_CREA
, PSH_AUDIT_USER_CREA_DTM
, PSH_AUDIT_USER_ID_UPDT
, PSH_AUDIT_USER_UPDT_DTM
, PSR_AUDIT_USER_ID_CREA
, PSR_AUDIT_USER_CREA_DTM
, PSR_AUDIT_USER_ID_UPDT
, PSR_AUDIT_USER_UPDT_DTM
, PAYOFF_OPT_TYP_NM
, PAYOFF_OPT_TYP_DFLT_IND
, AGRE_TYP_CD
from UNION_Final