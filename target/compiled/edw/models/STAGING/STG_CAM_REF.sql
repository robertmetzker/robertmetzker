----SRC LAYER----
WITH
SRC_REF as ( SELECT *     from      DEV_VIEWS.BASE.REF ),
SRC_REF2 as ( SELECT *     from      DEV_VIEWS.BASE.REF )
----LOGIC LAYER----
,
LOGIC_REF as ( SELECT 
		UPPER(TRIM(REF_DGN)) AS REF_DGN,
		UPPER(TRIM(REF_IDN)) AS REF_IDN,
		cast(REF_EFF_DTE as DATE) AS REF_EFF_DTE,
		cast(REF_EXP_DTE as DATE) AS REF_EXP_DTE,
		cast(REF_DLM as DATE) AS REF_DLM,
		UPPER(TRIM(REF_ULM)) AS REF_ULM,
		UPPER(TRIM(REF_DSC)) AS REF_DSC,
		cast(REF_ENT_DTE as DATE) AS REF_ENT_DTE,
		UPPER(TRIM(REF_ENT_UID)) AS REF_ENT_UID,
		REF_RID AS REF_RID 
				from SRC_REF
            ),
LOGIC_REF2 as ( SELECT 
		UPPER(TRIM(REF_DSC)) AS REF_DSC,
		UPPER(TRIM(REF_IDN)) AS REF_IDN,
		UPPER(TRIM(REF_DGN)) AS REF_DGN 
				from SRC_REF2
            )
----RENAME LAYER ----
,
RENAME_REF as ( SELECT REF_DGN AS REF_DGN,REF_IDN AS REF_IDN,REF_EFF_DTE AS REF_EFF_DTE,REF_EXP_DTE AS REF_EXP_DTE,REF_DLM AS REF_DLM,REF_ULM AS REF_ULM,REF_DSC AS REF_DSC,REF_ENT_DTE AS REF_ENT_DTE,REF_ENT_UID AS REF_ENT_UID,REF_RID AS REF_RID 
			from      LOGIC_REF
        ),
RENAME_REF2 as ( SELECT 
			
			REF_DSC AS REF_DGN_DESC,
			
			REF_IDN AS REF2_REF_IDN,
			
			REF_DGN AS REF2_REF_DGN 
			from      LOGIC_REF2
        )
----FILTER LAYER(uses aliases)----
,

        FILTER_REF as ( SELECT  * 
			from     RENAME_REF 
            
        ),

        FILTER_REF2 as ( SELECT  * 
			from     RENAME_REF2 
            WHERE RENAME_REF2.REF2_REF_DGN = 'DGN'
        )
----JOIN LAYER----
,
REF as ( SELECT * 
			from  FILTER_REF
				LEFT JOIN FILTER_REF2 ON FILTER_REF.REF_DGN = FILTER_REF2.REF2_REF_IDN  )
select * from REF