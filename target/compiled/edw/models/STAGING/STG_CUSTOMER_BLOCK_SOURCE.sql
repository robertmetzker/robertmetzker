----SRC LAYER----
WITH
SRC_CBRB as ( SELECT *     from      DEV_VIEWS.PCMP.CUSTOMER_BLOCK_ROLE_BLOCK ),
SRC_B as ( SELECT *     from      DEV_VIEWS.PCMP.BLOCK ),
SRC_BT as ( SELECT *     from      DEV_VIEWS.PCMP.BLOCK_TYPE ),

----LOGIC LAYER----

LOGIC_CBRB as ( SELECT 
		CUST_BLK_ROLE_BLK_ID::numeric(31,0) AS CUST_BLK_ROLE_BLK_ID,
		CUST_ID::numeric(31,0) AS CUST_ID,
		BLK_ID::numeric(31,0) AS BLK_ID,
		UPPER(TRIM(CUST_ROLE_TYP_CD)) AS CUST_ROLE_TYP_CD,
		AUDIT_USER_ID_CREA::numeric(31,0) AS AUDIT_USER_ID_CREA,
		AUDIT_USER_CREA_DTM AS AUDIT_USER_CREA_DTM,
		AUDIT_USER_ID_UPDT::numeric(31,0) AS AUDIT_USER_ID_UPDT,
		AUDIT_USER_UPDT_DTM AS AUDIT_USER_UPDT_DTM,
		UPPER(CUST_BLK_ROLE_BLK_VOID_IND) AS CUST_BLK_ROLE_BLK_VOID_IND 
				from SRC_CBRB
            ),
LOGIC_B as ( SELECT 
		UPPER(TRIM(BLK_TYP_CD)) AS BLK_TYP_CD,
		cast(BLK_EFF_DT as DATE) AS BLK_EFF_DT,
		cast(BLK_END_DT as DATE) AS BLK_END_DT,
		AUDIT_USER_ID_CREA::numeric(31,0) AS AUDIT_USER_ID_CREA,
		AUDIT_USER_CREA_DTM AS AUDIT_USER_CREA_DTM,
		AUDIT_USER_ID_UPDT::numeric(31,0) AS AUDIT_USER_ID_UPDT,
		AUDIT_USER_UPDT_DTM AS AUDIT_USER_UPDT_DTM,
		UPPER(VOID_IND) AS VOID_IND,
		BLK_ID::numeric(31,0) AS BLK_ID 
				from SRC_B
            ),
LOGIC_BT as ( SELECT 
		UPPER(TRIM(BLK_TYP_NM)) AS BLK_TYP_NM,
		UPPER(TRIM(APP_TYP_CD)) AS APP_TYP_CD,
		UPPER(PLCY_BLK_HDR_DSPLY_IND) AS PLCY_BLK_HDR_DSPLY_IND,
		UPPER(CLM_BLK_HDR_DSPLY_IND) AS CLM_BLK_HDR_DSPLY_IND,
		UPPER(BLK_TYP_VOID_IND) AS BLK_TYP_VOID_IND,
		UPPER(TRIM(BLK_TYP_CD)) AS BLK_TYP_CD 
				from SRC_BT
            )
----RENAME LAYER ----
,
RENAME_CBRB as ( SELECT CUST_BLK_ROLE_BLK_ID AS CUST_BLK_ROLE_BLK_ID,CUST_ID AS CUST_ID,
			
			BLK_ID AS CBRB_BLK_ID,CUST_ROLE_TYP_CD AS CUST_ROLE_TYP_CD,
			
			AUDIT_USER_ID_CREA AS CBRB_AUDIT_USER_ID_CREA,
			
			AUDIT_USER_CREA_DTM AS CBRB_AUDIT_USER_CREA_DTM,
			
			AUDIT_USER_ID_UPDT AS CBRB_AUDIT_USER_ID_UPDT,
			
			AUDIT_USER_UPDT_DTM AS CBRB_AUDIT_USER_UPDT_DTM,CUST_BLK_ROLE_BLK_VOID_IND AS CUST_BLK_ROLE_BLK_VOID_IND 
			from      LOGIC_CBRB
        ),
RENAME_B as ( SELECT BLK_TYP_CD AS BLK_TYP_CD,BLK_EFF_DT AS BLK_EFF_DT,BLK_END_DT AS BLK_END_DT,
			
			AUDIT_USER_ID_CREA AS B_AUDIT_USER_ID_CREA,
			
			AUDIT_USER_CREA_DTM AS B_AUDIT_USER_CREA_DTM,
			
			AUDIT_USER_ID_UPDT AS B_AUDIT_USER_ID_UPDT,
			
			AUDIT_USER_UPDT_DTM AS B_AUDIT_USER_UPDT_DTM,VOID_IND AS VOID_IND,
			
			BLK_ID AS B_BLK_ID 
			from      LOGIC_B
        ),
RENAME_BT as ( SELECT BLK_TYP_NM AS BLK_TYP_NM,APP_TYP_CD AS APP_TYP_CD,PLCY_BLK_HDR_DSPLY_IND AS PLCY_BLK_HDR_DSPLY_IND,CLM_BLK_HDR_DSPLY_IND AS CLM_BLK_HDR_DSPLY_IND,BLK_TYP_VOID_IND AS BLK_TYP_VOID_IND,
			
			BLK_TYP_CD AS BT_BLK_TYP_CD 
			from      LOGIC_BT
        )
----FILTER LAYER(uses aliases)----
,

        FILTER_CBRB as ( SELECT  * 
			from     RENAME_CBRB 
            
        ),

        FILTER_B as ( SELECT  * 
			from     RENAME_B 
            
        ),

        FILTER_BT as ( SELECT  * 
			from     RENAME_BT 
            
        )
----JOIN LAYER----
,
B as ( SELECT * 
			from  FILTER_B
				INNER JOIN FILTER_BT on FILTER_B.BLK_TYP_CD = FILTER_BT.BT_BLK_TYP_CD  ),
CBRB as ( SELECT * 
			from  FILTER_CBRB
				INNER JOIN B on B.B_BLK_ID = FILTER_CBRB.CBRB_BLK_ID )
select * from CBRB