----SRC LAYER----
WITH
SRC_IB as ( SELECT *     from      DEV_VIEWS.BASE.ICD_BASE ),
SRC_IG as ( SELECT *     from      DEV_VIEWS.BASE.ICD_GENERAL )
----LOGIC LAYER----
,
LOGIC_IB as ( SELECT 
		ICD_RID AS ICD_RID,
		UPPER(TRIM(CODE)) AS CODE,
		VERSION AS VERSION,
		UPPER(TRIM(ICD_TYPE)) AS ICD_TYPE 
     
				from SRC_IB
            ),
LOGIC_IG as ( SELECT 
		UPPER(TRIM(DESCRIPTION)) AS DESCRIPTION,
		cast(EFFECTIVE_DATE as DATE) AS EFFECTIVE_DATE,
		cast(EXPIRATION_DATE as DATE) AS EXPIRATION_DATE,
		cast(ENTRY_DATE as DATE) AS ENTRY_DATE,
		UPPER(TRIM(GENDER)) AS GENDER,
		UPPER(TRIM(COVERED_FLAG)) AS COVERED_FLAG,
		MIN_AGE AS MIN_AGE,
		MAX_AGE AS MAX_AGE,
		ICD_RID AS ICD_RID 
				from SRC_IG
            )
----RENAME LAYER ----
,
RENAME_IB as ( SELECT ICD_RID AS ICD_RID,CODE AS CODE,VERSION AS VERSION,ICD_TYPE AS ICD_TYPE 
			from      LOGIC_IB
        ),
RENAME_IG as ( SELECT DESCRIPTION AS DESCRIPTION,EFFECTIVE_DATE AS EFFECTIVE_DATE,EXPIRATION_DATE AS EXPIRATION_DATE,ENTRY_DATE AS ENTRY_DATE,GENDER AS GENDER,COVERED_FLAG AS COVERED_FLAG,MIN_AGE AS MIN_AGE,MAX_AGE AS MAX_AGE,
			
			ICD_RID AS IG_ICD_RID 
			from      LOGIC_IG
        )
----FILTER LAYER(uses aliases)----
,

        FILTER_IB as ( SELECT  * 
			from     RENAME_IB 
            WHERE ICD_TYPE = 'P'
        ),

        FILTER_IG as ( SELECT  * 
			from     RENAME_IG 
            
        )
----JOIN LAYER----
,
IB as ( SELECT * 
			from  FILTER_IB
				INNER JOIN FILTER_IG ON FILTER_IB.ICD_RID = FILTER_IG.IG_ICD_RID  )
select * from IB