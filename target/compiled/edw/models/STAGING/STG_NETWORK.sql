----SRC LAYER----
WITH
SRC_CUST as ( SELECT *     from      DEV_VIEWS.PCMP.CUSTOMER  ),
SRC_NTWK as ( SELECT *     from      DEV_VIEWS.BASE.NTWK ),
SRC_NSH as ( SELECT *     from      DEV_VIEWS.BASE.NTWK_STATUS_HISTORY ),
SRC_REF2 as ( SELECT *     from      DEV_VIEWS.BASE.REF ),
SRC_REF1 as ( SELECT *     from      DEV_VIEWS.BASE.REF ),
SRC_NTWK2 as ( SELECT *     from      DEV_VIEWS.BASE.NTWK ),
SRC_FADR as ( SELECT *     from      DEV_VIEWS.BASE.ADR ),
SRC_LADR as ( SELECT *     from      DEV_VIEWS.BASE.ADR ),
SRC_MADR as ( SELECT *     from      DEV_VIEWS.BASE.ADR ),
SRC_AT1 as ( SELECT *     from      DEV_VIEWS.BASE.ADR_TYP ),
SRC_AT2 as ( SELECT *     from      DEV_VIEWS.BASE.ADR_TYP ),
SRC_AT3 as ( SELECT *     from      DEV_VIEWS.BASE.ADR_TYP ),
SRC_CRIM as ( SELECT *     from      DEV_VIEWS.PCMP.CUSTOMER_ROLE_IDENTIFIER   )
----LOGIC LAYER----
,
LOGIC_CUST as ( SELECT 
	 -- CUST_NO AS CUST_NO,
		cast(CUST_NO as string) AS CUST_NO,
		CUST_ID AS CUST_ID,
		UPPER(VOID_IND) AS VOID_IND 
				from SRC_CUST
            ),
LOGIC_NTWK as ( SELECT 
	 -- NTWK_NUMBER AS NTWK_NUMBER,
		cast(NTWK_NUMBER as text) AS NTWK_NUMBER,
		UPPER(trim(NAME)) AS NAME,
		UPPER(trim(TYPE)) AS TYPE,
		cast(COB_DATE as DATE) AS COB_DATE,
		UPPER(trim(CUST_SVC_AREA_CODE)) AS CUST_SVC_AREA_CODE,
		UPPER(trim(CUST_SVC_EXCHANGE)) AS CUST_SVC_EXCHANGE,
		UPPER(trim(CUST_SVC_NUMBER)) AS  CUST_SVC_NUMBER,
	 -- UPPER(--- NEW NTWK_CUSTOMER_SERVICE_FULL_PHONE_NUMBER) AS (DERIVED),
        UPPER(CUST_SVC_AREA_CODE) || '-' || UPPER(CUST_SVC_EXCHANGE) || '-' || UPPER(CUST_SVC_NUMBER) AS NTWK_CUSTOMER_SERVICE_FULL_PHONE_NUMBER,
		MERGED_MCO AS MERGED_MCO,
	 -- NTWK_ID AS NTWK_ID 
		cast(NTWK_ID as integer) AS NTWK_ID 
				from SRC_NTWK
            ),
LOGIC_NSH as ( SELECT 
		UPPER(trim(STATUS)) AS STATUS,
		cast(START_DATE as DATE) AS START_DATE,
		cast(END_DATE as DATE) AS END_DATE,
	 -- NTWK_ID AS NTWK_ID 
		cast(NTWK_ID as integer) AS NTWK_ID 
				from SRC_NSH
            ),
LOGIC_REF2 as ( SELECT 
		UPPER(REF_DSC) AS REF_DSC,
		UPPER(REF_IDN) AS REF_IDN,
		UPPER(REF_DGN) AS REF_DGN 
				from SRC_REF2
            ),
LOGIC_REF1 as ( SELECT 
		UPPER(REF_DSC) AS REF_DSC,
		UPPER(REF_IDN) AS REF_IDN,
		UPPER(REF_DGN) AS REF_DGN 
				from SRC_REF1
            ),
LOGIC_NTWK2 as ( SELECT 
		UPPER(trim(NAME)) AS NAME,
	 -- NTWK_NUMBER AS NTWK_NUMBER,
		cast(NTWK_NUMBER as text) AS NTWK_NUMBER,
	 -- NTWK_ID AS NTWK_ID 
  		cast(NTWK_ID as integer) AS NTWK_ID 
				from SRC_NTWK2
            ),
LOGIC_FADR as ( SELECT 
		UPPER(ADR_LIN_1) AS ADR_LIN_1,
		UPPER(ADR_LIN_2) AS ADR_LIN_2,
		UPPER(ADR_CTY) AS ADR_CTY,
		UPPER(ADR_STA_ABB) AS ADR_STA_ABB,
		UPPER(ADR_ZIP) AS ADR_ZIP,
		UPPER(ADR_ZIP_EXT) AS ADR_ZIP_EXT,
		ADR_RID AS ADR_RID,
		ADR_IDN AS ADR_IDN,
		ADR_CLS AS ADR_CLS 
				from SRC_FADR
            ),
LOGIC_LADR as ( SELECT 
		UPPER(ADR_LIN_1) AS ADR_LIN_1,
		UPPER(ADR_LIN_2) AS ADR_LIN_2,
		UPPER(ADR_CTY) AS ADR_CTY,
		UPPER(ADR_STA_ABB) AS ADR_STA_ABB,
		UPPER(ADR_ZIP) AS ADR_ZIP,
		UPPER(ADR_ZIP_EXT) AS ADR_ZIP_EXT,
		ADR_RID AS ADR_RID,
		ADR_IDN AS ADR_IDN,
		ADR_CLS AS ADR_CLS 
				from SRC_LADR
            ),
LOGIC_MADR as ( SELECT 
		UPPER(ADR_LIN_1) AS ADR_LIN_1,
		UPPER(ADR_LIN_2) AS ADR_LIN_2,
		UPPER(ADR_CTY) AS ADR_CTY,
		UPPER(ADR_STA_ABB) AS ADR_STA_ABB,
		UPPER(ADR_ZIP) AS ADR_ZIP,
		UPPER(ADR_ZIP_EXT) AS ADR_ZIP_EXT,
		ADR_RID AS ADR_RID,
		ADR_IDN AS ADR_IDN,
		ADR_CLS AS ADR_CLS 
				from SRC_MADR
            ),
LOGIC_AT1 as ( SELECT 
		UPPER(ADR_TYP_TYP) AS ADR_TYP_TYP,
		ADR_TYP_IDN AS ADR_TYP_IDN,
		cast(ADR_TYP_EFF_DTE as DATE) AS ADR_TYP_EFF_DTE,
		cast(ADR_TYP_EXP_DTE as DATE) AS ADR_TYP_EXP_DTE 
				from SRC_AT1
            ),
LOGIC_AT2 as ( SELECT 
		UPPER(ADR_TYP_TYP) AS ADR_TYP_TYP,
		ADR_TYP_IDN AS ADR_TYP_IDN,
		cast(ADR_TYP_EFF_DTE as DATE) AS ADR_TYP_EFF_DTE,
		cast(ADR_TYP_EXP_DTE as DATE) AS ADR_TYP_EXP_DTE 
				from SRC_AT2
            ),
LOGIC_AT3 as ( SELECT 
		UPPER(ADR_TYP_TYP) AS ADR_TYP_TYP,
		ADR_TYP_IDN AS ADR_TYP_IDN,
		cast(ADR_TYP_EFF_DTE as DATE) AS ADR_TYP_EFF_DTE,
		cast(ADR_TYP_EXP_DTE as DATE) AS ADR_TYP_EXP_DTE 
				from SRC_AT3
            ),
LOGIC_CRIM as ( SELECT 
		UPPER(CUST_ROLE_ID_VAL_STR) AS CUST_ROLE_ID_VAL_STR,
		CUST_ID AS CUST_ID,
		UPPER(ID_TYP_CD) AS ID_TYP_CD,
		cast(CUST_ROLE_ID_END_DT as DATE) AS CUST_ROLE_ID_END_DT,
		UPPER(VOID_IND) AS VOID_IND 
				from SRC_CRIM
            )
----RENAME LAYER ----
,
RENAME_CUST as ( SELECT CUST_NO AS CUST_NO,
			
			CUST_ID AS CUST_CUST_ID,
			
			VOID_IND AS CUST_VOID_IND 
			from      LOGIC_CUST
        ),
RENAME_NTWK as ( SELECT NTWK_NUMBER AS NTWK_NUMBER,
			
			NAME AS NTWK_NAME,
			
			TYPE AS NTWK_TYPE,COB_DATE AS COB_DATE,CUST_SVC_AREA_CODE AS CUST_SVC_AREA_CODE,CUST_SVC_EXCHANGE AS CUST_SVC_EXCHANGE,CUST_SVC_NUMBER AS CUST_SVC_NUMBER,
			
		 -- (DERIVED) AS NTWK_CUSTOMER_SERVICE_FULL_PHONE_NUMBER,
            NTWK_CUSTOMER_SERVICE_FULL_PHONE_NUMBER AS NTWK_CUSTOMER_SERVICE_FULL_PHONE_NUMBER,
			
			MERGED_MCO AS MERGED_MCO,NTWK_ID AS NTWK_ID 
			from      LOGIC_NTWK
        ),
RENAME_NSH as ( SELECT STATUS AS STATUS,START_DATE AS START_DATE,END_DATE AS END_DATE,
			
			NTWK_ID AS NSH_NTWK_ID 
			from      LOGIC_NSH
        ),
RENAME_REF2 as ( SELECT 
			
			REF_DSC AS NTWK_STATUS_DSC,
			
			REF_IDN AS NTWK_STATUS_IDN,
			
			REF_DGN AS NTWK_STATUS_DGN 
			from      LOGIC_REF2
        ),
RENAME_REF1 as ( SELECT REF_DSC AS REF_DSC,
			
			REF_IDN AS NTWK_TYPE_IDN,
			
			REF_DGN AS NTWK_TYPE_DGN 
			from      LOGIC_REF1
        ),
RENAME_NTWK2 as ( SELECT 
			
			NAME AS ACQUIRING_NTWK_NAME,
			
			NTWK_NUMBER AS ACQUIRING_NTWK_NUMBER,
			
			NTWK_ID AS NTWK2_NTWK_ID 
			from      LOGIC_NTWK2
        ),
RENAME_FADR as ( SELECT 
			
			ADR_LIN_1 AS NTWK_FINANCIAL_STREET_ADDRESS_1,
			
			ADR_LIN_2 AS NTWK_FINANCIAL_STREET_ADDRESS_2,
			
			ADR_CTY AS NTWK_FINANCIAL_ADDRESS_CITY_NAME,
			
			ADR_STA_ABB AS NTWK_FINANCIAL_ADDRESS_STATE_CODE,
			
			ADR_ZIP AS NTWK_FINANCIAL_ADDRESS_ZIP_CODE,
			
			ADR_ZIP_EXT AS NTWK_FINANCIAL_ADDRESS_ZIP4_CODE,
			
			ADR_RID AS FADR_RID,
			
			ADR_IDN AS FADR_IDN,
			
			ADR_CLS AS FADR_CLS 
			from      LOGIC_FADR
        ),
RENAME_LADR as ( SELECT 
			
			ADR_LIN_1 AS NTWK_PHYSICAL_STREET_ADDRESS_1,
			
			ADR_LIN_2 AS NTWK_PHYSICAL_STREET_ADDRESS_2,
			
			ADR_CTY AS NTWK_PHYSICAL_ADDRESS_CITY_NAME,
			
			ADR_STA_ABB AS NTWK_PHYSICAL_ADDRESS_STATE_CODE,
			
			ADR_ZIP AS NTWK_PHYSICAL_ADDRESS_ZIP_CODE,
			
			ADR_ZIP_EXT AS NTWK_PHYSICAL_ADDRESS_ZIP4_CODE,
			
			ADR_RID AS LADR_RID,
			
			ADR_IDN AS LADR_IDN,
			
			ADR_CLS AS LADR_CLS 
			from      LOGIC_LADR
        ),
RENAME_MADR as ( SELECT 
			
			ADR_LIN_1 AS NTWK_MAILING_STREET_ADDRESS_1,
			
			ADR_LIN_2 AS NTWK_MAILING_STREET_ADDRESS_2,
			
			ADR_CTY AS NTWK_MAILING_ADDRESS_CITY_NAME,
			
			ADR_STA_ABB AS NTWK_MAILING_ADDRESS_STATE_CODE,
			
			ADR_ZIP AS NTWK_MAILING_ADDRESS_ZIP_CODE,
			
			ADR_ZIP_EXT AS NTWK_MAILING_ADDRESS_ZIP4_CODE,
			
			ADR_RID AS MADR_RID,
			
			ADR_IDN AS MADR_IDN,
			
			ADR_CLS AS MADR_CLS 
			from      LOGIC_MADR
        ),
RENAME_AT1 as ( SELECT 
			
			ADR_TYP_TYP AS AT1_ADR_TYP_TYP,
			
			ADR_TYP_IDN AS AT1_ADR_TYP_IDN,
			
			ADR_TYP_EFF_DTE AS AT1_ADR_TYP_EFF_DTE,
			
			ADR_TYP_EXP_DTE AS AT1_ADR_TYP_EXP_DTE 
			from      LOGIC_AT1
        ),
RENAME_AT2 as ( SELECT 
			
			ADR_TYP_TYP AS AT2_ADR_TYP_TYP,
			
			ADR_TYP_IDN AS AT2_ADR_TYP_IDN,
			
			ADR_TYP_EFF_DTE AS AT2_ADR_TYP_EFF_DTE,
			
			ADR_TYP_EXP_DTE AS AT2_ADR_TYP_EXP_DTE 
			from      LOGIC_AT2
        ),
RENAME_AT3 as ( SELECT 
			
			ADR_TYP_TYP AS AT3_ADR_TYP_TYP,
			
			ADR_TYP_IDN AS AT3_ADR_TYP_IDN,
			
			ADR_TYP_EFF_DTE AS AT3_ADR_TYP_EFF_DTE,
			
			ADR_TYP_EXP_DTE AS AT3_ADR_TYP_EXP_DTE 
			from      LOGIC_AT3
        ),
RENAME_CRIM as ( SELECT CUST_ROLE_ID_VAL_STR AS CUST_ROLE_ID_VAL_STR,
			
			CUST_ID AS CRIM_CUST_ID,ID_TYP_CD AS ID_TYP_CD,CUST_ROLE_ID_END_DT AS CUST_ROLE_ID_END_DT,
			
			VOID_IND AS CRIM_VOID_IND 
			from      LOGIC_CRIM
        )
----FILTER LAYER(uses aliases)----
,

        FILTER_NTWK as ( SELECT  * 
			from     RENAME_NTWK 
            
        ),

        FILTER_REF1 as ( SELECT  * 
			from     RENAME_REF1 
            WHERE NTWK_TYPE_DGN = 'NTT'
        ),

        FILTER_NSH as ( SELECT  * 
			from     RENAME_NSH 
            
        ),

        FILTER_REF2 as ( SELECT  * 
			from     RENAME_REF2 
            WHERE NTWK_STATUS_DGN = 'NSC'
        ),

        FILTER_NTWK2 as ( SELECT  * 
			from     RENAME_NTWK2 
            
        ),

        FILTER_FADR as ( SELECT  * 
			from     RENAME_FADR 
            WHERE FADR_CLS = 'N'
        ),

        FILTER_AT1 as ( SELECT  * 
			from     RENAME_AT1 
            WHERE AT1_ADR_TYP_TYP = 'F'  and NVL(AT1_ADR_TYP_EXP_DTE,dateadd(day,1,current_date )) >CURRENT_DATE
        ),

        FILTER_LADR as ( SELECT  * 
			from     RENAME_LADR 
            WHERE LADR_CLS = 'N'
        ),

        FILTER_AT2 as ( SELECT  * 
			from     RENAME_AT2 
            WHERE AT2_ADR_TYP_TYP = 'L'  and NVL(AT2_ADR_TYP_EXP_DTE, dateadd(day,1,current_date )) >CURRENT_DATE
        ),

        FILTER_MADR as ( SELECT  * 
			from     RENAME_MADR 
            WHERE MADR_CLS = 'N'
        ),

        FILTER_AT3 as ( SELECT  * 
			from     RENAME_AT3 
            WHERE AT3_ADR_TYP_TYP = 'M'  and NVL(AT3_ADR_TYP_EXP_DTE,dateadd(day,1,current_date )) >CURRENT_DATE
        ),

        FILTER_CRIM as ( SELECT  * 
			from     RENAME_CRIM 
            WHERE ID_TYP_CD = 'MCO' AND CUST_ROLE_ID_END_DT IS NULL AND CRIM_VOID_IND='N'
        ),

        FILTER_CUST as ( SELECT  * 
			from     RENAME_CUST 
            WHERE CUST_VOID_IND = 'N'
        )
----JOIN LAYER----
,
FADR as ( SELECT * 
			from  FILTER_FADR
				INNER JOIN FILTER_AT1 ON FILTER_FADR.FADR_RID = FILTER_AT1.AT1_ADR_TYP_IDN  ),
LADR as ( SELECT * 
			from  FILTER_LADR
				INNER JOIN FILTER_AT2 ON FILTER_LADR.LADR_RID = FILTER_AT2.AT2_ADR_TYP_IDN  ),
MADR as ( SELECT * 
			from  FILTER_MADR
				INNER JOIN FILTER_AT3 ON FILTER_MADR.MADR_RID = FILTER_AT3.AT3_ADR_TYP_IDN  ),
CRIM as ( SELECT * 
			from  FILTER_CRIM
				LEFT JOIN FILTER_CUST ON FILTER_CRIM.CRIM_CUST_ID = FILTER_CUST.CUST_CUST_ID  ),
NTWK as ( SELECT * 
			from  FILTER_NTWK
				INNER JOIN FILTER_REF1 ON FILTER_NTWK.NTWK_TYPE = FILTER_REF1.NTWK_TYPE_IDN 
				LEFT JOIN FILTER_NSH ON FILTER_NTWK.NTWK_ID = FILTER_NSH.NSH_NTWK_ID 
				LEFT JOIN FILTER_REF2 ON FILTER_NSH.STATUS = FILTER_REF2.NTWK_STATUS_IDN 
				LEFT JOIN FILTER_NTWK2 ON FILTER_NTWK.MERGED_MCO = FILTER_NTWK2.NTWK2_NTWK_ID 
				LEFT JOIN FADR ON FILTER_NTWK.NTWK_ID = FADR.FADR_IDN 
				LEFT JOIN LADR ON FILTER_NTWK.NTWK_ID = LADR.LADR_IDN 
				LEFT JOIN MADR ON FILTER_NTWK.NTWK_ID = MADR.MADR_IDN 
				LEFT JOIN CRIM ON FILTER_NTWK.NTWK_NUMBER = CRIM.CUST_ROLE_ID_VAL_STR   )
select * from NTWK