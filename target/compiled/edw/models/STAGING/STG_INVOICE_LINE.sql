----SRC LAYER----
WITH
SRC_LINE as ( SELECT *     from      DEV_VIEWS.BASE.INVOICE_LINE ),
SRC_R3 as ( SELECT *     from      DEV_VIEWS.BASE.REF ),
SRC_R1 as ( SELECT *     from      DEV_VIEWS.BASE.REF ),
SRC_R2 as ( SELECT *     from      DEV_VIEWS.BASE.REF ),
SRC_DIST as ( SELECT *     from      DEV_VIEWS.BASE.INVOICE_LINE_DIST ),
SRC_MOD1 as ( SELECT *     from      DEV_VIEWS.BASE.INVOICE_LINE_MOD ),
SRC_MOD2 as ( SELECT *     from      DEV_VIEWS.BASE.INVOICE_LINE_MOD ),
SRC_MOD3 as ( SELECT *     from      DEV_VIEWS.BASE.INVOICE_LINE_MOD ),
SRC_MOD4 as ( SELECT *     from      DEV_VIEWS.BASE.INVOICE_LINE_MOD )

----LOGIC LAYER---
,
LOGIC_LINE as ( SELECT 
		INVOICE_LINE_ID AS INVOICE_LINE_ID,
		INVOICE_HEADER_ID AS INVOICE_HEADER_ID,
		LINE_SEQUENCE AS LINE_SEQUENCE,
		SEQUENCE_EXTENSION AS SEQUENCE_EXTENSION,
		VERSION_NUMBER AS VERSION_NUMBER,
		PAID_MCO AS PAID_MCO,
		INT_DATE AS INT_DATE,
		cast(DATE_OF_SVC_FROM as DATE) AS DATE_OF_SVC_FROM,
		cast(DATE_OF_SVC_TO as DATE) AS DATE_OF_SVC_TO,
		TRIM(SERVICE_CODE1) AS SERVICE_CODE1,
		TRIM(SERVICE_CODE2) AS SERVICE_CODE2,
		TRIM(PLACE_OF_SVC) AS PLACE_OF_SVC,
		TRIM(STATUS_CODE) AS STATUS_CODE,
		cast(STATUS_DATE as DATE) AS STATUS_DATE,
		TRIM(LINE_STATUS1) AS LINE_STATUS1,
		cast(LINE_STATUS_DATE1 as DATE) AS LINE_STATUS_DATE1,
		TRIM(REVERSAL_IND) AS REVERSAL_IND,
		TRIM(OVERRIDE_IND) AS OVERRIDE_IND,
		TRIM(DENIED_FLAG) AS DENIED_FLAG,
		TRIM(PAYMENT_NUMBER) AS PAYMENT_NUMBER,
		cast(PAYMENT_DATE as DATE) AS PAYMENT_DATE,
		TRIM(DIAGNOSIS1) AS DIAGNOSIS1,
		TRIM(DIAGNOSIS2) AS DIAGNOSIS2,
		TRIM(DIAGNOSIS3) AS DIAGNOSIS3,
		TRIM(DIAGNOSIS4) AS DIAGNOSIS4,
		TRIM(DIAGNOSIS_CODE) AS DIAGNOSIS_CODE,
		EDI_ID AS EDI_ID,
		cast(ENTRY_DATE as DATE) AS ENTRY_DATE,
		TRIM(ENTRY_USER) AS ENTRY_USER,
		DLM AS DLM,
		TRIM(ULM) AS ULM,
		UNITS_OF_SERVICE AS UNITS_OF_SERVICE,
		PAID_UNITS AS PAID_UNITS,
		BILLED_AMOUNT AS BILLED_AMOUNT,
		CALC_AMOUNT AS CALC_AMOUNT,
		NON_COVERED_AMOUNT AS NON_COVERED_AMOUNT,
		APPROVED_AMOUNT AS APPROVED_AMOUNT,
		NTWK_BILLED_AMT AS NTWK_BILLED_AMT,
		FEE_SCHED_AMOUNT AS FEE_SCHED_AMOUNT 
				from SRC_LINE
            ),
LOGIC_R3 as ( SELECT 
		TRIM(REF_DSC) AS REF_DSC,
		TRIM(REF_IDN) AS REF_IDN,
		TRIM(REF_DGN) AS REF_DGN,
		cast(REF_EXP_DTE as DATE) AS REF_EXP_DTE 
				from SRC_R3
            ),
LOGIC_R1 as ( SELECT 
		TRIM(REF_DSC) AS REF_DSC,
		TRIM(REF_IDN) AS REF_IDN,
		TRIM(REF_DGN) AS REF_DGN,
		cast(REF_EXP_DTE as DATE) AS REF_EXP_DTE 
				from SRC_R1
            ),
LOGIC_R2 as ( SELECT 
		TRIM(REF_DSC) AS REF_DSC,
		TRIM(REF_IDN) AS REF_IDN,
		TRIM(REF_DGN) AS REF_DGN,
		cast(REF_EXP_DTE as DATE) AS REF_EXP_DTE 
				from SRC_R2
            ),
LOGIC_DIST as ( SELECT 
		INVOICE_LINE_ID AS INVOICE_LINE_ID,
		TRIM(INTEREST) AS INTEREST,
		PMT_AMT AS PMT_AMT 
				from SRC_DIST
            ),
LOGIC_MOD1 as ( SELECT 
		INVOICE_LINE_ID AS INVOICE_LINE_ID,
		SEQUENCE_NUMBER AS SEQUENCE_NUMBER,
		TRIM(MODIFIER_CODE) AS MODIFIER_CODE 
				from SRC_MOD1
            ),
LOGIC_MOD2 as ( SELECT 
		INVOICE_LINE_ID AS INVOICE_LINE_ID,
		SEQUENCE_NUMBER AS SEQUENCE_NUMBER,
		TRIM(MODIFIER_CODE) AS MODIFIER_CODE 
				from SRC_MOD2
            ),
LOGIC_MOD3 as ( SELECT 
		INVOICE_LINE_ID AS INVOICE_LINE_ID,
		SEQUENCE_NUMBER AS SEQUENCE_NUMBER,
		TRIM(MODIFIER_CODE) AS MODIFIER_CODE 
				from SRC_MOD3
            ),
LOGIC_MOD4 as ( SELECT 
		INVOICE_LINE_ID AS INVOICE_LINE_ID,
		SEQUENCE_NUMBER AS SEQUENCE_NUMBER,
		TRIM(MODIFIER_CODE) AS MODIFIER_CODE 
				from SRC_MOD4
            )
----RENAME LAYER ----
,
RENAME_LINE as ( SELECT INVOICE_LINE_ID AS INVOICE_LINE_ID,INVOICE_HEADER_ID AS INVOICE_HEADER_ID,LINE_SEQUENCE AS LINE_SEQUENCE,SEQUENCE_EXTENSION AS SEQUENCE_EXTENSION,VERSION_NUMBER AS VERSION_NUMBER,PAID_MCO AS PAID_MCO,INT_DATE AS INT_DATE,DATE_OF_SVC_FROM AS DATE_OF_SVC_FROM,DATE_OF_SVC_TO AS DATE_OF_SVC_TO,SERVICE_CODE1 AS SERVICE_CODE1,SERVICE_CODE2 AS SERVICE_CODE2,
			
			PLACE_OF_SVC AS PLACE_OF_SVC_CODE,
			
			STATUS_CODE AS LINE_STATUS_CODE,
			
			STATUS_DATE AS LINE_STATUS_DATE,
			
			LINE_STATUS1 AS ADJUDICATION_STATUS_CODE,
			
			LINE_STATUS_DATE1 AS ADJUDICATION_STATUS_DATE,REVERSAL_IND AS REVERSAL_IND,OVERRIDE_IND AS OVERRIDE_IND,DENIED_FLAG AS DENIED_FLAG,PAYMENT_NUMBER AS PAYMENT_NUMBER,PAYMENT_DATE AS PAYMENT_DATE,DIAGNOSIS1 AS DIAGNOSIS1,DIAGNOSIS2 AS DIAGNOSIS2,DIAGNOSIS3 AS DIAGNOSIS3,DIAGNOSIS4 AS DIAGNOSIS4,DIAGNOSIS_CODE AS DIAGNOSIS_CODE,EDI_ID AS EDI_ID,ENTRY_DATE AS ENTRY_DATE,ENTRY_USER AS ENTRY_USER,DLM AS DLM,ULM AS ULM,UNITS_OF_SERVICE AS UNITS_OF_SERVICE,PAID_UNITS AS PAID_UNITS,BILLED_AMOUNT AS BILLED_AMOUNT,CALC_AMOUNT AS CALC_AMOUNT,NON_COVERED_AMOUNT AS NON_COVERED_AMOUNT,APPROVED_AMOUNT AS APPROVED_AMOUNT,NTWK_BILLED_AMT AS NTWK_BILLED_AMT,FEE_SCHED_AMOUNT AS FEE_SCHED_AMOUNT 
			from      LOGIC_LINE
        ),
RENAME_R3 as ( SELECT 
			
			REF_DSC AS PLACE_OF_SVC_DESC,
			
			REF_IDN AS R3_REF_IDN,
			
			REF_DGN AS R3_REF_DGN,
			
			REF_EXP_DTE AS R3_REF_EXP_DTE 
			from      LOGIC_R3
        ),
RENAME_R1 as ( SELECT 
			
			REF_DSC AS LINE_STATUS_DESC,
			
			REF_IDN AS R1_REF_IDN,
			
			REF_DGN AS R1_REF_DGN,
			
			REF_EXP_DTE AS R1_REF_EXP_DTE 
			from      LOGIC_R1
        ),
RENAME_R2 as ( SELECT 
			
			REF_DSC AS ADJUDICATION_STATUS_DESC,
			
			REF_IDN AS R2_REF_IDN,
			
			REF_DGN AS R2_REF_DGN,
			
			REF_EXP_DTE AS R2_REF_EXP_DTE 
			from      LOGIC_R2
        ),
RENAME_DIST as ( SELECT 
			
			INVOICE_LINE_ID AS DIST_INVOICE_LINE_ID,INTEREST AS INTEREST,PMT_AMT AS PMT_AMT 
			from      LOGIC_DIST
        ),
RENAME_MOD1 as ( SELECT 
			
			INVOICE_LINE_ID AS MOD1_INVOICE_LINE_ID,
			
			SEQUENCE_NUMBER AS MOD1_SEQUENCE_NUMBER,
			
			MODIFIER_CODE AS MOD1_MODIFIER_CODE 
			from      LOGIC_MOD1
        ),
RENAME_MOD2 as ( SELECT 
			
			INVOICE_LINE_ID AS MOD2_INVOICE_LINE_ID,
			
			SEQUENCE_NUMBER AS MOD2_SEQUENCE_NUMBER,
			
			MODIFIER_CODE AS MOD2_MODIFIER_CODE 
			from      LOGIC_MOD2
        ),
RENAME_MOD3 as ( SELECT 
			
			INVOICE_LINE_ID AS MOD3_INVOICE_LINE_ID,
			
			SEQUENCE_NUMBER AS MOD3_SEQUENCE_NUMBER,
			
			MODIFIER_CODE AS MOD3_MODIFIER_CODE 
			from      LOGIC_MOD3
        ),
RENAME_MOD4 as ( SELECT 
			
			INVOICE_LINE_ID AS MOD4_INVOICE_LINE_ID,
			
			SEQUENCE_NUMBER AS MOD4_SEQUENCE_NUMBER,
			
			MODIFIER_CODE AS MOD4_MODIFIER_CODE 
			from      LOGIC_MOD4
        )
----FILTER LAYER(uses aliases)----
,

        FILTER_LINE as ( SELECT  * 
			from     RENAME_LINE 
            
        ),

        FILTER_R1 as ( SELECT  * 
			from     RENAME_R1 
            WHERE R1_REF_DGN = 'AST' and R1_REF_EXP_DTE > current_date()
        ),

        FILTER_R2 as ( SELECT  * 
			from     RENAME_R2 
            WHERE R2_REF_DGN = 'AST' and R2_REF_EXP_DTE > current_date()
        ),

        FILTER_R3 as ( SELECT  * 
			from     RENAME_R3 
            WHERE R3_REF_DGN = 'POS' and R3_REF_EXP_DTE > current_date()
        ),

        FILTER_MOD1 as ( SELECT  * 
			from     RENAME_MOD1 
            WHERE MOD1_SEQUENCE_NUMBER = 1
        ),

        FILTER_MOD2 as ( SELECT  * 
			from     RENAME_MOD2 
            WHERE MOD2_SEQUENCE_NUMBER = 2
        ),

        FILTER_MOD3 as ( SELECT  * 
			from     RENAME_MOD3 
            WHERE MOD3_SEQUENCE_NUMBER = 3
        ),

        FILTER_MOD4 as ( SELECT  * 
			from     RENAME_MOD4 
            WHERE MOD4_SEQUENCE_NUMBER = 4
        ),

        FILTER_DIST as ( SELECT  * 
			from     RENAME_DIST 
            WHERE INTEREST = 'Y'
        )
----JOIN LAYER----
,
LINE as ( SELECT * 
			from  FILTER_LINE
				LEFT JOIN FILTER_R1 ON FILTER_LINE.LINE_STATUS_CODE = FILTER_R1.R1_REF_IDN 
				LEFT JOIN FILTER_R2 ON FILTER_LINE.ADJUDICATION_STATUS_CODE = FILTER_R2.R2_REF_IDN 
				LEFT JOIN FILTER_R3 ON FILTER_LINE.PLACE_OF_SVC_CODE = FILTER_R3.R3_REF_IDN 
				LEFT JOIN FILTER_MOD1 ON FILTER_LINE.INVOICE_LINE_ID = FILTER_MOD1.MOD1_INVOICE_LINE_ID 
				LEFT JOIN FILTER_MOD2 ON FILTER_LINE.INVOICE_LINE_ID = FILTER_MOD2.MOD2_INVOICE_LINE_ID 
				LEFT JOIN FILTER_MOD3 ON FILTER_LINE.INVOICE_LINE_ID = FILTER_MOD3.MOD3_INVOICE_LINE_ID 
				LEFT JOIN FILTER_MOD4 ON FILTER_LINE.INVOICE_LINE_ID = FILTER_MOD4.MOD4_INVOICE_LINE_ID 
				LEFT JOIN FILTER_DIST ON FILTER_LINE.INVOICE_LINE_ID = FILTER_DIST.DIST_INVOICE_LINE_ID  ),
-- ETL LAYER ----
ETL AS (
     select INVOICE_LINE_ID
,INVOICE_HEADER_ID
,CAST(LINE_SEQUENCE AS INTEGER) AS LINE_SEQUENCE
,CAST(SEQUENCE_EXTENSION AS INTEGER) AS SEQUENCE_EXTENSION
,CAST(VERSION_NUMBER AS INTEGER) AS VERSION_NUMBER
,PAID_MCO
,CAST(INT_DATE AS DATE) AS INT_DATE
,DATE_OF_SVC_FROM
,DATE_OF_SVC_TO
,SERVICE_CODE1
,SERVICE_CODE2
,PLACE_OF_SVC_CODE
,PLACE_OF_SVC_DESC
,LINE_STATUS_CODE
,LINE_STATUS_DESC
,LINE_STATUS_DATE
,ADJUDICATION_STATUS_CODE
,ADJUDICATION_STATUS_DESC
,ADJUDICATION_STATUS_DATE
,REVERSAL_IND
,OVERRIDE_IND
,DENIED_FLAG
,PAYMENT_NUMBER
,PAYMENT_DATE
,DIAGNOSIS1
,DIAGNOSIS2
,DIAGNOSIS3
,DIAGNOSIS4
,DIAGNOSIS_CODE
,EDI_ID
,ENTRY_DATE
,ENTRY_USER
,DLM
,ULM
,CAST(UNITS_OF_SERVICE AS NUMERIC(22,2)) AS UNITS_OF_SERVICE
,CAST(PAID_UNITS AS NUMERIC(19,2)) AS PAID_UNITS
,CAST(BILLED_AMOUNT AS NUMERIC(9,2)) AS BILLED_AMOUNT
,CAST(CALC_AMOUNT AS NUMERIC(12,2)) AS CALC_AMOUNT
,CAST(NON_COVERED_AMOUNT  AS NUMERIC(9,2)) AS NON_COVERED_AMOUNT
,CAST(APPROVED_AMOUNT AS NUMERIC(9,2)) AS APPROVED_AMOUNT
,CAST(NTWK_BILLED_AMT AS NUMERIC(9,2)) AS NTWK_BILLED_AMT
,CAST(FEE_SCHED_AMOUNT AS NUMERIC(9,2)) AS FEE_SCHED_AMOUNT
,DIST_INVOICE_LINE_ID
,INTEREST
,CAST(PMT_AMT AS NUMERIC(12,2))	AS PMT_AMT
,R1_REF_IDN
,R1_REF_DGN
,R1_REF_EXP_DTE
,R2_REF_IDN
,R2_REF_DGN
,R2_REF_EXP_DTE
,R3_REF_IDN
,R3_REF_DGN
,R3_REF_EXP_DTE
,MOD1_INVOICE_LINE_ID
,MOD1_SEQUENCE_NUMBER
,MOD1_MODIFIER_CODE
,MOD2_INVOICE_LINE_ID
,MOD2_SEQUENCE_NUMBER
,MOD2_MODIFIER_CODE
,MOD3_INVOICE_LINE_ID
,MOD3_SEQUENCE_NUMBER
,MOD3_MODIFIER_CODE
,MOD4_INVOICE_LINE_ID
,MOD4_SEQUENCE_NUMBER
,MOD4_MODIFIER_CODE
 from LINE)
 SELECT * FROM ETL