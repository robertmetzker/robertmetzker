

      create or replace  table DEV_EDW.EDW_STAGING_DIM.DIM_DOCUMENT_DETAIL  as
      (

 WITH  SCD AS ( 
	SELECT  UNIQUE_ID_KEY,
     last_value(UNIQUE_ID_KEY) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as DOCUMENT_DETAIL_HKEY, 
     last_value(DOCUMENT_STATE_CODE) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as DOCUMENT_STATE_CODE, 
     last_value(DOCUMENT_STATE_DESC) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as DOCUMENT_STATE_DESC, 
     last_value(DOCUMENT_STATUS_CODE) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as DOCUMENT_STATUS_CODE, 
     last_value(DOCUMENT_STATUS_DESC) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as DOCUMENT_STATUS_DESC, 
     last_value(DOCUMENT_SYSTEM_GENERATED_IND) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as DOCUMENT_SYSTEM_GENERATED_IND, 
     last_value(DOCUMENT_TYPE_VERSION_DUPLICATE_IND) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as DOCUMENT_TYPE_VERSION_DUPLICATE_IND, 
     last_value(DOCUMENT_TYPE_VERSION_SYSTEM_GENERATED_IND) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as DOCUMENT_TYPE_VERSION_SYSTEM_GENERATED_IND, 
     last_value(DOCUMENT_TYPE_VERSION_SYSTEM_GENERATED_ONLY_IND) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as DOCUMENT_TYPE_VERSION_SYSTEM_GENERATED_ONLY_IND, 
     last_value(DOCUMENT_TYPE_VERSION_CANCEL_POLICY_IND) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as DOCUMENT_TYPE_VERSION_CANCEL_POLICY_IND, 
     last_value(DOCUMENT_TYPE_VERSION_PRE_PRINT_ENCLOSURE_IND) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as DOCUMENT_TYPE_VERSION_PRE_PRINT_ENCLOSURE_IND, 
     last_value(DOCUMENT_BATCH_PRINT_IND) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as DOCUMENT_BATCH_PRINT_IND, 
     last_value(DOCUMENT_USER_CAN_DELETE_IND) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as DOCUMENT_USER_CAN_DELETE_IND, 
     last_value(DOCUMENT_MULTIPLE_RENDERED_VERSION_IND) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as DOCUMENT_MULTIPLE_RENDERED_VERSION_IND, 
     last_value(DOCUMENT_PRINT_DUPLEX_IND) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as DOCUMENT_PRINT_DUPLEX_IND
     
	FROM EDW_STAGING.DIM_DOCUMENT_DETAIL_SCDALL_STEP2),

------------- ETL LAYER -----------

ETL AS (select 
 UNIQUE_ID_KEY AS DOCUMENT_DETAIL_HKEY
,UNIQUE_ID_KEY
,DOCUMENT_STATE_CODE
,DOCUMENT_STATE_DESC
,DOCUMENT_STATUS_CODE
,DOCUMENT_STATUS_DESC
,DOCUMENT_SYSTEM_GENERATED_IND
,DOCUMENT_TYPE_VERSION_DUPLICATE_IND
,DOCUMENT_TYPE_VERSION_SYSTEM_GENERATED_IND
,DOCUMENT_TYPE_VERSION_SYSTEM_GENERATED_ONLY_IND
,DOCUMENT_TYPE_VERSION_CANCEL_POLICY_IND
,DOCUMENT_TYPE_VERSION_PRE_PRINT_ENCLOSURE_IND
,DOCUMENT_BATCH_PRINT_IND
,DOCUMENT_USER_CAN_DELETE_IND
,DOCUMENT_MULTIPLE_RENDERED_VERSION_IND
,DOCUMENT_PRINT_DUPLEX_IND
, CURRENT_TIMESTAMP AS LOAD_DATETIME
, try_to_TIMESTAMP('Invalid')  AS UPDATE_DATETIME
, 'CORESUITE' AS PRIMARY_SOURCE_SYSTEM
 from SCD )
SELECT * FROM ETL
      );
    