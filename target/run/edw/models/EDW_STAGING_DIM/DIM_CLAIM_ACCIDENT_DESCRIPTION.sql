

      create or replace  table DEV_EDW.EDW_STAGING_DIM.DIM_CLAIM_ACCIDENT_DESCRIPTION  as
      (

 WITH  SCD AS ( 
	SELECT  UNIQUE_ID_KEY,
     last_value(CLAIM_ACCIDENT_DESC_HKEY) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as CLAIM_ACCIDENT_DESC_HKEY, 
     last_value(ACCIDENT_DESCRIPTION_TEXT) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as ACCIDENT_DESCRIPTION_TEXT, 
     last_value(JOB_TITLE) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as JOB_TITLE


     
	FROM EDW_STAGING.DIM_CLAIM_ACCIDENT_DESCRIPTION_SCDALL_STEP2)

-- ETL LAYER --
 , ETL AS (
 select 
  CLAIM_ACCIDENT_DESC_HKEY
, UNIQUE_ID_KEY
, ACCIDENT_DESCRIPTION_TEXT
, JOB_TITLE
, CURRENT_TIMESTAMP AS LOAD_DATETIME
, try_to_TIMESTAMP('Invalid')  AS UPDATE_DATETIME
, 'CORESUITE' AS PRIMARY_SOURCE_SYSTEM

 from SCD )
 
SELECT * FROM ETL
      );
    