

      create or replace  table DEV_EDW.EDW_STAGING_DIM.DIM_COVERED_INDIVIDUAL_CUSTOMER  as
      (

 WITH  SCD AS ( 
	SELECT  UNIQUE_ID_KEY,
     last_value(COVERED_INDIVIDUAL_CUSTOMER_HKEY) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as COVERED_INDIVIDUAL_CUSTOMER_HKEY, 
     last_value(COVERED_INDIVIDUAL_CUSTOMER_NUMBER) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as COVERED_INDIVIDUAL_CUSTOMER_NUMBER, 
     last_value(COVERED_INDIVIDUAL_NAME) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as COVERED_INDIVIDUAL_NAME, 
     last_value(COVERED_INDIVIDUAL_FIRST_NAME) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as COVERED_INDIVIDUAL_FIRST_NAME, 
     last_value(COVERED_INDIVIDUAL_LAST_NAME) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as COVERED_INDIVIDUAL_LAST_NAME, 
     last_value(MAILING_STREET_ADDRESS_1) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as MAILING_STREET_ADDRESS_1, 
     last_value(MAILING_STREET_ADDRESS_2) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as MAILING_STREET_ADDRESS_2, 
     last_value(MAILING_ADDRESS_CITY_NAME) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as MAILING_ADDRESS_CITY_NAME, 
     last_value(MAILING_ADDRESS_STATE_CODE) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as MAILING_ADDRESS_STATE_CODE, 
     last_value(MAILING_ADDRESS_STATE_NAME) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as MAILING_ADDRESS_STATE_NAME, 
     last_value(MAILING_ADDRESS_COUNTY_NAME) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as MAILING_ADDRESS_COUNTY_NAME, 
     last_value(MAILING_ADDRESS_COUNTRY_NAME) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as MAILING_ADDRESS_COUNTRY_NAME, 
     last_value(MAILING_ADDRESS_POSTAL_CODE) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as MAILING_ADDRESS_POSTAL_CODE, 
     last_value(MAILING_FORMATTED_ADDRESS_POSTAL_CODE) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as MAILING_FORMATTED_ADDRESS_POSTAL_CODE, 
     last_value(MAILING_FORMATTED_ADDRESS_ZIP_CODE) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as MAILING_FORMATTED_ADDRESS_ZIP_CODE, 
     last_value(MAILING_FORMATTED_ADDRESS_ZIP4_CODE) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as MAILING_FORMATTED_ADDRESS_ZIP4_CODE, 
     last_value(MAILING_ADDRESS_COMMENT_TEXT) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as MAILING_ADDRESS_COMMENT_TEXT, 
     last_value(MAILING_ADDRESS_VALIDATED_IND) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as MAILING_ADDRESS_VALIDATED_IND, 
     last_value(PHYSICAL_STREET_ADDRESS_1) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as PHYSICAL_STREET_ADDRESS_1, 
     last_value(PHYSICAL_STREET_ADDRESS_2) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as PHYSICAL_STREET_ADDRESS_2, 
     last_value(PHYSICAL_ADDRESS_CITY_NAME) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as PHYSICAL_ADDRESS_CITY_NAME, 
     last_value(PHYSICAL_ADDRESS_STATE_CODE) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as PHYSICAL_ADDRESS_STATE_CODE, 
     last_value(PHYSICAL_ADDRESS_STATE_NAME) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as PHYSICAL_ADDRESS_STATE_NAME, 
     last_value(PHYSICAL_ADDRESS_COUNTY_NAME) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as PHYSICAL_ADDRESS_COUNTY_NAME, 
     last_value(PHYSICAL_ADDRESS_COUNTRY_NAME) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as PHYSICAL_ADDRESS_COUNTRY_NAME, 
     last_value(PHYSICAL_ADDRESS_POSTAL_CODE) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as PHYSICAL_ADDRESS_POSTAL_CODE, 
     last_value(PHYSICAL_FORMATTED_ADDRESS_POSTAL_CODE) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as PHYSICAL_FORMATTED_ADDRESS_POSTAL_CODE, 
     last_value(PHYSICAL_FORMATTED_ADDRESS_ZIP_CODE) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as PHYSICAL_FORMATTED_ADDRESS_ZIP_CODE, 
     last_value(PHYSICAL_FORMATTED_ADDRESS_ZIP4_CODE) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as PHYSICAL_FORMATTED_ADDRESS_ZIP4_CODE, 
     last_value(PHYSICAL_ADDRESS_COMMENT_TEXT) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as PHYSICAL_ADDRESS_COMMENT_TEXT, 
     last_value(PHYSICAL_ADDRESS_VALIDATED_IND) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as PHYSICAL_ADDRESS_VALIDATED_IND, 
     last_value(DOCUMENT_BLOCK_IND) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as DOCUMENT_BLOCK_IND, 
     last_value(HOME_PHONE_NUMBER) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as HOME_PHONE_NUMBER, 
     last_value(CELL_PHONE_NUMBER) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as CELL_PHONE_NUMBER, 
     last_value(EMAIL_ADDRESS) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as EMAIL_ADDRESS,
     last_value(TAX_ID_NUMBER) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as TAX_ID_NUMBER            
     
	FROM EDW_STAGING.DIM_COVERED_INDIVIDUAL_CUSTOMER_SCDALL_STEP2),
ETL AS (
SELECT 
  COVERED_INDIVIDUAL_CUSTOMER_HKEY
, UNIQUE_ID_KEY
, COVERED_INDIVIDUAL_CUSTOMER_NUMBER
, COVERED_INDIVIDUAL_NAME
, COVERED_INDIVIDUAL_FIRST_NAME
, COVERED_INDIVIDUAL_LAST_NAME
, MAILING_STREET_ADDRESS_1
, MAILING_STREET_ADDRESS_2
, MAILING_ADDRESS_CITY_NAME
, MAILING_ADDRESS_STATE_CODE
, MAILING_ADDRESS_STATE_NAME
, MAILING_ADDRESS_COUNTY_NAME
, MAILING_ADDRESS_COUNTRY_NAME
, MAILING_ADDRESS_POSTAL_CODE
, MAILING_FORMATTED_ADDRESS_POSTAL_CODE
, MAILING_FORMATTED_ADDRESS_ZIP_CODE
, MAILING_FORMATTED_ADDRESS_ZIP4_CODE
, MAILING_ADDRESS_COMMENT_TEXT
, MAILING_ADDRESS_VALIDATED_IND
, PHYSICAL_STREET_ADDRESS_1
, PHYSICAL_STREET_ADDRESS_2
, PHYSICAL_ADDRESS_CITY_NAME
, PHYSICAL_ADDRESS_STATE_CODE
, PHYSICAL_ADDRESS_STATE_NAME
, PHYSICAL_ADDRESS_COUNTY_NAME
, PHYSICAL_ADDRESS_COUNTRY_NAME
, PHYSICAL_ADDRESS_POSTAL_CODE
, PHYSICAL_FORMATTED_ADDRESS_POSTAL_CODE
, PHYSICAL_FORMATTED_ADDRESS_ZIP_CODE
, PHYSICAL_FORMATTED_ADDRESS_ZIP4_CODE
, PHYSICAL_ADDRESS_COMMENT_TEXT
, PHYSICAL_ADDRESS_VALIDATED_IND
, DOCUMENT_BLOCK_IND
, HOME_PHONE_NUMBER
, CELL_PHONE_NUMBER
, EMAIL_ADDRESS
, TAX_ID_NUMBER
, CURRENT_TIMESTAMP AS  LOAD_DATETIME
, TRY_TO_TIMESTAMP('Invalid') AS UPDATE_DATETIME
, 'CORESUITE' AS PRIMARY_SOURCE_SYSTEM 
 from SCD

)
select * from ETL
      );
    