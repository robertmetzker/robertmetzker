

      create or replace  table DEV_EDW.EDW_STAGING_DIM.DIM_FINANCIAL_TRANSACTION_TYPE  as
      (

 WITH  SCD AS ( 
	SELECT  UNIQUE_ID_KEY,
  
     last_value(FINANCIAL_TRANSACTION_TYPE_ID) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as FINANCIAL_TRANSACTION_TYPE_ID, 
     last_value(FINANCIAL_TRANSACTION_TYPE_CODE) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as FINANCIAL_TRANSACTION_TYPE_CODE, 
     last_value(FINANCIAL_TRANSACTION_TYPE_DESC) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as FINANCIAL_TRANSACTION_TYPE_DESC, 
     last_value(AGREEMENT_TYPE_DESC) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as AGREEMENT_TYPE_DESC

     
	FROM EDW_STAGING.DIM_FINANCIAL_TRANSACTION_TYPE_SCDALL_STEP2),

--- ETL Layer ----

ETL AS (
    select 

    md5(cast(
    
    coalesce(cast(FINANCIAL_TRANSACTION_TYPE_ID as 
    varchar
), '')

 as 
    varchar
)) as FINANCIAL_TRANSACTION_TYPE_HKEY
   , UNIQUE_ID_KEY as UNIQUE_ID_KEY
   , FINANCIAL_TRANSACTION_TYPE_ID
   , FINANCIAL_TRANSACTION_TYPE_CODE
   , FINANCIAL_TRANSACTION_TYPE_DESC
   , AGREEMENT_TYPE_DESC
   , CURRENT_TIMESTAMP AS LOAD_DATETIME
   , try_to_TIMESTAMP('Invalid')  AS UPDATE_DATETIME
   , 'CORESUITE' AS PRIMARY_SOURCE_SYSTEM

from SCD
)

select * from ETL
      );
    