

      create or replace  table DEV_EDW.EDW_STAGING_DIM.DIM_MANUAL_CLASSIFICATION  as
      (

 WITH  SCD AS ( 
	SELECT  UNIQUE_ID_KEY,
     last_value(MANUAL_CLASS_CODE) over 
        (partition by UNIQUE_ID_KEY 
        order by dbt_updated_at 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as MANUAL_CLASS_CODE, 
     last_value(SUFFIX_DISCOUNT_IND) over 
        (partition by UNIQUE_ID_KEY 
        order by dbt_updated_at 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as SUFFIX_DISCOUNT_IND, 
     last_value(RATE_TIER_TYPE_CODE) over 
        (partition by UNIQUE_ID_KEY 
        order by dbt_updated_at 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as RATE_TIER_TYPE_CODE, 
     last_value(RATE_TIER_TYPE_DESC) over 
        (partition by UNIQUE_ID_KEY 
        order by dbt_updated_at 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as RATE_TIER_TYPE_DESC, 
 MANUAL_CLASS_SUFFIX_CODE, 
 MANUAL_CLASS_DESC, 
 MANUAL_CLASS_DESC_EFFECTIVE_DATE, 
 MANUAL_CLASS_DESC_END_DATE, 
 DBT_VALID_FROM AS EFFECTIVE_TIMESTAMP,
 DBT_VALID_TO   AS END_TIMESTAMP,
 CASE WHEN CAST(DBT_VALID_FROM AS DATE) = '1901-01-01' then CAST(DBT_VALID_FROM AS DATE)
      WHEN CAST(DBT_VALID_FROM AS DATE) <> '1901-01-01' THEN dateadd(day,1,CAST(DBT_VALID_FROM AS DATE))
    else CAST(DBT_VALID_FROM AS DATE) end as EFFECTIVE_DATE,
 CAST(DBT_VALID_TO AS DATE) as END_DATE, 
 CASE WHEN DBT_VALID_TO IS NULL THEN 'Y' ELSE 'N' END AS CURRENT_INDICATOR
     
	FROM EDW_STAGING.DIM_MANUAL_CLASSIFICATION_SCDALL_STEP2)

 
---- ETL LAYER ----
, ETL AS (select 
  md5(cast(
    
    coalesce(cast(MANUAL_CLASS_CODE as 
    varchar
), '') || '-' || coalesce(cast(MANUAL_CLASS_SUFFIX_CODE as 
    varchar
), '') || '-' || coalesce(cast(EFFECTIVE_DATE as 
    varchar
), '')

 as 
    varchar
)) as MANUAL_CLASS_HKEY
, UNIQUE_ID_KEY
, MANUAL_CLASS_CODE
, MANUAL_CLASS_SUFFIX_CODE
, MANUAL_CLASS_DESC
, SUFFIX_DISCOUNT_IND
, MANUAL_CLASS_DESC_EFFECTIVE_DATE
, MANUAL_CLASS_DESC_END_DATE
, RATE_TIER_TYPE_CODE
, RATE_TIER_TYPE_DESC
, CASE WHEN END_DATE IS NULL THEN 'Y' ELSE 'N' END AS CURRENT_RECORD_IND
, EFFECTIVE_DATE AS RECORD_EFFECTIVE_DATE
, END_DATE AS RECORD_END_DATE
, EFFECTIVE_TIMESTAMP AS LOAD_DATETIME
, END_TIMESTAMP AS UPDATE_DATETIME
, 'CORESUITE' AS PRIMARY_SOURCE_SYSTEM
 from SCD )

 SELECT * FROM ETL
      );
    