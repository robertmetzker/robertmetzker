

      create or replace  table DEV_EDW.EDW_STAGING_DIM.DIM_WRITTEN_PREMIUM_ELEMENT  as
      (

 WITH  SCD AS ( 
	SELECT  UNIQUE_ID_KEY,
     last_value(WRITTEN_PREMIUM_ELEMENT_CODE) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as WRITTEN_PREMIUM_ELEMENT_CODE, 
     last_value(WRITTEN_PREMIUM_ELEMENT_SUFFIX_CODE) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as WRITTEN_PREMIUM_ELEMENT_SUFFIX_CODE, 
     last_value(WRITTEN_PREMIUM_ELEMENT_DESC) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as WRITTEN_PREMIUM_ELEMENT_DESC, 
     last_value(WRITTEN_PREMIUM_ELEMENT_EFFECTIVE_DATE) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as WRITTEN_PREMIUM_ELEMENT_EFFECTIVE_DATE, 
     last_value(WRITTEN_PREMIUM_ELEMENT_END_DATE) over 
        (partition by UNIQUE_ID_KEY 
        order by UNIQUE_ID_KEY 
            ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
            ) as WRITTEN_PREMIUM_ELEMENT_END_DATE
     
	FROM EDW_STAGING.DIM_WRITTEN_PREMIUM_ELEMENT_SCDALL_STEP2)

----ETL LAYER----
,
ETL as ( SELECT 
              md5(cast(
    
    coalesce(cast(WRITTEN_PREMIUM_ELEMENT_CODE as 
    varchar
), '') || '-' || coalesce(cast(WRITTEN_PREMIUM_ELEMENT_SUFFIX_CODE as 
    varchar
), '') || '-' || coalesce(cast(WRITTEN_PREMIUM_ELEMENT_EFFECTIVE_DATE as 
    varchar
), '')

 as 
    varchar
)) as WRITTEN_PREMIUM_ELEMENT_HKEY
            , UNIQUE_ID_KEY
            , WRITTEN_PREMIUM_ELEMENT_CODE
            , WRITTEN_PREMIUM_ELEMENT_SUFFIX_CODE
            , WRITTEN_PREMIUM_ELEMENT_DESC
            , WRITTEN_PREMIUM_ELEMENT_EFFECTIVE_DATE
            , WRITTEN_PREMIUM_ELEMENT_END_DATE
	        , CURRENT_TIMESTAMP AS  LOAD_DATETIME
            , TRY_TO_TIMESTAMP('Invalid') AS UPDATE_DATETIME
            , 'CORESUITE' AS PRIMARY_SOURCE_SYSTEM 
    from SCD
)

SELECT * FROM ETL
      );
    