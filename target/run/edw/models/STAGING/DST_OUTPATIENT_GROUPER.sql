

      create or replace  table DEV_EDW.STAGING.DST_OUTPATIENT_GROUPER  as
      (----SRC LAYER----
WITH
SRC_APC as ( SELECT *     from      STAGING.STG_INVOICE_LINE_APC ),
SRC_STATUS as ( SELECT *     from      STAGING.STG_APC_STATUS_INDICATOR ),
SRC_RETURN as ( SELECT *     from      STAGING.STG_OPPS_RETURN ),
SRC_OPPS as ( SELECT *     from      STAGING.STG_OPPS_CODE ),
SRC_PAY as ( SELECT *     from      STAGING.STG_OPPS_PAYMENT_METHOD ),
SRC_DISCOUNT as ( SELECT *     from      STAGING.STG_APC_DISCOUNTING_FRACTION ),
SRC_ADJUST as ( SELECT *     from      STAGING.STG_APC_COMPOSITE_ADJUSTMENT ),
SRC_PAYIN as ( SELECT *     from      STAGING.STG_APC_PAYMENT_INDICATOR ),
SRC_PACK as ( SELECT *     from      STAGING.STG_APC_PACKAGING ),
SRC_PAYADJ as ( SELECT *     from      STAGING.STG_APC_PAYMENT_ADJUSTMENT )
----LOGIC LAYER----
,
LOGIC_APC as ( SELECT DISTINCT
		STATUS AS STATUS,
		NON_OPPS_BILL_TYPE AS NON_OPPS_BILL_TYPE,
		OPPS_FLAG AS OPPS_FLAG,
		PAYMENT_METHOD AS PAYMENT_METHOD,
		DISCOUNT AS DISCOUNT,
		COMPOSITE_ADJUSTMENT AS COMPOSITE_ADJUSTMENT,
		PAYMENT_INDICATOR AS PAYMENT_INDICATOR,
		PACKAGING AS PACKAGING,
		PAYMENT_ADJUSTMENT AS PAYMENT_ADJUSTMENT 
				from SRC_APC
            ),
LOGIC_STATUS as ( SELECT 
		DESCRIPTION AS DESCRIPTION,
		APC_STATUS_INDICATOR_CODE AS APC_STATUS_INDICATOR_CODE 
				from SRC_STATUS
            ),
LOGIC_RETURN as ( SELECT 
		DESCRIPTION AS DESCRIPTION,
		OPPS_RETURN_CODE AS OPPS_RETURN_CODE 
				from SRC_RETURN
            ),
LOGIC_OPPS as ( SELECT 
		DESCRIPTION AS DESCRIPTION,
		OPPS_CODE AS OPPS_CODE 
				from SRC_OPPS
            ),
LOGIC_PAY as ( SELECT 
		DESCRIPTION AS DESCRIPTION,
		OPPS_PAYMENT_METHOD_CODE AS OPPS_PAYMENT_METHOD_CODE 
				from SRC_PAY
            ),
LOGIC_DISCOUNT as ( SELECT 
		DESCRIPTION AS DESCRIPTION,
		APC_DISCOUNTING_FRACTION_CODE AS APC_DISCOUNTING_FRACTION_CODE 
				from SRC_DISCOUNT
            ),
LOGIC_ADJUST as ( SELECT 
		DESCRIPTION AS DESCRIPTION,
		APC_COMPOSITE_ADJUSTMENT_CODE AS APC_COMPOSITE_ADJUSTMENT_CODE 
				from SRC_ADJUST
            ),
LOGIC_PAYIN as ( SELECT 
		DESCRIPTION AS DESCRIPTION,
		APC_PAYMENT_INDICATOR_CODE AS APC_PAYMENT_INDICATOR_CODE 
				from SRC_PAYIN
            ),
LOGIC_PACK as ( SELECT 
		DESCRIPTION AS DESCRIPTION,
		APC_PACKAGING_CODE AS APC_PACKAGING_CODE 
				from SRC_PACK
            ),
LOGIC_PAYADJ as ( SELECT 
		DESCRIPTION AS DESCRIPTION,
		APC_PAYMENT_ADJUSTMENT_CODE AS APC_PAYMENT_ADJUSTMENT_CODE 
				from SRC_PAYADJ
            )
----RENAME LAYER ----
,
RENAME_APC as ( SELECT STATUS AS STATUS,NON_OPPS_BILL_TYPE AS NON_OPPS_BILL_TYPE,OPPS_FLAG AS OPPS_FLAG,PAYMENT_METHOD AS PAYMENT_METHOD,DISCOUNT AS DISCOUNT,COMPOSITE_ADJUSTMENT AS COMPOSITE_ADJUSTMENT,PAYMENT_INDICATOR AS PAYMENT_INDICATOR,PACKAGING AS PACKAGING,PAYMENT_ADJUSTMENT AS PAYMENT_ADJUSTMENT 
			from      LOGIC_APC
        ),
RENAME_STATUS as ( SELECT 
			
			DESCRIPTION AS APC_STATUS_INDICATOR_DESC,APC_STATUS_INDICATOR_CODE AS APC_STATUS_INDICATOR_CODE 
			from      LOGIC_STATUS
        ),
RENAME_RETURN as ( SELECT 
			
			DESCRIPTION AS OPPS_RETURN_DESC,OPPS_RETURN_CODE AS OPPS_RETURN_CODE 
			from      LOGIC_RETURN
        ),
RENAME_OPPS as ( SELECT 
			
			DESCRIPTION AS OPPS_DESC,OPPS_CODE AS OPPS_CODE 
			from      LOGIC_OPPS
        ),
RENAME_PAY as ( SELECT 
			
			DESCRIPTION AS OPPS_PAYMENT_METHOD_DESC,OPPS_PAYMENT_METHOD_CODE AS OPPS_PAYMENT_METHOD_CODE 
			from      LOGIC_PAY
        ),
RENAME_DISCOUNT as ( SELECT 
			
			DESCRIPTION AS APC_DISCOUNTING_FRACTION_DESC,APC_DISCOUNTING_FRACTION_CODE AS APC_DISCOUNTING_FRACTION_CODE 
			from      LOGIC_DISCOUNT
        ),
RENAME_ADJUST as ( SELECT 
			
			DESCRIPTION AS APC_COMPOSITE_ADJUSTMENT_DESC,APC_COMPOSITE_ADJUSTMENT_CODE AS APC_COMPOSITE_ADJUSTMENT_CODE 
			from      LOGIC_ADJUST
        ),
RENAME_PAYIN as ( SELECT 
			
			DESCRIPTION AS APC_PAYMENT_INDICATOR_DESC,APC_PAYMENT_INDICATOR_CODE AS APC_PAYMENT_INDICATOR_CODE 
			from      LOGIC_PAYIN
        ),
RENAME_PACK as ( SELECT 
			
			DESCRIPTION AS APC_PACKAGING_DESC,APC_PACKAGING_CODE AS APC_PACKAGING_CODE 
			from      LOGIC_PACK
        ),
RENAME_PAYADJ as ( SELECT 
			
			DESCRIPTION AS APC_PAYMENT_ADJUSTMENT_DESC,APC_PAYMENT_ADJUSTMENT_CODE AS APC_PAYMENT_ADJUSTMENT_CODE 
			from      LOGIC_PAYADJ
        )
----FILTER LAYER(uses aliases)----
,

        FILTER_APC as ( SELECT  * 
			from     RENAME_APC 
            
        ),

        FILTER_STATUS as ( SELECT  * 
			from     RENAME_STATUS 
            
        ),

        FILTER_RETURN as ( SELECT  * 
			from     RENAME_RETURN 
            
        ),

        FILTER_OPPS as ( SELECT  * 
			from     RENAME_OPPS 
            
        ),

        FILTER_PAY as ( SELECT  * 
			from     RENAME_PAY 
            
        ),

        FILTER_DISCOUNT as ( SELECT  * 
			from     RENAME_DISCOUNT 
            
        ),

        FILTER_ADJUST as ( SELECT  * 
			from     RENAME_ADJUST 
            
        ),

        FILTER_PAYIN as ( SELECT  * 
			from     RENAME_PAYIN 
            
        ),

        FILTER_PACK as ( SELECT  * 
			from     RENAME_PACK 
            
        ),

        FILTER_PAYADJ as ( SELECT  * 
			from     RENAME_PAYADJ 
            
        )
----JOIN LAYER----
,
APC as ( SELECT * 
			from  FILTER_APC
				LEFT JOIN FILTER_STATUS ON FILTER_APC.STATUS = FILTER_STATUS.APC_STATUS_INDICATOR_CODE 
				LEFT JOIN FILTER_RETURN ON FILTER_APC.NON_OPPS_BILL_TYPE = FILTER_RETURN.OPPS_RETURN_CODE 
				LEFT JOIN FILTER_OPPS ON FILTER_APC.OPPS_FLAG = FILTER_OPPS.OPPS_CODE 
				LEFT JOIN FILTER_PAY ON FILTER_APC.PAYMENT_METHOD = FILTER_PAY.OPPS_PAYMENT_METHOD_CODE 
				LEFT JOIN FILTER_DISCOUNT ON FILTER_APC.DISCOUNT = FILTER_DISCOUNT.APC_DISCOUNTING_FRACTION_CODE 
				LEFT JOIN FILTER_ADJUST ON FILTER_APC.COMPOSITE_ADJUSTMENT = FILTER_ADJUST.APC_COMPOSITE_ADJUSTMENT_CODE 
				LEFT JOIN FILTER_PAYIN ON FILTER_APC.PAYMENT_INDICATOR = FILTER_PAYIN.APC_PAYMENT_INDICATOR_CODE 
				LEFT JOIN FILTER_PACK ON FILTER_APC.PACKAGING = FILTER_PACK.APC_PACKAGING_CODE 
				LEFT JOIN FILTER_PAYADJ ON FILTER_APC.PAYMENT_ADJUSTMENT = FILTER_PAYADJ.APC_PAYMENT_ADJUSTMENT_CODE  )
,
-----ETL LAYER----
ETL1 as (
 SELECT md5(cast(
    
    coalesce(cast(STATUS as 
    varchar
), '') || '-' || coalesce(cast(NON_OPPS_BILL_TYPE as 
    varchar
), '') || '-' || coalesce(cast(OPPS_FLAG as 
    varchar
), '') || '-' || coalesce(cast(PAYMENT_METHOD as 
    varchar
), '') || '-' || coalesce(cast(DISCOUNT as 
    varchar
), '') || '-' || coalesce(cast(COMPOSITE_ADJUSTMENT as 
    varchar
), '') || '-' || coalesce(cast(PAYMENT_INDICATOR as 
    varchar
), '') || '-' || coalesce(cast(PACKAGING as 
    varchar
), '') || '-' || coalesce(cast(PAYMENT_ADJUSTMENT as 
    varchar
), '')

 as 
    varchar
)) as UNIQUE_ID_KEY, * FROM APC)
 select * from ETL1
      );
    