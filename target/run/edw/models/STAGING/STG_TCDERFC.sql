

      create or replace  table DEV_EDW.STAGING.STG_TCDERFC  as
      (----SRC LAYER----
WITH
SRC_RFC as ( SELECT *     from      DEV_VIEWS.DBDWQP00.TCDERFC ),
SRC_SAC as ( SELECT *     from      DEV_VIEWS.DBDWQP00.TCDESAC )
//SRC_RFC as ( SELECT *     from      TCDERFC),
//SRC_SAC as ( SELECT *     from      TCDESAC)
----LOGIC LAYER----
,
LOGIC_RFC as ( SELECT 
		TRIM(ICD_CODE) AS ICD_CODE,
		TRIM(ICDV_CODE) AS ICDV_CODE,
		cast(EM_RFRL_BGNG_DATE as DATE) AS EM_RFRL_BGNG_DATE,
		UPPER(TRIM(EM_RFRL_SFDSP_CODE)) AS EM_RFRL_SFDSP_CODE,
		UPPER(TRIM(EM_RFRL_SFDSP_TEXT)) AS EM_RFRL_SFDSP_TEXT,
		UPPER(TRIM(CRNT_EM_RFRL_FLAG)) AS CRNT_EM_RFRL_FLAG,
		cast(EM_RFRL_ENDNG_DATE as DATE) AS EM_RFRL_ENDNG_DATE 
				from SRC_RFC
            ),
LOGIC_SAC as ( SELECT 
		UPPER(TRIM(EM_RFRL_SFDSP_DESC)) AS EM_RFRL_SFDSP_DESC,
		UPPER(TRIM(EM_RFRL_SFDSP_CODE)) AS EM_RFRL_SFDSP_CODE 
				from SRC_SAC
            )
----RENAME LAYER ----
,
RENAME_RFC as ( SELECT ICD_CODE AS ICD_CODE,ICDV_CODE AS ICDV_CODE,EM_RFRL_BGNG_DATE AS EM_RFRL_BGNG_DATE,EM_RFRL_SFDSP_CODE AS EM_RFRL_SFDSP_CODE,EM_RFRL_SFDSP_TEXT AS EM_RFRL_SFDSP_TEXT,CRNT_EM_RFRL_FLAG AS CRNT_EM_RFRL_FLAG,EM_RFRL_ENDNG_DATE AS EM_RFRL_ENDNG_DATE 
			from      LOGIC_RFC
        ),
RENAME_SAC as ( SELECT EM_RFRL_SFDSP_DESC AS EM_RFRL_SFDSP_DESC,
			
			EM_RFRL_SFDSP_CODE AS SAC_EM_RFRL_SFDSP_CODE 
			from      LOGIC_SAC
        )
----FILTER LAYER(uses aliases)----
,

        FILTER_RFC as ( SELECT  * 
			from     RENAME_RFC 
            
        ),

        FILTER_SAC as ( SELECT  * 
			from     RENAME_SAC 
            
        )
----JOIN LAYER----
,
RFC as ( SELECT * 
			from  FILTER_RFC
				LEFT JOIN FILTER_SAC ON FILTER_RFC.EM_RFRL_SFDSP_CODE = FILTER_SAC.SAC_EM_RFRL_SFDSP_CODE  )
select * from RFC
      );
    