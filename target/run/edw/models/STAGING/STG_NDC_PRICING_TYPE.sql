

      create or replace  table DEV_EDW.STAGING.STG_NDC_PRICING_TYPE  as
      (----SRC LAYER----
WITH
SRC_NDC_PRCNG as ( SELECT *     from      DEV_VIEWS.DBEABP00.TEANDVP ),
SRC_PRCNG_TYP as ( SELECT *     from      DEV_VIEWS.DBEABP00.TEANDPT ),
----LOGIC LAYER----
LOGIC_NDC_PRCNG as ( SELECT 
	CASE WHEN TRIM(FK_NDCL_CODE)='' THEN NULL ELSE TRIM(FK_NDCL_CODE)
        END AS FK_NDCL_CODE,
	CASE WHEN TRIM(FK_DCPR_CODE)='' THEN NULL ELSE TRIM(FK_DCPR_CODE)
        END AS FK_DCPR_CODE,
	CASE WHEN TRIM(FK_NDCP_CODE)='' THEN NULL ELSE TRIM(FK_NDCP_CODE)
        END AS FK_NDCP_CODE,
		FK_NDCV_NMBR AS FK_NDCV_NMBR,
	CASE WHEN TRIM(FK_NDPT_CODE)='' THEN NULL ELSE TRIM(FK_NDPT_CODE)
        END AS FK_NDPT_CODE,
		AMT AS AMT,
		cast(EFCTV_DATE as DATE) AS EFCTV_DATE,
		cast(ENDNG_DATE as DATE) AS ENDNG_DATE,
		NDVP_CRT_DTTM AS NDVP_CRT_DTTM,
	CASE WHEN TRIM(CRT_USER_CODE)='' THEN NULL ELSE TRIM(CRT_USER_CODE)
        END AS CRT_USER_CODE,
	CASE WHEN TRIM(CRT_PRGRM_NAME)='' THEN NULL ELSE TRIM(CRT_PRGRM_NAME)
        END AS CRT_PRGRM_NAME,
	CASE WHEN TRIM(DCTVT_USER_CODE)='' THEN NULL ELSE TRIM(DCTVT_USER_CODE)
        END AS DCTVT_USER_CODE,
	CASE WHEN TRIM(DCTVT_PRGRM_NAME)='' THEN NULL ELSE TRIM(DCTVT_PRGRM_NAME)
        END AS DCTVT_PRGRM_NAME,
		DCTVT_DTTM AS DCTVT_DTTM 
				from SRC_NDC_PRCNG
            ),
LOGIC_PRCNG_TYP as ( SELECT 
	CASE WHEN TRIM(NAME)='' THEN NULL ELSE UPPER(TRIM(NAME))
        END AS NAME,
		DCTVT_DTTM AS DCTVT_DTTM,
	CASE WHEN TRIM(NDPT_CODE)='' THEN NULL ELSE TRIM(NDPT_CODE)
        END AS NDPT_CODE 
				from SRC_PRCNG_TYP
            )
----RENAME LAYER ----
,
RENAME_NDC_PRCNG as ( SELECT FK_NDCL_CODE AS FK_NDCL_CODE,FK_DCPR_CODE AS FK_DCPR_CODE,FK_NDCP_CODE AS FK_NDCP_CODE,FK_NDCV_NMBR AS FK_NDCV_NMBR,FK_NDPT_CODE AS FK_NDPT_CODE,AMT AS AMT,EFCTV_DATE AS EFCTV_DATE,ENDNG_DATE AS ENDNG_DATE,NDVP_CRT_DTTM AS NDVP_CRT_DTTM,CRT_USER_CODE AS CRT_USER_CODE,CRT_PRGRM_NAME AS CRT_PRGRM_NAME,DCTVT_USER_CODE AS DCTVT_USER_CODE,DCTVT_PRGRM_NAME AS DCTVT_PRGRM_NAME,DCTVT_DTTM AS DCTVT_DTTM 
			from      LOGIC_NDC_PRCNG
        ),
RENAME_PRCNG_TYP as ( SELECT NAME AS NAME,
			
			DCTVT_DTTM AS PRCNG_TYP_DCTVT_DTTM,NDPT_CODE AS NDPT_CODE 
			from      LOGIC_PRCNG_TYP
        )
----FILTER LAYER(uses aliases)----
,

        FILTER_NDC_PRCNG as ( SELECT  * 
			from     RENAME_NDC_PRCNG 
            WHERE DCTVT_DTTM > CURRENT_DATE
        ),

        FILTER_PRCNG_TYP as ( SELECT  * 
			from     RENAME_PRCNG_TYP 
            WHERE PRCNG_TYP_DCTVT_DTTM > CURRENT_DATE
        )
----JOIN LAYER----
,
NDC_PRCNG as ( SELECT * 
			from  FILTER_NDC_PRCNG
				LEFT JOIN FILTER_PRCNG_TYP ON FILTER_NDC_PRCNG.FK_NDPT_CODE = FILTER_PRCNG_TYP.NDPT_CODE  )
select * from NDC_PRCNG
      );
    