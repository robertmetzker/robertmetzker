

      create or replace  table DEV_EDW.STAGING.STG_NDC_FRMLRY_CVRG  as
      (----SRC LAYER----
WITH
SRC_OWDA as ( SELECT *     from      DEV_VIEWS.DBEABP00.TEAOWDA ),
SRC_NDAT as ( SELECT *     from      DEV_VIEWS.DBDWQP00.TCDNDAT ),
----LOGIC LAYER----
LOGIC_OWDA as ( SELECT 
		TRIM(FK_NDCL_CODE) AS FK_NDCL_CODE,
		TRIM(FK_DCPR_CODE) AS FK_DCPR_CODE,
		TRIM(FK_NDCP_CODE) AS FK_NDCP_CODE,
		FK_NDCV_NMBR AS FK_NDCV_NMBR,
		TRIM(FK_NDAT_CODE) AS FK_NDAT_CODE,
		OWDA_CRT_DTTM AS OWDA_CRT_DTTM,
		cast(EFCTV_DATE as DATE) AS EFCTV_DATE,
		cast(ENDNG_DATE as DATE) AS ENDNG_DATE,
		TRIM(CRT_USER_CODE) AS CRT_USER_CODE,
		TRIM(CRT_PRGRM_NAME) AS CRT_PRGRM_NAME,
		TRIM(DCTVT_USER_CODE) AS DCTVT_USER_CODE,
		TRIM(DCTVT_PRGRM_NAME) AS DCTVT_PRGRM_NAME,
		DCTVT_DTTM AS DCTVT_DTTM 
				from SRC_OWDA
            ),
LOGIC_NDAT as ( SELECT 
		TRIM(NDAT_TEXT) AS NDAT_TEXT,
		TRIM(NDAT_DESC) AS NDAT_DESC,
		TRIM(NDAT_CODE) AS NDAT_CODE 
				from SRC_NDAT
            )
----RENAME LAYER ----
,
RENAME_OWDA as ( SELECT FK_NDCL_CODE AS FK_NDCL_CODE,FK_DCPR_CODE AS FK_DCPR_CODE,FK_NDCP_CODE AS FK_NDCP_CODE,FK_NDCV_NMBR AS FK_NDCV_NMBR,FK_NDAT_CODE AS FK_NDAT_CODE,OWDA_CRT_DTTM AS OWDA_CRT_DTTM,EFCTV_DATE AS EFCTV_DATE,ENDNG_DATE AS ENDNG_DATE,CRT_USER_CODE AS CRT_USER_CODE,CRT_PRGRM_NAME AS CRT_PRGRM_NAME,DCTVT_USER_CODE AS DCTVT_USER_CODE,DCTVT_PRGRM_NAME AS DCTVT_PRGRM_NAME,DCTVT_DTTM AS DCTVT_DTTM 
			from      LOGIC_OWDA
        ),
RENAME_NDAT as ( SELECT NDAT_TEXT AS NDAT_TEXT,NDAT_DESC AS NDAT_DESC,NDAT_CODE AS NDAT_CODE 
			from      LOGIC_NDAT
        )
----FILTER LAYER(uses aliases)----
,

        FILTER_OWDA as ( SELECT  * 
			from     RENAME_OWDA 
            
        ),

        FILTER_NDAT as ( SELECT  * 
			from     RENAME_NDAT 
            
        )
----JOIN LAYER----
,
OWDA as ( SELECT * 
			from  FILTER_OWDA
				LEFT JOIN FILTER_NDAT ON FILTER_OWDA.FK_NDAT_CODE = FILTER_NDAT.NDAT_CODE  )
select * from OWDA
      );
    