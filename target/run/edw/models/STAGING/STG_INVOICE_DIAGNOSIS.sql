

      create or replace  table DEV_EDW.STAGING.STG_INVOICE_DIAGNOSIS  as
      (----SRC LAYER----
WITH
SRC_ID as ( SELECT *     from      DEV_VIEWS.BASE.INVOICE_DIAGNOSIS ),
SRC_R as ( SELECT *     from      STAGING.STG_CAM_REF )
//SRC_ID as ( SELECT *     from      INVOICE_DIAGNOSIS),
//SRC_R as ( SELECT *     from      STG_CAM_REF)
----LOGIC LAYER----
,
LOGIC_ID as ( SELECT 
		INVOICE_HEADER_ID AS INVOICE_HEADER_ID,
		SEQUENCE_NUMBER AS SEQUENCE_NUMBER,
		UPPER(TRIM(DIAGNOSIS_CODE)) AS DIAGNOSIS_CODE,
		UPPER(TRIM(PRESENT_ON_ADMIT)) AS PRESENT_ON_ADMIT,
		ICD_VERSION AS ICD_VERSION 
				from SRC_ID
            ),
LOGIC_R as ( SELECT 
		REF_DGN AS REF_DGN,
		REF_IDN AS REF_IDN,
		REF_EFF_DTE AS REF_EFF_DTE,
		REF_EXP_DTE AS REF_EXP_DTE,
		REF_DLM AS REF_DLM,
		REF_ULM AS REF_ULM,
		REF_DSC AS REF_DSC,
		REF_ENT_DTE AS REF_ENT_DTE,
		REF_ENT_UID AS REF_ENT_UID,
		REF_RID AS REF_RID 
				from SRC_R
            )
----RENAME LAYER ----
,
RENAME_ID as ( SELECT INVOICE_HEADER_ID AS INVOICE_HEADER_ID,SEQUENCE_NUMBER AS SEQUENCE_NUMBER,DIAGNOSIS_CODE AS DIAGNOSIS_CODE,PRESENT_ON_ADMIT AS PRESENT_ON_ADMIT,ICD_VERSION AS ICD_VERSION 
			from      LOGIC_ID
        ),
RENAME_R as ( SELECT REF_DGN AS REF_DGN,REF_IDN AS REF_IDN,REF_EFF_DTE AS REF_EFF_DTE,REF_EXP_DTE AS REF_EXP_DTE,REF_DLM AS REF_DLM,REF_ULM AS REF_ULM,REF_DSC AS REF_DSC,REF_ENT_DTE AS REF_ENT_DTE,REF_ENT_UID AS REF_ENT_UID,REF_RID AS REF_RID 
			from      LOGIC_R
        )
----FILTER LAYER(uses aliases)----
,

        FILTER_ID as ( SELECT  * 
			from     RENAME_ID 
            
        ),

        FILTER_R as ( SELECT  * 
			from     RENAME_R 
            WHERE REF_DGN = 'POA'
        )
----JOIN LAYER----
,
ID as ( SELECT * 
			from  FILTER_ID
				LEFT JOIN FILTER_R ON FILTER_ID.PRESENT_ON_ADMIT = FILTER_R.REF_IDN  )
select * from ID
      );
    