

      create or replace  table DEV_EDW.STAGING.DST_ICD  as
      (----SRC LAYER----
WITH
SRC_IDCS as ( SELECT *     from      STAGING.STG_TDDIDCS ),
SRC_ICDN as ( SELECT *     from      STAGING.STG_TDDICDN ),
SRC_ICDP as ( SELECT *     from      STAGING.STG_THFICDP ),
SRC_RFC as ( SELECT *     from      STAGING.STG_TCDERFC ),
SRC_FILE as ( SELECT *     from      STAGING.STG_ICD_CHAPTER_BODY_PART_REFERENCE ),
SRC_INFO as ( SELECT *     from      STAGING.STG_BWC_ICD_ADDTNL_INFO )
//SRC_IDCS as ( SELECT *     from      STG_TDDIDCS),
//SRC_ICDN as ( SELECT *     from      STG_TDDICDN),
//SRC_ICDP as ( SELECT *     from      STG_THFICDP),
//SRC_RFC as ( SELECT *     from      STG_TCDERFC),
//SRC_FILE as ( SELECT *     from      ICD_CHAPTER_BODY_PART_REFERENCE),
//SRC_INFO as ( SELECT *     from      STG_BWC_ICD_ADDTNL_INFO)
----LOGIC LAYER----
,
LOGIC_IDCS as ( SELECT 
		TRIM(ICD_CODE) AS ICD_CODE,
		TRIM(ICDV_CODE) AS ICDV_CODE,
		TRIM(ICD_CODE_STATUS_CODE) AS ICD_CODE_STATUS_CODE,
		TRIM(ICD_CODE_STATUS_DESC) AS ICD_CODE_STATUS_DESC,
		ICD_CODE_STATUS_EFFECTIVE_DATE AS ICD_CODE_STATUS_EFFECTIVE_DATE,
		NULLIF(ICD_CODE_STATUS_END_DATE, '9999-12-31'::DATE) AS ICD_CODE_STATUS_END_DATE,
		IDCS_VRSN_END_DATE AS IDCS_VRSN_END_DATE,
		ICD_CODE_STATUS_EFFECTIVE_DATE AS IDCS_EFCTV_DATE,
		ICD_CODE_STATUS_END_DATE AS IDCS_ENDNG_DATE,
		TRIM(IDCS_CRNT_MAX_FLAG) AS IDCS_CRNT_MAX_FLAG ,
		ICD_CODE_VERSION_NUMBER AS ICD_CODE_VERSION_NUMBER
				from SRC_IDCS
				QUALIFY (RANK() OVER (PARTITION BY ICD_CODE ORDER BY ICD_CODE_VERSION_NUMBER DESC)) = 1
            ),
LOGIC_ICDN as ( SELECT 
		TRIM(ICD_CODE) AS ICD_CODE,
		TRIM(ICDV_CODE) AS ICDV_CODE,
		TRIM(ICD_CODE_SHORT_DESC) AS ICD_CODE_SHORT_DESC,
		TRIM(ICD_CODE_LONG_DESC) AS ICD_CODE_LONG_DESC,
		ICDN_VRSN_END_DATE AS ICDN_VRSN_END_DATE,
		ICDN_EFCTV_DATE AS ICDN_EFCTV_DATE,
		ICDN_ENDNG_DATE AS ICDN_ENDNG_DATE,
		TRIM(ICDN_CRNT_MAX_FLAG) AS ICDN_CRNT_MAX_FLAG 
				from SRC_ICDN
            ),
LOGIC_ICDP as ( SELECT 
		TRIM(ICDC_CODE) AS ICD_CODE,
		TRIM(ICDV_CODE) AS ICDV_CODE,
		TRIM(ATHR_CLM_USE_FLAG) AS ATHR_CLM_USE_FLAG,
		TRIM(ATHR_BLNG_USE_FLAG) AS ATHR_BLNG_USE_FLAG,
		TRIM(ENCDR_VLDTN_FLAG) AS ENCDR_VLDTN_FLAG,
		TRIM(GNDR_DGAT_CODE) AS GNDR_DGAT_CODE,
		TRIM(GNDR_DGAT_TYPE) AS GNDR_DGAT_TYPE,
		TRIM(PRIOR_ATHR_FLAG) AS PRIOR_ATHR_FLAG,
		TRIM(CTSTR_ICD_FLAG) AS CTSTR_ICD_FLAG,
		TRIM(PSYCH_ICD_FLAG) AS PSYCH_ICD_FLAG,
		TRIM(ICD_PRVCY_FLAG) AS ICD_PRVCY_FLAG,
		TRIM(BODY_SITE_FLAG) AS BODY_SITE_FLAG,
		TRIM(BODY_LCTN_FLAG) AS BODY_LCTN_FLAG,
		TRIM(SBRGN_RVW_FLAG) AS SBRGN_RVW_FLAG,
		TRIM(ICD_CMS_PRHBT_FLAG) AS ICD_CMS_PRHBT_FLAG,
		ICDP_FTR_FLAG AS ICDP_FTR_FLAG,
		CRNT_PSC_FLAG AS CRNT_PSC_FLAG,
		ICDP_VRSN_END_DATE AS ICDP_VRSN_END_DATE,
		ICDP_EFCTV_DATE AS ICDP_EFCTV_DATE,
		ICDP_ENDNG_DATE AS ICDP_ENDNG_DATE,
		TRIM(ICDP_CRNT_MAX_FLAG) AS ICDP_CRNT_MAX_FLAG 
				from SRC_ICDP
            ),
LOGIC_RFC as ( SELECT 
		EM_RFRL_SFDSP_CODE AS EM_RFRL_SFDSP_CODE,
		EM_RFRL_SFDSP_TEXT AS EM_RFRL_SFDSP_TEXT,
		EM_RFRL_SFDSP_DESC AS EM_RFRL_SFDSP_DESC,
		-- CRNT_EM_RFRL_FLAG AS CRNT_EM_RFRL_FLAG,
		TRIM(ICD_CODE) AS ICD_CODE,
		TRIM(ICDV_CODE) AS ICDV_CODE,
		TRIM(CRNT_EM_RFRL_FLAG) AS CRNT_EM_RFRL_FLAG,
		EM_RFRL_ENDNG_DATE AS EM_RFRL_ENDNG_DATE 
				from SRC_RFC
            ),
LOGIC_FILE as ( SELECT 
		ICD_CHAPTER_NUMBER AS ICD_CHAPTER_NUMBER,
		ICD_FULL_CHAPTER_DESC AS ICD_FULL_CHAPTER_DESC,
		ICD_SHORT_CHAPTER_DEC AS ICD_SHORT_CHAPTER_DEC,
		INJURY_CLASS_DESC AS INJURY_CLASS_DESC,
		ICD_GENERAL_BODY_PART_DESC AS ICD_GENERAL_BODY_PART_DESC,
		ICD_SPECIFIC_BODY_PART_DESC AS ICD_SPECIFIC_BODY_PART_DESC,
		ICD_CODE AS ICD_CODE,
		ICD_VRSN_CODE AS ICD_VRSN_CODE 
				from SRC_FILE
            ),
LOGIC_INFO as ( SELECT 
		ICD_SEC_AUTH_REQ_IND AS ICD_SEC_AUTH_REQ_IND,
		ICD_ASGN_TO_FLD_REQD_IND AS ICD_ASGN_TO_FLD_REQD_IND,
		ICD_STAT_OD_IND AS ICD_STAT_OD_IND,
		ICD_CMPLX_IND AS ICD_CMPLX_IND,
		ICD_ACP_ELIG_IND AS ICD_ACP_ELIG_IND,
		ICD_CD AS ICD_CD 
				from SRC_INFO
            )
----RENAME LAYER ----
,
RENAME_IDCS as ( SELECT ICD_CODE AS ICD_CODE,
			
			ICDV_CODE AS ICD_VERSION_CODE,
			
			ICD_CODE_VERSION_NUMBER AS ICD_CODE_VERSION_NUMBER,
			
			ICD_CODE_STATUS_CODE AS ICD_STATUS_CODE,
			
			ICD_CODE_STATUS_DESC AS ICD_STATUS_DESC,
			
			ICD_CODE_STATUS_EFFECTIVE_DATE AS ICD_STATUS_EFFECTIVE_DATE,
			
			ICD_CODE_STATUS_END_DATE AS ICD_STATUS_END_DATE,
			
			IDCS_VRSN_END_DATE AS IDCS_IDCS_VRSN_END_DATE,IDCS_EFCTV_DATE AS IDCS_EFCTV_DATE,
			
			IDCS_ENDNG_DATE AS IDCS_IDCS_ENDNG_DATE,
			
			IDCS_CRNT_MAX_FLAG AS IDCS_IDCS_CRNT_MAX_FLAG 
			from      LOGIC_IDCS
        ),
RENAME_ICDN as ( SELECT ICD_CODE AS ICDN_ICD_CODE,
			
			ICDV_CODE AS ICDN_ICDV_CODE,
			
			ICD_CODE_SHORT_DESC AS ICD_DESC,
			
			ICD_CODE_LONG_DESC AS ICD_LONG_DESC,
			
			ICDN_VRSN_END_DATE AS ICDN_ICDN_VRSN_END_DATE,ICDN_EFCTV_DATE AS ICDN_EFCTV_DATE,
			
			ICDN_ENDNG_DATE AS ICDN_ICDN_ENDNG_DATE,
			
			ICDN_CRNT_MAX_FLAG AS ICDN_ICDN_CRNT_MAX_FLAG 
			from      LOGIC_ICDN
        ),
RENAME_ICDP as ( SELECT ICD_CODE AS ICDP_ICDC_CODE,
			
			ICDV_CODE AS ICDP_ICDV_CODE,
			
			ATHR_CLM_USE_FLAG AS AUTHORIZED_FOR_CLAIM_USE_IND,
			
			ATHR_BLNG_USE_FLAG AS AUTHORIZED_FOR_BILLING_USE_IND,
			
			ENCDR_VLDTN_FLAG AS ENCODER_VALIDATION_IND,
			
			GNDR_DGAT_CODE AS GENDER_TYPE_CODE,
			
			GNDR_DGAT_TYPE AS GENDER_TYPE_NAME,
			
			PRIOR_ATHR_FLAG AS PRIOR_AUTHORIZATION_IND,
			
			CTSTR_ICD_FLAG AS CATASTROPHIC_ICD_IND,
			
			PSYCH_ICD_FLAG AS PSYCHOLOGICAL_ICD_IND,
			
			ICD_PRVCY_FLAG AS ICD_PRIVACY_IND,
			
			BODY_SITE_FLAG AS SITE_REQUIRED_IND,
			
			BODY_LCTN_FLAG AS LOCATION_REQUIRED_IND,
			
			SBRGN_RVW_FLAG AS SUBROGATION_REVIEW_IND,
			
			ICD_CMS_PRHBT_FLAG AS ICD_CMS_PROHIBITED_IND,
			
			ICDP_FTR_FLAG AS IDCS_FUTR_EFF_DIAGNOSIS_STS_IND,
			
			CRNT_PSC_FLAG AS CRNT_PSC_IND,
			
			ICDP_VRSN_END_DATE AS ICDP_ICDP_VRSN_END_DATE,ICDP_EFCTV_DATE AS ICDP_EFCTV_DATE,
			
			ICDP_ENDNG_DATE AS ICDP_ICDP_ENDNG_DATE,
			
			ICDP_CRNT_MAX_FLAG AS ICDP_ICDP_CRNT_MAX_FLAG 
			from      LOGIC_ICDP
        ),
RENAME_RFC as ( SELECT 
			
			EM_RFRL_SFDSP_CODE AS EM_REFERRAL_SAFETY_DISCIPLINE_CODE,
			
			EM_RFRL_SFDSP_TEXT AS EM_REFERRAL_SAFETY_DISCIPLINE_TEXT,
			
			EM_RFRL_SFDSP_DESC AS EM_REFERRAL_SAFETY_DISCIPLINE_DESC,
			
			CRNT_EM_RFRL_FLAG AS CURRENT_EM_REFERRAL_IND,
			
			ICD_CODE AS RFC_ICD_CODE,
			
			ICDV_CODE AS RFC_ICDV_CODE,CRNT_EM_RFRL_FLAG AS CRNT_EM_RFRL_FLAG,EM_RFRL_ENDNG_DATE AS EM_RFRL_ENDNG_DATE 
			from      LOGIC_RFC
        ),
RENAME_FILE as ( SELECT ICD_CHAPTER_NUMBER AS ICD_CHAPTER_NUMBER,ICD_FULL_CHAPTER_DESC AS ICD_FULL_CHAPTER_DESC,ICD_SHORT_CHAPTER_DEC AS ICD_SHORT_CHAPTER_DEC,INJURY_CLASS_DESC AS INJURY_CLASS_DESC,ICD_GENERAL_BODY_PART_DESC AS ICD_GENERAL_BODY_PART_DESC,ICD_SPECIFIC_BODY_PART_DESC AS ICD_SPECIFIC_BODY_PART_DESC,
			
			ICD_CODE AS FILE_ICD_CODE,
			
			ICD_VRSN_CODE AS FILE_ICD_VRSN_CODE 
			from      LOGIC_FILE
        ),
RENAME_INFO as ( SELECT ICD_SEC_AUTH_REQ_IND AS ICD_SEC_AUTH_REQ_IND,ICD_ASGN_TO_FLD_REQD_IND AS ICD_ASGN_TO_FLD_REQD_IND,ICD_STAT_OD_IND AS ICD_STAT_OD_IND,ICD_CMPLX_IND AS ICD_CMPLX_IND,ICD_ACP_ELIG_IND AS ICD_ACP_ELIG_IND,
			
			ICD_CD AS INFO_ICD_CD 
			from      LOGIC_INFO
        )
----FILTER LAYER(uses aliases)----
,

        FILTER_IDCS as ( SELECT  * 
			from     RENAME_IDCS 
            WHERE IDCS_IDCS_VRSN_END_DATE >  CURRENT_DATE AND (trim(IDCS_IDCS_CRNT_MAX_FLAG) = 'Y' OR IDCS_IDCS_ENDNG_DATE >CURRENT_DATE)
        ),

        FILTER_ICDN as ( SELECT  * 
			from     RENAME_ICDN 
            WHERE ICDN_ICDN_VRSN_END_DATE > CURRENT_DATE AND (trim(ICDN_ICDN_CRNT_MAX_FLAG) = 'Y' OR ICDN_ICDN_ENDNG_DATE > CURRENT_DATE)
        ),

        FILTER_ICDP as ( SELECT  * 
			from     RENAME_ICDP 
            WHERE ICDP_ICDP_VRSN_END_DATE > CURRENT_DATE AND (trim(ICDP_ICDP_CRNT_MAX_FLAG) = 'Y' OR ICDP_ICDP_ENDNG_DATE >CURRENT_DATE)
        ),

        FILTER_RFC as ( SELECT  * 
			from     RENAME_RFC 
            WHERE CRNT_EM_RFRL_FLAG = 'Y' OR EM_RFRL_ENDNG_DATE >CURRENT_DATE
        ),

        FILTER_FILE as ( SELECT  * 
			from     RENAME_FILE 
            
        ),

        FILTER_INFO as ( SELECT  * 
			from     RENAME_INFO 
            
        )
----JOIN LAYER----
,
IDCS as ( SELECT * 
			from  FILTER_IDCS
				LEFT JOIN FILTER_ICDN ON FILTER_IDCS.ICD_CODE = FILTER_ICDN.ICDN_ICD_CODE 
										AND FILTER_IDCS.ICD_VERSION_CODE = FILTER_ICDN.ICDN_ICDV_CODE
				LEFT JOIN FILTER_ICDP ON FILTER_IDCS.ICD_CODE = FILTER_ICDP.ICDP_ICDC_CODE 
									    AND FILTER_IDCS.ICD_VERSION_CODE = FILTER_ICDP.ICDP_ICDV_CODE
				LEFT JOIN FILTER_RFC ON FILTER_IDCS.ICD_CODE = FILTER_RFC.RFC_ICD_CODE 
									    AND FILTER_IDCS.ICD_VERSION_CODE = FILTER_RFC.RFC_ICDV_CODE
				LEFT JOIN FILTER_FILE ON FILTER_IDCS.ICD_CODE = FILTER_FILE.FILE_ICD_CODE 
									    AND FILTER_IDCS.ICD_CODE_VERSION_NUMBER = FILTER_FILE.FILE_ICD_VRSN_CODE
				LEFT JOIN FILTER_INFO ON FILTER_IDCS.ICD_CODE = FILTER_INFO.INFO_ICD_CD  )

----ETL LAYER----
,
IDCS_ETL as ( select  md5(cast(
    
    coalesce(cast(ICD_CODE as 
    varchar
), '') || '-' || coalesce(cast(ICD_CODE_VERSION_NUMBER as 
    varchar
), '')

 as 
    varchar
)) as UNIQUE_ID_KEY,
                      *
 from   IDCS )

SELECT * FROM IDCS_ETL
      );
    