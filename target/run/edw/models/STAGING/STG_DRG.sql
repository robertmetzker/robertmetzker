

      create or replace  table DEV_EDW.STAGING.STG_DRG  as
      (----SRC LAYER----
WITH
SRC_DRG as ( SELECT *     from      DEV_VIEWS.BASE.DRG_OUTLIER ),
SRC_DT as ( SELECT *     from      DEV_VIEWS.BASE.REF ),
SRC_PAT as ( SELECT *     from      DEV_VIEWS.BASE.REF )
//SRC_DRG as ( SELECT *     from      DRG_OUTLIER),
//SRC_DT as ( SELECT *     from      REF),
//SRC_PAT as ( SELECT *     from      REF)
----LOGIC LAYER----
,
LOGIC_DRG as ( SELECT 
		UPPER(TRIM(DRG_CODE)) AS DRG_CODE,
		cast(EFFECTIVE_DATE as DATE) AS EFFECTIVE_DATE,
		cast(EXPIRATION_DATE as DATE) AS EXPIRATION_DATE,
		UPPER(TRIM(DESCRIPTION)) AS DESCRIPTION,
		UPPER(TRIM(DRG_TYPE)) AS DRG_TYPE,
		case when TRIM(PA_TYPE)='' then NULL else upper (trim(PA_TYPE)) end  AS PA_TYPE,
		UPPER(TRIM(REVIEW)) AS REVIEW,
		CAST(MEAN_VALUE AS NUMERIC(31,2)) AS MEAN_VALUE,
		CAST(STD_DEV AS NUMERIC(31,2)) AS STD_DEV,
		UPPER(TRIM(CREATION_USER)) AS CREATION_USER,
		CREATION_DATE::TIMESTAMP AS CREATION_DATE,
		UPPER(TRIM(UPDATE_USER)) AS UPDATE_USER,
		UPDATE_DATE::TIMESTAMP AS UPDATE_DATE 
				from SRC_DRG
            ),
LOGIC_DT as ( SELECT 
		UPPER(TRIM(REF_DSC)) AS REF_DSC,
		UPPER(TRIM(REF_IDN)) AS REF_IDN,
		UPPER(TRIM(REF_DGN)) AS REF_DGN,
		REF_EXP_DTE AS REF_EXP_DTE 
				from SRC_DT
            ),
LOGIC_PAT as ( SELECT 
		UPPER(TRIM(REF_DSC)) AS REF_DSC,
		UPPER(TRIM(REF_IDN)) AS REF_IDN,
		UPPER(TRIM(REF_DGN)) AS REF_DGN,
		REF_EXP_DTE AS REF_EXP_DTE 
				from SRC_PAT
            )
----RENAME LAYER ----
,
RENAME_DRG as ( SELECT DRG_CODE AS DRG_CODE,EFFECTIVE_DATE AS EFFECTIVE_DATE,EXPIRATION_DATE AS EXPIRATION_DATE,DESCRIPTION AS DESCRIPTION,DRG_TYPE AS DRG_TYPE,PA_TYPE AS PA_TYPE,REVIEW AS REVIEW,MEAN_VALUE AS MEAN_VALUE,STD_DEV AS STD_DEV,CREATION_USER AS CREATION_USER,CREATION_DATE AS CREATION_DATE,UPDATE_USER AS UPDATE_USER,UPDATE_DATE AS UPDATE_DATE 
			from      LOGIC_DRG
        ),
RENAME_DT as ( SELECT 
			
			REF_DSC AS DRG_TYPE_DESC,
			
			REF_IDN AS DT_REF_IDN,
			
			REF_DGN AS DT_REF_DGN,
			
			REF_EXP_DTE AS DT_REF_EXP_DTE 
			from      LOGIC_DT
        ),
RENAME_PAT as ( SELECT 
			
			REF_DSC AS PA_TYPE_DESC,
			
			REF_IDN AS PAT_REF_IDN,
			
			REF_DGN AS PAT_REF_DGN,
			
			REF_EXP_DTE AS PAT_REF_EXP_DTE 
			from      LOGIC_PAT
        )
----FILTER LAYER(uses aliases)----
,

        FILTER_DRG as ( SELECT  * 
			from     RENAME_DRG 
            
        ),

        FILTER_DT as ( SELECT  * 
			from     RENAME_DT 
            WHERE DT_REF_DGN = 'DRG' and DT_REF_EXP_DTE > current_date
        ),

        FILTER_PAT as ( SELECT  * 
			from     RENAME_PAT 
            WHERE PAT_REF_DGN = 'PAC' and PAT_REF_EXP_DTE > current_date
        )
----JOIN LAYER----
,
DRG as ( SELECT * 
			from  FILTER_DRG
				LEFT JOIN FILTER_DT ON FILTER_DRG.DRG_TYPE = FILTER_DT.DT_REF_IDN 
				LEFT JOIN FILTER_PAT ON FILTER_DRG.PA_TYPE = FILTER_PAT.PAT_REF_IDN  )
select * from DRG
      );
    