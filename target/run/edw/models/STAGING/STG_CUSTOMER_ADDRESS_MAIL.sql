

      create or replace  table DEV_EDW.STAGING.STG_CUSTOMER_ADDRESS_MAIL  as
      (----SRC LAYER----
WITH
SRC_CAM as ( SELECT *     from       STAGING.STG_CUSTOMER_ADDRESS )
//SRC_CAM as ( SELECT *     from      STG_CUSTOMER_ADDRESS),
//SRC_CAP as ( SELECT *     from      STG_CUSTOMER_ADDRESS)
----LOGIC LAYER----
,
LOGIC_CAM as ( SELECT 
		CUST_ID AS CUST_ID,
		CUST_ADDR_STR_1 AS CUST_ADDR_STR_1,
		CUST_ADDR_STR_2 AS CUST_ADDR_STR_2,
		STT_ABRV AS STT_ABRV,
		STT_NM AS STT_NM,
		CNTRY_NM AS CNTRY_NM,
		CUST_ADDR_CITY_NM AS CUST_ADDR_CITY_NM,
		CUST_ADDR_CNTY_NM AS CUST_ADDR_CNTY_NM,
		CUST_ADDR_POST_CD AS CUST_ADDR_POST_CD,
		CASE WHEN LENGTH(CUST_ADDR_POST_CD) = 9 AND CNTRY_NM = 'UNITED STATES'
					THEN LEFT(CUST_ADDR_POST_CD, 5) ||'-'|| RIGHT(CUST_ADDR_POST_CD, 4)
				WHEN LENGTH(CUST_ADDR_POST_CD) = 6 AND CNTRY_NM = 'CANADA' 
					THEN LEFT(CUST_ADDR_POST_CD, 3) ||' '|| RIGHT(CUST_ADDR_POST_CD, 3)
				ELSE CUST_ADDR_POST_CD END AS MAILING_FORMATTED_ADDRESS_POSTAL_CODE,
			
			CASE WHEN LENGTH(CUST_ADDR_POST_CD) = 9 AND CNTRY_NM = 'UNITED STATES'
					THEN LEFT(CUST_ADDR_POST_CD, 5) ELSE CUST_ADDR_POST_CD END AS MAILING_FORMATTED_ADDRESS_ZIP_CODE,
			
			CASE WHEN LENGTH(CUST_ADDR_POST_CD) = 9 AND CNTRY_NM = 'UNITED STATES'
					THEN RIGHT(CUST_ADDR_POST_CD, 4)  END AS MAILING_FORMATTED_ADDRESS_ZIP4_CODE,
		CUST_ADDR_VLDT_IND AS CUST_ADDR_VLDT_IND,
		CUST_ADDR_COMT AS CUST_ADDR_COMT,
		CUST_ADDR_EFF_DATE AS CUST_ADDR_EFF_DATE,
		CASE WHEN CUST_ID = LEAD(CUST_ID) OVER (ORDER BY CUST_ID, CUST_ADDR_EFF_DATE, COALESCE(CUST_ADDR_END_DATE, '12/31/2999'))
					THEN lead(CUST_ADDR_EFF_DATE) over (PARTITION BY CUST_ID ORDER BY CUST_ADDR_EFF_DATE, COALESCE(CUST_ADDR_END_DATE, '12/31/2999'))-1
                    ELSE CUST_ADDR_END_DATE END AS MAIL_ADRS_END_DATE,
		VOID_IND AS VOID_IND,
		CUST_ADDR_TYP_CD AS CUST_ADDR_TYP_CD,
		CUST_ADDR_END_DATE AS CUST_ADDR_END_DATE 
				from SRC_CAM
				WHERE CUST_ADDR_TYP_CD = 'MAIL' and VOID_IND = 'N'
            )
----RENAME LAYER ----
,
RENAME_CAM as ( SELECT CUST_ID AS CUST_ID,
			
			CUST_ADDR_STR_1 AS MAILING_STREET_ADDRESS_1,
			
			CUST_ADDR_STR_2 AS MAILING_STREET_ADDRESS_2,
			
			STT_ABRV AS MAILING_ADDRESS_STATE_CODE,
			
			STT_NM AS MAILING_ADDRESS_STATE_NAME,
			
			CNTRY_NM AS MAILING_ADDRESS_COUNTRY_NAME,
			
			CUST_ADDR_CITY_NM AS MAILING_ADDRESS_CITY_NAME,
			
			CUST_ADDR_CNTY_NM AS MAILING_ADDRESS_COUNTY_NAME,
			
			CUST_ADDR_POST_CD AS MAILING_ADDRESS_POSTAL_CODE,
			
			MAILING_FORMATTED_ADDRESS_POSTAL_CODE AS MAILING_FORMATTED_ADDRESS_POSTAL_CODE,
			
			MAILING_FORMATTED_ADDRESS_ZIP_CODE AS MAILING_FORMATTED_ADDRESS_ZIP_CODE,
			
			MAILING_FORMATTED_ADDRESS_ZIP4_CODE AS MAILING_FORMATTED_ADDRESS_ZIP4_CODE,
			
			CUST_ADDR_VLDT_IND AS MAILING_ADDRESS_VALIDATED_IND,
			
			CUST_ADDR_COMT AS MAILING_ADDRESS_COMMENT_TEXT,
			
			CUST_ADDR_EFF_DATE AS MAIL_ADRS_EFF_DATE,
			
			MAIL_ADRS_END_DATE AS MAIL_ADRS_END_DATE,
			
			VOID_IND AS VOID_IND,
			
			CUST_ADDR_TYP_CD AS CUST_ADDR_TYP_CD,
			
			CUST_ADDR_END_DATE AS CAM_CUST_ADDR_END_DATE 
			from      LOGIC_CAM
        )  
----FILTER LAYER(uses aliases)----
,

        FILTER_CAM as ( SELECT  * 
			from     RENAME_CAM 
        )
----JOIN LAYER----
,
CAM as ( SELECT * 
			from  FILTER_CAM)
SELECT CUST_ID as CUST_ID 
, MAILING_STREET_ADDRESS_1
, MAILING_STREET_ADDRESS_2
, MAILING_ADDRESS_STATE_CODE
, MAILING_ADDRESS_STATE_NAME
, MAILING_ADDRESS_COUNTRY_NAME
, MAILING_ADDRESS_CITY_NAME
, MAILING_ADDRESS_COUNTY_NAME
, MAILING_ADDRESS_POSTAL_CODE
, MAILING_FORMATTED_ADDRESS_POSTAL_CODE
, MAILING_FORMATTED_ADDRESS_ZIP_CODE
, MAILING_FORMATTED_ADDRESS_ZIP4_CODE
, MAILING_ADDRESS_VALIDATED_IND
, MAILING_ADDRESS_COMMENT_TEXT
, MAIL_ADRS_EFF_DATE
, MAIL_ADRS_END_DATE
, VOID_IND
, CUST_ADDR_TYP_CD
, CAM_CUST_ADDR_END_DATE
from CAM
      );
    