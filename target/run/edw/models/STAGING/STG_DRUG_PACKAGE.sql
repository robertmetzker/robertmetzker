

      create or replace  table DEV_EDW.STAGING.STG_DRUG_PACKAGE  as
      (----SRC LAYER----
WITH
SRC_NVMG as ( SELECT *     from      DEV_VIEWS.DBEABP00.TEANVMG ),
SRC_MGPC as ( SELECT *     from      DEV_VIEWS.DBEABP00.TEAMGPC ),
SRC_MPSM as ( SELECT *     from      DEV_VIEWS.DBEABP00.TEAMPSM ),
SRC_MDUP as ( SELECT *     from      DEV_VIEWS.DBEABP00.TEAMDUP ),
SRC_MPDT as ( SELECT *     from      DEV_VIEWS.DBEABP00.TEAMPDT ),
----LOGIC LAYER----
LOGIC_NVMG as ( SELECT 
		CASE WHEN TRIM(FK_NDCL_CODE)='' THEN NULL ELSE TRIM(FK_NDCL_CODE) END AS FK_NDCL_CODE,
        CASE WHEN TRIM(FK_DCPR_CODE)='' THEN NULL ELSE TRIM(FK_DCPR_CODE) END AS FK_DCPR_CODE,
        CASE WHEN TRIM(FK_NDCP_CODE)='' THEN NULL ELSE TRIM(FK_NDCP_CODE) END AS FK_NDCP_CODE,
		FK_NDCV_NMBR AS FK_NDCV_NMBR,
        CASE WHEN TRIM(FK_MGPC_NMBR)='' THEN NULL ELSE TRIM(FK_MGPC_NMBR) END AS FK_MGPC_NMBR,
		NVMG_CRT_DTTM AS NVMG_CRT_DTTM,
		cast(EFCTV_DATE as DATE) AS EFCTV_DATE,
		cast(ENDNG_DATE as DATE) AS ENDNG_DATE,
		DCTVT_DTTM AS DCTVT_DTTM,
        CASE WHEN TRIM(CRT_USER_CODE)='' THEN NULL ELSE TRIM(CRT_USER_CODE) END AS CRT_USER_CODE,
        CASE WHEN TRIM(CRT_PRGRM_NAME)='' THEN NULL ELSE TRIM(CRT_PRGRM_NAME) END AS CRT_PRGRM_NAME,
        CASE WHEN TRIM(DCTVT_USER_CODE)='' THEN NULL ELSE TRIM(DCTVT_USER_CODE) END AS DCTVT_USER_CODE,
        CASE WHEN TRIM(DCTVT_PRGRM_NAME)='' THEN NULL ELSE TRIM(DCTVT_PRGRM_NAME) END AS DCTVT_PRGRM_NAME
				from SRC_NVMG
            ),
LOGIC_MGPC as ( SELECT 
		PCKG_SIZE_QTY AS PCKG_SIZE_QTY,
		PCKG_QTY AS PCKG_QTY,
		CASE WHEN TRIM(FK_MTDG_CODE)='' THEN NULL ELSE TRIM(FK_MTDG_CODE) END AS FK_MTDG_CODE,
        CASE WHEN TRIM(FK_MTDC_CODE)='' THEN NULL ELSE TRIM(FK_MTDC_CODE) END AS FK_MTDC_CODE,
        CASE WHEN TRIM(FK_MTDS_CODE)='' THEN NULL ELSE TRIM(FK_MTDS_CODE) END AS FK_MTDS_CODE,
        CASE WHEN TRIM(FK_MTDN_CODE)='' THEN NULL ELSE TRIM(FK_MTDN_CODE) END AS FK_MTDN_CODE,
        CASE WHEN TRIM(FK_MDNE_CODE)='' THEN NULL ELSE TRIM(FK_MDNE_CODE) END AS FK_MDNE_CODE,
        CASE WHEN TRIM(FK_MDFT_CODE)='' THEN NULL ELSE TRIM(FK_MDFT_CODE) END AS FK_MDFT_CODE,
		FK_MDDF_CRT_DTTM AS FK_MDDF_CRT_DTTM,
        CASE WHEN TRIM(FK_MGGN_CODE)='' THEN NULL ELSE TRIM(FK_MGGN_CODE) END AS FK_MGGN_CODE,
        CASE WHEN TRIM(FK_MDUP_CODE)='' THEN '0' ELSE TRIM(FK_MDUP_CODE) END AS FK_MDUP_CODE,
        CASE WHEN TRIM(FK_MPDT_CODE)='' THEN NULL ELSE TRIM(FK_MPDT_CODE) END AS FK_MPDT_CODE,
        CASE WHEN TRIM(FK_MPSM_CODE)='' THEN NULL ELSE TRIM(FK_MPSM_CODE) END AS FK_MPSM_CODE,
		CRT_DTTM AS CRT_DTTM,
        CASE WHEN TRIM(MGPC_NMBR)='' THEN NULL ELSE TRIM(MGPC_NMBR) END AS MGPC_NMBR
				from SRC_MGPC
            ),
LOGIC_MPSM as ( SELECT 
		CASE WHEN TRIM(DESCR)='' THEN NULL ELSE TRIM(DESCR) END AS DESCR,
		CRT_DTTM AS CRT_DTTM,
		cast(EFCTV_DATE as DATE) AS EFCTV_DATE,
		cast(ENDNG_DATE as DATE) AS ENDNG_DATE,
		CASE WHEN TRIM(MPSM_CODE)='' THEN NULL ELSE TRIM(MPSM_CODE) END AS MPSM_CODE,
		DCTVT_DTTM AS DCTVT_DTTM 
				from SRC_MPSM
            ),
LOGIC_MDUP as ( SELECT 
		CASE WHEN TRIM(DESCR)='' THEN NULL ELSE TRIM(DESCR) END AS DESCR,
		CRT_DTTM AS CRT_DTTM,
		cast(EFCTV_DATE as DATE) AS EFCTV_DATE,
		cast(ENDNG_DATE as DATE) AS ENDNG_DATE,
		CASE WHEN TRIM(MDUP_CODE)='' THEN '0' ELSE TRIM(MDUP_CODE) END AS MDUP_CODE,
		DCTVT_DTTM AS DCTVT_DTTM 
				from SRC_MDUP
            ),
LOGIC_MPDT as ( SELECT 
		CASE WHEN TRIM(DESCR)='' THEN NULL ELSE TRIM(DESCR) END AS DESCR,
		CASE WHEN TRIM(MPDT_CODE)='' THEN NULL ELSE TRIM(MPDT_CODE) END AS MPDT_CODE,
		DCTVT_DTTM AS DCTVT_DTTM 
				from SRC_MPDT
            )
----RENAME LAYER ----
,
RENAME_NVMG as ( SELECT FK_NDCL_CODE AS FK_NDCL_CODE,FK_DCPR_CODE AS FK_DCPR_CODE,FK_NDCP_CODE AS FK_NDCP_CODE,FK_NDCV_NMBR AS FK_NDCV_NMBR,FK_MGPC_NMBR AS FK_MGPC_NMBR,NVMG_CRT_DTTM AS NVMG_CRT_DTTM,EFCTV_DATE AS EFCTV_DATE,ENDNG_DATE AS ENDNG_DATE,DCTVT_DTTM AS DCTVT_DTTM,CRT_USER_CODE AS CRT_USER_CODE,CRT_PRGRM_NAME AS CRT_PRGRM_NAME,DCTVT_USER_CODE AS DCTVT_USER_CODE,DCTVT_PRGRM_NAME AS DCTVT_PRGRM_NAME 
			from      LOGIC_NVMG
        ),
RENAME_MGPC as ( SELECT PCKG_SIZE_QTY AS PCKG_SIZE_QTY,PCKG_QTY AS PCKG_QTY,FK_MTDG_CODE AS FK_MTDG_CODE,FK_MTDC_CODE AS FK_MTDC_CODE,FK_MTDS_CODE AS FK_MTDS_CODE,FK_MTDN_CODE AS FK_MTDN_CODE,FK_MDNE_CODE AS FK_MDNE_CODE,FK_MDFT_CODE AS FK_MDFT_CODE,FK_MDDF_CRT_DTTM AS FK_MDDF_CRT_DTTM,FK_MGGN_CODE AS FK_MGGN_CODE,FK_MDUP_CODE AS FK_MDUP_CODE,FK_MPDT_CODE AS FK_MPDT_CODE,FK_MPSM_CODE AS FK_MPSM_CODE,
			
			CRT_DTTM AS MGPC_CRT_DTTM,MGPC_NMBR AS MGPC_NMBR 
			from      LOGIC_MGPC
        ),
RENAME_MPSM as ( SELECT 
			
			DESCR AS MPSM_DESCR,
			
			CRT_DTTM AS MPSM_CRT_DTTM,
			
			EFCTV_DATE AS MPSM_EFCTV_DATE,
			
			ENDNG_DATE AS MPSM_ENDNG_DATE,MPSM_CODE AS MPSM_CODE,
			
			DCTVT_DTTM AS MPSM_DCTVT_DTTM 
			from      LOGIC_MPSM
        ),
RENAME_MDUP as ( SELECT 
			
			DESCR AS MDUP_DESCR,
			
			CRT_DTTM AS MDUP_CRT_DTTM,
			
			EFCTV_DATE AS MDUP_EFCTV_DATE,
			
			ENDNG_DATE AS MDUP_ENDNG_DATE,MDUP_CODE AS MDUP_CODE,
			
			DCTVT_DTTM AS MDUP_DCTVT_DTTM 
			from      LOGIC_MDUP
        ),
RENAME_MPDT as ( SELECT 
			
			DESCR AS MPDT_DESCR,MPDT_CODE AS MPDT_CODE,
			
			DCTVT_DTTM AS MPDT_DCTVT_DTTM 
			from      LOGIC_MPDT
        )
----FILTER LAYER(uses aliases)----
,

        FILTER_NVMG as ( SELECT  * 
			from     RENAME_NVMG 
            
        ),

        FILTER_MGPC as ( SELECT  * 
			from     RENAME_MGPC 
            
        ),

        FILTER_MPSM as ( SELECT  * 
			from     RENAME_MPSM 
            WHERE MPSM_DCTVT_DTTM > CURRENT_DATE
        ),

        FILTER_MDUP as ( SELECT  * 
			from     RENAME_MDUP 
            WHERE MDUP_DCTVT_DTTM > CURRENT_DATE
        ),

        FILTER_MPDT as ( SELECT  * 
			from     RENAME_MPDT 
            WHERE MPDT_DCTVT_DTTM > CURRENT_DATE
        )
----JOIN LAYER----
,
MGPC as ( SELECT * 
			from  FILTER_MGPC
				INNER JOIN FILTER_MPSM ON FILTER_MGPC.FK_MPSM_CODE = FILTER_MPSM.MPSM_CODE 
				INNER JOIN FILTER_MDUP ON coalesce(FILTER_MGPC.FK_MDUP_CODE,'0') = coalesce(FILTER_MDUP.MDUP_CODE,'0')
				LEFT JOIN FILTER_MPDT ON FILTER_MGPC.FK_MPDT_CODE = FILTER_MPDT.MPDT_CODE  ),
NVMG as ( SELECT * 
			from  FILTER_NVMG
				LEFT JOIN MGPC ON FILTER_NVMG.FK_MGPC_NMBR = MGPC.MGPC_NMBR  )
select * from NVMG
      );
    