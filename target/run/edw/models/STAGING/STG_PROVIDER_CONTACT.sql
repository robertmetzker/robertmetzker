

      create or replace  table DEV_EDW.STAGING.STG_PROVIDER_CONTACT  as
      (----SRC LAYER----
WITH
SRC_PECN as ( SELECT *     from      DEV_VIEWS.DBMOBP00.TMPPECN ),
SRC_CNDT as ( SELECT *     from      DEV_VIEWS.DBMOBP00.TMPCNDT ),
SRC_CNPT as ( SELECT *     from      DEV_VIEWS.BWC_PEACH.TMPCNPT ),
SRC_ADRT as ( SELECT *     from      DEV_VIEWS.BWC_PEACH.TMPADRT )
//SRC_PECN as ( SELECT *     from      TMPADRT),
//SRC_CNDT as ( SELECT *     from      TMPCNDT),
//SRC_CNPT as ( SELECT *     from      TMPCNDT),
//SRC_ADRT as ( SELECT *     from      TMPADRT)
----LOGIC LAYER----
,
LOGIC_PECN  as ( SELECT 
		PRVDR_BASE_NMBR AS PRVDR_BASE_NMBR,
		lpad(PRVDR_SFX_NMBR,4,0) AS PRVDR_SFX_NMBR,
		CNTCT_ID AS CNTCT_ID,
		PECN_CRT_DTTM AS PECN_CRT_DTTM,
		UPPER(TRIM(CNTCT_PRP_TYP_CODE)) AS CNTCT_PRP_TYP_CODE,
		EFCTV_DATE AS EFCTV_DATE,
		ENDNG_DATE AS ENDNG_DATE,
		UPPER(TRIM(CRT_USER_CODE)) AS CRT_USER_CODE,
		case when DCTVT_DTTM='10000-01-01 00:00:00' then '2999-12-31 00:00:00' else DCTVT_DTTM end::TIMESTAMP   AS DCTVT_DTTM,
		UPPER(TRIM(DCTVT_USER_CODE)) AS DCTVT_USER_CODE,
		UPPER(TRIM(UPDT_PRGRM_NAME)) AS UPDT_PRGRM_NAME,
		UPPER(TRIM(ADRS_TYPE_CODE)) AS ADRS_TYPE_CODE,
		ADRS_TYPE_LCT_NMBR AS ADRS_TYPE_LCT_NMBR,
		CNEA_CRT_DTTM AS CNEA_CRT_DTTM 
				from SRC_PECN 
            ),
LOGIC_CNDT as ( SELECT 
		CNDT_CRT_DTTM AS CNDT_CRT_DTTM,
		UPPER(TRIM(NAME)) AS NAME,
		UPPER(TRIM(TITLE)) AS TITLE,
		UPPER(TRIM(PHONE_AREA_CODE)) AS PHONE_AREA_CODE,
		UPPER(TRIM(PHONE_EXCHN_NMBR)) AS PHONE_EXCHN_NMBR,
		UPPER(TRIM(PHONE_LINE_NMBR)) AS PHONE_LINE_NMBR,
		PHONE_AREA_CODE ||'-'|| PHONE_EXCHN_NMBR ||'-'|| PHONE_LINE_NMBR as PHONE_NUMBER ,
		UPPER(TRIM(PHONE_EXTNS_NMBR)) AS PHONE_EXTNS_NMBR,
		UPPER(TRIM(FRGN_CNTRY_CODE)) AS FRGN_CNTRY_CODE,
		UPPER(TRIM(FRGN_PHONE_NMBR)) AS FRGN_PHONE_NMBR,
		UPPER(TRIM(FRGN_EXTNS_NMBR)) AS FRGN_EXTNS_NMBR,
		UPPER(TRIM(FAX_AREA_CODE)) AS FAX_AREA_CODE,
		UPPER(TRIM(FAX_EXCHN_NMBR)) AS FAX_EXCHN_NMBR,
		UPPER(TRIM(FAX_LINE_NMBR)) AS FAX_LINE_NMBR,
		FAX_AREA_CODE ||'-'|| FAX_EXCHN_NMBR ||'-'|| FAX_LINE_NMBR as  FAX_NUMBER ,
		UPPER(TRIM(FRGN_FAX_CNTR_CODE)) AS FRGN_FAX_CNTR_CODE,
		UPPER(TRIM(FRGN_FAX_PHON_NMBR)) AS FRGN_FAX_PHON_NMBR,
		UPPER(TRIM(FRGN_FAX_EXTN_NMBR)) AS FRGN_FAX_EXTN_NMBR,
		UPPER(TRIM(EMAIL_ADRS)) AS EMAIL_ADRS,
		CNTCT_ID AS CNTCT_ID,
		UPPER(TRIM(CRT_USER_CODE)) AS CRT_USER_CODE,
		case when DCTVT_DTTM='10000-01-01 00:00:00' then '2999-12-31 00:00:00' else DCTVT_DTTM end::TIMESTAMP   AS DCTVT_DTTM,
		UPPER(TRIM(DCTVT_USER_CODE)) AS DCTVT_USER_CODE,
		UPPER(TRIM(UPDT_PRGRM_NAME)) AS UPDT_PRGRM_NAME 
				from SRC_CNDT
            ),
LOGIC_CNPT as ( SELECT 
		UPPER(TRIM(CNTCT_PRP_TYP_CODE)) AS CNTCT_PRP_TYP_CODE,
		EFCTV_DATE AS EFCTV_DATE,
		ENDNG_DATE AS ENDNG_DATE,
		UPPER(TRIM(CRT_USER_CODE)) AS CRT_USER_CODE,
		case when DCTVT_DTTM='10000-01-01 00:00:00' then '2999-12-31 00:00:00' else DCTVT_DTTM end::TIMESTAMP   AS DCTVT_DTTM,
		UPPER(TRIM(DCTVT_USER_CODE)) AS DCTVT_USER_CODE,
		UPPER(TRIM(UPDT_PRGRM_NAME)) AS UPDT_PRGRM_NAME ,UPPER(TRIM(PRPS_TYPE_NAME)) AS PRPS_TYPE_NAME, CRT_DTTM as CNPT_CRT_DTTM
				from SRC_CNPT
            ),
LOGIC_ADRT as ( SELECT 
		UPPER(TRIM(ADRS_TYPE_CODE)) AS ADRS_TYPE_CODE,
		CRT_DTTM AS CRT_DTTM,
		EFCTV_DATE AS EFCTV_DATE,
		ENDNG_DATE AS ENDNG_DATE,
		UPPER(TRIM(CRT_USER_CODE)) AS CRT_USER_CODE,
		case when DCTVT_DTTM='10000-01-01 00:00:00' then '2999-12-31 00:00:00' else DCTVT_DTTM end::TIMESTAMP   AS DCTVT_DTTM,
		UPPER(TRIM(DCTVT_USER_CODE)) AS DCTVT_USER_CODE,
		UPPER(TRIM(UPDT_PRGRM_NAME)) AS UPDT_PRGRM_NAME , UPPER(TRIM(ADRS_TYPE_DESCR)) AS ADRS_TYPE_DESCR
				from SRC_ADRT
            )
----RENAME LAYER ----
,
RENAME_PECN as ( SELECT PRVDR_BASE_NMBR AS PRVDR_BASE_NMBR,PRVDR_SFX_NMBR AS PRVDR_SFX_NMBR,CNTCT_ID AS CNTCT_ID,PECN_CRT_DTTM AS PECN_CRT_DTTM,CNTCT_PRP_TYP_CODE AS CNTCT_PRP_TYP_CODE,EFCTV_DATE AS EFCTV_DATE,ENDNG_DATE AS ENDNG_DATE,CRT_USER_CODE AS CRT_USER_CODE,DCTVT_DTTM AS DCTVT_DTTM,DCTVT_USER_CODE AS DCTVT_USER_CODE,UPDT_PRGRM_NAME AS UPDT_PRGRM_NAME,ADRS_TYPE_CODE AS ADRS_TYPE_CODE,ADRS_TYPE_LCT_NMBR AS ADRS_TYPE_LCT_NMBR,CNEA_CRT_DTTM AS CNEA_CRT_DTTM 
			from      LOGIC_PECN
        ),
RENAME_CNDT as ( SELECT CNDT_CRT_DTTM AS CNDT_CRT_DTTM,NAME AS NAME,TITLE AS TITLE,PHONE_AREA_CODE AS PHONE_AREA_CODE,PHONE_EXCHN_NMBR AS PHONE_EXCHN_NMBR,PHONE_LINE_NMBR AS PHONE_LINE_NMBR,
			
			PHONE_NUMBER AS PHONE_NUMBER,PHONE_EXTNS_NMBR AS PHONE_EXTNS_NMBR,FRGN_CNTRY_CODE AS FRGN_CNTRY_CODE,FRGN_PHONE_NMBR AS FRGN_PHONE_NMBR,FRGN_EXTNS_NMBR AS FRGN_EXTNS_NMBR,FAX_AREA_CODE AS FAX_AREA_CODE,FAX_EXCHN_NMBR AS FAX_EXCHN_NMBR,FAX_LINE_NMBR AS FAX_LINE_NMBR,
			
			FAX_NUMBER AS FAX_NUMBER,FRGN_FAX_CNTR_CODE AS FRGN_FAX_CNTR_CODE,FRGN_FAX_PHON_NMBR AS FRGN_FAX_PHON_NMBR,FRGN_FAX_EXTN_NMBR AS FRGN_FAX_EXTN_NMBR,EMAIL_ADRS AS EMAIL_ADRS,
			
			CNTCT_ID AS TMPCNDT_CNTCT_ID,
			
			CRT_USER_CODE AS TMPCNDT_CRT_USER_CODE,
			
			DCTVT_DTTM AS TMPCNDT_DCTVT_DTTM,
			
			DCTVT_USER_CODE AS TMPCNDT_DCTVT_USER_CODE,
			
			UPDT_PRGRM_NAME AS TMPCNDT_UPDT_PRGRM_NAME 
			from      LOGIC_CNDT
        ),
RENAME_CNPT as ( SELECT 
			
			CNTCT_PRP_TYP_CODE AS TMPCNPT_CNTCT_PRP_TYP_CODE,
			
			EFCTV_DATE AS TMPCNPT_EFCTV_DATE,
			
			ENDNG_DATE AS TMPCNPT_ENDNG_DATE,
			
			CRT_USER_CODE AS TMPCNPT_CRT_USER_CODE,
			
			DCTVT_DTTM AS TMPCNPT_DCTVT_DTTM,
			
			DCTVT_USER_CODE AS TMPCNPT_DCTVT_USER_CODE,
			
			UPDT_PRGRM_NAME AS TMPCNPT_UPDT_PRGRM_NAME , PRPS_TYPE_NAME AS PRPS_TYPE_NAME, CNPT_CRT_DTTM AS CNPT_CRT_DTTM
			from      LOGIC_CNPT
        ),
RENAME_ADRT as ( SELECT 
			
			ADRS_TYPE_CODE AS TMPADRT_ADRS_TYPE_CODE,
			
			CRT_DTTM AS TMPADRT_CRT_DTTM,
			
			EFCTV_DATE AS TMPADRT_EFCTV_DATE,
			
			ENDNG_DATE AS TMPADRT_ENDNG_DATE,
			
			CRT_USER_CODE AS TMPADRT_CRT_USER_CODE,
			
			DCTVT_DTTM AS TMPADRT_DCTVT_DTTM,
			
			DCTVT_USER_CODE AS TMPADRT_DCTVT_USER_CODE,
			
			UPDT_PRGRM_NAME AS TMPADRT_UPDT_PRGRM_NAME , ADRS_TYPE_DESCR AS ADRS_TYPE_DESCR
			from      LOGIC_ADRT
        )
----FILTER LAYER(uses aliases)----
,

        FILTER_PECN  as ( SELECT  * 
			from     RENAME_PECN  
            WHERE RENAME_PECN.DCTVT_DTTM > CURRENT_DATE
        ),

        FILTER_CNDT as ( SELECT  * 
			from     RENAME_CNDT 
            
        ),

        FILTER_CNPT  as ( SELECT  * 
			from     RENAME_CNPT  
            
        ),

        FILTER_ADRT as ( SELECT  * 
			from     RENAME_ADRT 
            
        )
----JOIN LAYER----
,
PECN as ( SELECT * 
			from  FILTER_PECN
				INNER JOIN FILTER_CNDT ON FILTER_PECN.CNTCT_ID = FILTER_CNDT.TMPCNDT_CNTCT_ID 
				INNER JOIN FILTER_CNPT  ON FILTER_PECN.CNTCT_PRP_TYP_CODE = FILTER_CNPT.TMPCNPT_CNTCT_PRP_TYP_CODE 
				LEFT JOIN FILTER_ADRT ON FILTER_PECN.ADRS_TYPE_CODE = FILTER_ADRT.TMPADRT_ADRS_TYPE_CODE  )
select PRVDR_BASE_NMBR
,PRVDR_SFX_NMBR
,CNTCT_ID
,PECN_CRT_DTTM
,CNTCT_PRP_TYP_CODE
,PRPS_TYPE_NAME
,EFCTV_DATE
,ENDNG_DATE
,CRT_USER_CODE
,DCTVT_DTTM
,DCTVT_USER_CODE
,UPDT_PRGRM_NAME
,ADRS_TYPE_CODE
,ADRS_TYPE_DESCR
,ADRS_TYPE_LCT_NMBR
,CNEA_CRT_DTTM
,CNDT_CRT_DTTM
,NAME
,TITLE
,PHONE_AREA_CODE
,PHONE_EXCHN_NMBR
,PHONE_LINE_NMBR
,PHONE_NUMBER
,PHONE_EXTNS_NMBR
,FRGN_CNTRY_CODE
,FRGN_PHONE_NMBR
,FRGN_EXTNS_NMBR
,FAX_AREA_CODE
,FAX_EXCHN_NMBR
,FAX_LINE_NMBR
,FAX_NUMBER
,FRGN_FAX_CNTR_CODE
,FRGN_FAX_PHON_NMBR
,FRGN_FAX_EXTN_NMBR
,EMAIL_ADRS
,CNPT_CRT_DTTM
,TMPCNDT_CNTCT_ID
,TMPCNDT_CRT_USER_CODE
,TMPCNDT_DCTVT_DTTM
,TMPCNDT_DCTVT_USER_CODE
,TMPCNDT_UPDT_PRGRM_NAME
,TMPCNPT_CNTCT_PRP_TYP_CODE
,TMPCNPT_EFCTV_DATE
,TMPCNPT_ENDNG_DATE
,TMPCNPT_CRT_USER_CODE
,TMPCNPT_DCTVT_DTTM
,TMPCNPT_DCTVT_USER_CODE
,TMPCNPT_UPDT_PRGRM_NAME
,TMPADRT_ADRS_TYPE_CODE
,TMPADRT_CRT_DTTM
,TMPADRT_EFCTV_DATE
,TMPADRT_ENDNG_DATE
,TMPADRT_CRT_USER_CODE
,TMPADRT_DCTVT_DTTM
,TMPADRT_DCTVT_USER_CODE
,TMPADRT_UPDT_PRGRM_NAME
 from PECN
      );
    