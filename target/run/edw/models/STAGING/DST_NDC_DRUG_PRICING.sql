

      create or replace  table DEV_EDW.STAGING.DST_NDC_DRUG_PRICING  as
      (----SRC LAYER----
WITH
SRC_NDC_PRCNG as ( SELECT *     from      STAGING.STG_NDC_PRICING_TYPE )
----LOGIC LAYER----
,
LOGIC_NDC_PRCNG as ( SELECT 
		--- NEW NDC_11_CODE AS (derived),
		CONCAT(FK_NDCL_CODE, FK_DCPR_CODE, FK_NDCP_CODE) AS NDC_11_CODE,
		AMT::NUMERIC(13,5) AS AMT,
		FK_NDCL_CODE AS FK_NDCL_CODE,
		FK_DCPR_CODE AS FK_DCPR_CODE,
		FK_NDCP_CODE AS FK_NDCP_CODE,
		FK_NDCV_NMBR AS FK_NDCV_NMBR,
		NAME AS NAME,
		CASE FK_NDPT_CODE
			WHEN 'A' THEN 'AWP'
			WHEN 'BB' THEN 'BBU'
			WHEN 'D' THEN 'DP'
			WHEN 'H' THEN 'CMS'
			WHEN 'U' THEN 'CMSU'
			WHEN 'W' THEN 'WAC' ELSE NULL END AS FK_NDPT_CODE,
		EFCTV_DATE AS EFCTV_DATE,
		ENDNG_DATE AS ENDNG_DATE 
				from SRC_NDC_PRCNG
            )
----RENAME LAYER ----
,
RENAME_NDC_PRCNG as ( SELECT NDC_11_CODE as NDC_11_CODE,AMT AS AMT,FK_NDCL_CODE AS FK_NDCL_CODE,FK_DCPR_CODE AS FK_DCPR_CODE,FK_NDCP_CODE AS FK_NDCP_CODE,FK_NDCV_NMBR AS FK_NDCV_NMBR,NAME AS NAME,FK_NDPT_CODE AS FK_NDPT_CODE,EFCTV_DATE AS EFCTV_DATE,ENDNG_DATE AS ENDNG_DATE 
			from      LOGIC_NDC_PRCNG
        )
----FILTER LAYER(uses aliases)----
,

        FILTER_NDC_PRCNG as ( SELECT  * 
			from     RENAME_NDC_PRCNG 
            
        )
----JOIN LAYER----
,
 JOIN_NDC_PRCNG as ( SELECT * 
			from  FILTER_NDC_PRCNG )
 SELECT * FROM JOIN_NDC_PRCNG
      );
    