

      create or replace  table DEV_EDW.STAGING.STG_MEDISPAN_NM_DRUG_DSCRPTR  as
      (----SRC LAYER----
WITH
SRC_MDPN as ( SELECT *     from      DEV_VIEWS.DBEABP00.TEAMDPN ),
SRC_MDDI as ( SELECT *     from      DEV_VIEWS.DBEABP00.TEAMDDI ),
SRC_MNDT as ( SELECT *     from      DEV_VIEWS.DBEABP00.TEAMNDT ),
SRC_MNRA as ( SELECT *     from      DEV_VIEWS.DBEABP00.TEAMNRA ),
----LOGIC LAYER----
LOGIC_MDPN as ( SELECT 
		FK_MDDI_NMBR AS FK_MDDI_NMBR,
		MDPN_CRT_DTTM AS MDPN_CRT_DTTM,
	CASE WHEN TRIM(NAME)='' THEN NULL ELSE TRIM(NAME) 
        END AS NAME,
		cast(EFCTV_DATE as DATE) AS EFCTV_DATE,
		cast(ENDNG_DATE as DATE) AS ENDNG_DATE,
	CASE WHEN TRIM(CRT_USER_CODE)='' THEN NULL ELSE TRIM(CRT_USER_CODE) 
        END AS CRT_USER_CODE,
	CASE WHEN TRIM(CRT_PRGRM_NAME)='' THEN NULL ELSE TRIM(CRT_PRGRM_NAME)
        END AS CRT_PRGRM_NAME,
	CASE WHEN TRIM(DCTVT_USER_CODE)='' THEN NULL ELSE TRIM(DCTVT_USER_CODE)
        END AS DCTVT_USER_CODE,
	CASE WHEN TRIM(DCTVT_PRGRM_NAME)='' THEN NULL ELSE TRIM(DCTVT_PRGRM_NAME)
        END AS DCTVT_PRGRM_NAME,
		DCTVT_DTTM AS DCTVT_DTTM 
				from SRC_MDPN
            ),
LOGIC_MDDI as ( SELECT 
	CASE WHEN TRIM(STRTH_QTY)='' THEN NULL ELSE TRIM(STRTH_QTY)
        END AS STRTH_QTY,
	CASE WHEN TRIM(FK_MNST_CODE)='' THEN NULL ELSE TRIM(FK_MNST_CODE)
        END AS FK_MNST_CODE,
	CASE WHEN TRIM(FK_MNRA_CODE)='' THEN NULL ELSE TRIM(FK_MNRA_CODE)
        END AS FK_MNRA_CODE,
	CASE WHEN TRIM(FK_MNDT_CODE)='' THEN NULL ELSE TRIM(FK_MNDT_CODE)
        END AS FK_MNDT_CODE,
		MDDI_NMBR AS MDDI_NMBR 
				from SRC_MDDI
            ),
LOGIC_MNDT as ( SELECT 
	CASE WHEN TRIM(NAME)='' THEN NULL ELSE TRIM(NAME)
        END AS NAME,
		cast(EFCTV_DATE as DATE) AS EFCTV_DATE,
		cast(ENDNG_DATE as DATE) AS ENDNG_DATE,
		CRT_DTTM AS CRT_DTTM,
		UPDT_DTTM AS UPDT_DTTM,
	CASE WHEN TRIM(MNDT_CODE)='' THEN NULL ELSE TRIM(MNDT_CODE)
        END AS MNDT_CODE,
        DCTVT_DTTM AS DCTVT_DTTM  
				from SRC_MNDT
            ),
LOGIC_MNRA as ( SELECT 
	CASE WHEN TRIM(NAME)='' THEN NULL ELSE TRIM(NAME)
        END AS NAME,
		cast(EFCTV_DATE as DATE) AS EFCTV_DATE,
		cast(ENDNG_DATE as DATE) AS ENDNG_DATE,
		CRT_DTTM AS CRT_DTTM,
		UPDT_DTTM AS UPDT_DTTM,
		DCTVT_DTTM AS DCTVT_DTTM,
	CASE WHEN TRIM(MNRA_CODE)='' THEN NULL ELSE TRIM(MNRA_CODE)
        END AS MNRA_CODE 
				from SRC_MNRA
            )
----RENAME LAYER ----
,
RENAME_MDPN as ( SELECT FK_MDDI_NMBR AS FK_MDDI_NMBR,MDPN_CRT_DTTM AS MDPN_CRT_DTTM,
			
			NAME AS MDPN_NAME,
			
			EFCTV_DATE AS MDPN_EFCTV_DATE,
			
			ENDNG_DATE AS MDPN_ENDNG_DATE,CRT_USER_CODE AS CRT_USER_CODE,CRT_PRGRM_NAME AS CRT_PRGRM_NAME,DCTVT_USER_CODE AS DCTVT_USER_CODE,DCTVT_PRGRM_NAME AS DCTVT_PRGRM_NAME,DCTVT_DTTM AS DCTVT_DTTM,
			
			DCTVT_DTTM AS MDPN_DCTVT_DTTM 
			from      LOGIC_MDPN
        ),
RENAME_MDDI as ( SELECT STRTH_QTY AS STRTH_QTY,FK_MNST_CODE AS FK_MNST_CODE,FK_MNRA_CODE AS FK_MNRA_CODE,FK_MNDT_CODE AS FK_MNDT_CODE,MDDI_NMBR AS MDDI_NMBR 
			from      LOGIC_MDDI
        ),
RENAME_MNDT as ( SELECT 
			
			NAME AS MNDT_NAME,
			
			EFCTV_DATE AS MNDT_EFCTV_DATE,
			
			ENDNG_DATE AS MNDT_ENDNG_DATE,
			
			CRT_DTTM AS MNDT_CRT_DTTM,
			
			UPDT_DTTM AS MNDT_UPDT_DTTM,MNDT_CODE AS MNDT_CODE,
            DCTVT_DTTM AS MNDT_DCTVT_DTTM
			from      LOGIC_MNDT
        ),
RENAME_MNRA as ( SELECT 
			
			NAME AS MNRA_NAME,
			
			EFCTV_DATE AS MNRA_EFCTV_DATE,
			
			ENDNG_DATE AS MNRA_ENDNG_DATE,
			
			CRT_DTTM AS MNRA_CRT_DTTM,
			
			UPDT_DTTM AS MNRA_UPDT_DTTM,
			
			DCTVT_DTTM AS MNRA_DCTVT_DTTM,MNRA_CODE AS MNRA_CODE 
			from      LOGIC_MNRA
        )
----FILTER LAYER(uses aliases)----
,

        FILTER_MDPN as ( SELECT  * 
			from     RENAME_MDPN 
            
        ),

        FILTER_MDDI as ( SELECT  * 
			from     RENAME_MDDI 
            
        ),

        FILTER_MNDT as ( SELECT  * 
			from     RENAME_MNDT 
            WHERE MNDT_DCTVT_DTTM > CURRENT_DATE
        ),

        FILTER_MNRA as ( SELECT  * 
			from     RENAME_MNRA 
            WHERE MNRA_DCTVT_DTTM > CURRENT_DATE
        )
----JOIN LAYER----
,
MDDI as ( SELECT * 
			from  FILTER_MDDI
				LEFT JOIN FILTER_MNDT ON FILTER_MDDI.FK_MNDT_CODE = FILTER_MNDT.MNDT_CODE 
				LEFT JOIN FILTER_MNRA ON FILTER_MDDI.FK_MNRA_CODE = FILTER_MNRA.MNRA_CODE  ),
MDPN as ( SELECT * 
			from  FILTER_MDPN
				LEFT JOIN MDDI ON FILTER_MDPN.FK_MDDI_NMBR = MDDI.MDDI_NMBR  )
select * from MDPN
      );
    