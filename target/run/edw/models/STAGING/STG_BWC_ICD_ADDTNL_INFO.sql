

      create or replace  table DEV_EDW.STAGING.STG_BWC_ICD_ADDTNL_INFO  as
      (----SRC LAYER----
WITH
SRC_ICD_INFO as ( SELECT *     from      DEV_VIEWS.PCMP.BWC_ICD_ADDTNL_INFO ),
SRC_ACP as ( SELECT *     from      DEV_VIEWS.PCMP.ICD_ACP_ELIG_RANGE )
//SRC_ICD_INFO as ( SELECT *     from      BWC_ICD_ADDTNL_INFO),
//SRC_ACP as ( SELECT *     from      ICD_ACP_ELIG_RANGE)
----LOGIC LAYER----
,
LOGIC_ICD_INFO as ( SELECT 
		ICD_CD AS ICD_CD,
		UPPER(ICD_LOC_REQD_IND) AS ICD_LOC_REQD_IND,
		UPPER(ICD_SITE_REQD_IND) AS ICD_SITE_REQD_IND,
		UPPER(ICD_SEC_AUTH_REQ_IND) AS ICD_SEC_AUTH_REQ_IND,
		UPPER(ICD_ASGN_TO_FLD_REQD_IND) AS ICD_ASGN_TO_FLD_REQD_IND,
		UPPER(ICD_STAT_OD_IND) AS ICD_STAT_OD_IND,
		UPPER(ICD_SMART_TIPS) AS ICD_SMART_TIPS,
		UPPER(ICD_CTRPH_IND) AS ICD_CTRPH_IND,
		UPPER(ICD_CMPLX_IND) AS ICD_CMPLX_IND,
		UPPER(VOID_IND) AS VOID_IND 
				from SRC_ICD_INFO
            ),
LOGIC_ACP as ( SELECT 
		CASE WHEN ICD_ACP_ELIG_RNG_ID IS NOT NULL THEN 'Y' ELSE 'N' END AS ICD_ACP_ELIG_IND,
		UPPER(VOID_IND) AS VOID_IND,
		ICD_ACP_ELIG_RNG_ID AS ICD_ACP_ELIG_RNG_ID ,
		ICD_ACP_ELIG_RNG_STR_NO
				from SRC_ACP
            )
----RENAME LAYER ----
,
RENAME_ICD_INFO as ( SELECT ICD_CD AS ICD_CD,ICD_LOC_REQD_IND AS ICD_LOC_REQD_IND,ICD_SITE_REQD_IND AS ICD_SITE_REQD_IND,ICD_SEC_AUTH_REQ_IND AS ICD_SEC_AUTH_REQ_IND
,ICD_ASGN_TO_FLD_REQD_IND AS ICD_ASGN_TO_FLD_REQD_IND,ICD_STAT_OD_IND AS ICD_STAT_OD_IND,ICD_SMART_TIPS AS ICD_SMART_TIPS,ICD_CTRPH_IND AS ICD_CTRPH_IND
,ICD_CMPLX_IND AS ICD_CMPLX_IND,VOID_IND AS VOID_IND 
			from      LOGIC_ICD_INFO
        ),
RENAME_ACP as ( SELECT 
			ICD_ACP_ELIG_IND AS ICD_ACP_ELIG_IND,
			VOID_IND AS ACP_VOID_IND,ICD_ACP_ELIG_RNG_ID AS ICD_ACP_ELIG_RNG_ID,
			ICD_ACP_ELIG_RNG_STR_NO AS ICD_ACP_ELIG_RNG_STR_NO
			from      LOGIC_ACP
        )
----FILTER LAYER(uses aliases)----
,

        FILTER_ICD_INFO as ( SELECT  * 
			from     RENAME_ICD_INFO 
            WHERE VOID_IND = 'N'
        ),

        FILTER_ACP as ( SELECT  * 
			from     RENAME_ACP 
            WHERE ACP_VOID_IND = 'N'
        )
----JOIN LAYER----
,
ICD_JOIN as ( SELECT * 
			from  FILTER_ICD_INFO
				LEFT JOIN FILTER_ACP ON FILTER_ICD_INFO.ICD_CD = FILTER_ACP.ICD_ACP_ELIG_RNG_STR_NO  )
				
-- ETL LAYER
-- the layer below added to ICD_ACP_ELIG_IND not being null
, 
ICD_INFO AS (select 
ICD_CD
, ICD_LOC_REQD_IND
, ICD_SITE_REQD_IND
, ICD_SEC_AUTH_REQ_IND
, ICD_ASGN_TO_FLD_REQD_IND
, ICD_STAT_OD_IND
, ICD_SMART_TIPS
, ICD_CTRPH_IND
, ICD_CMPLX_IND
, VOID_IND
, COALESCE (ICD_ACP_ELIG_IND, 'N') AS ICD_ACP_ELIG_IND
, ACP_VOID_IND
, ICD_ACP_ELIG_RNG_ID
, ICD_ACP_ELIG_RNG_STR_NO
from ICD_JOIN
)

SELECT * FROM ICD_INFO
      );
    