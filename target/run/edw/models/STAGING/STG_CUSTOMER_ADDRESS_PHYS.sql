

      create or replace  table DEV_EDW.STAGING.STG_CUSTOMER_ADDRESS_PHYS  as
      (----SRC LAYER----
WITH
SRC_CAP as ( SELECT *     from      STAGING.STG_CUSTOMER_ADDRESS )
----LOGIC LAYER----
,
LOGIC_CAP as ( SELECT 
		CUST_ADDR_STR_1 AS CUST_ADDR_STR_1,
		CUST_ADDR_STR_2 AS CUST_ADDR_STR_2,
		STT_ABRV AS STT_ABRV,
		STT_NM AS STT_NM,
		CNTRY_NM AS CNTRY_NM,
		CUST_ADDR_CITY_NM AS CUST_ADDR_CITY_NM,
		CUST_ADDR_CNTY_NM AS CUST_ADDR_CNTY_NM,
		CUST_ADDR_POST_CD AS CUST_ADDR_POST_CD,
		CASE WHEN LENGTH(CUST_ADDR_POST_CD) = 9 AND CNTRY_NM = 'UNITED STATES'
					THEN LEFT(CUST_ADDR_POST_CD, 5) ||'-'|| RIGHT(CUST_ADDR_POST_CD, 4)
				WHEN LENGTH(CUST_ADDR_POST_CD) = 6 AND CNTRY_NM = 'CANADA' 
					THEN LEFT(CUST_ADDR_POST_CD, 3) ||' '|| RIGHT(CUST_ADDR_POST_CD, 3)
				ELSE CUST_ADDR_POST_CD END AS PHYSICAL_FORMATTED_ADDRESS_POSTAL_CODE,
			
			CASE WHEN LENGTH(CUST_ADDR_POST_CD) = 9 AND CNTRY_NM = 'UNITED STATES'
					THEN LEFT(CUST_ADDR_POST_CD, 5) ELSE CUST_ADDR_POST_CD END AS PHYSICAL_FORMATTED_ADDRESS_ZIP_CODE,
			
			CASE WHEN LENGTH(CUST_ADDR_POST_CD) = 9 AND CNTRY_NM = 'UNITED STATES'
					THEN RIGHT(CUST_ADDR_POST_CD, 4)  END AS PHYSICAL_FORMATTED_ADDRESS_ZIP4_CODE,
		CUST_ADDR_VLDT_IND AS CUST_ADDR_VLDT_IND,
		CUST_ADDR_COMT AS CUST_ADDR_COMT,
		CUST_ADDR_EFF_DATE AS CUST_ADDR_EFF_DATE,
		CASE WHEN CUST_ID = LEAD(CUST_ID) OVER (ORDER BY CUST_ID, CUST_ADDR_EFF_DATE, COALESCE(CUST_ADDR_END_DATE, '12/31/2999'))
					THEN lead(CUST_ADDR_EFF_DATE) over (PARTITION BY CUST_ID ORDER BY CUST_ADDR_EFF_DATE, COALESCE(CUST_ADDR_END_DATE, '12/31/2999'))-1
                    ELSE CUST_ADDR_END_DATE END AS PHYS_ADRS_END_DATE,
		CUST_ID AS CUST_ID,
		VOID_IND AS VOID_IND,
		CUST_ADDR_TYP_CD AS CUST_ADDR_TYP_CD,
		CUST_ADDR_END_DATE AS CUST_ADDR_END_DATE 
				from SRC_CAP
				WHERE CUST_ADDR_TYP_CD = 'PHYS' and VOID_IND = 'N'
            )
----RENAME LAYER ----
,
RENAME_CAP as ( SELECT 
			
			CUST_ADDR_STR_1 AS PHYSICAL_STREET_ADDRESS_1,
			
			CUST_ADDR_STR_2 AS PHYSICAL_STREET_ADDRESS_2,
			
			STT_ABRV AS PHYSICAL_ADDRESS_STATE_CODE,
			
			STT_NM AS PHYSICAL_ADDRESS_STATE_NAME,
			
			CNTRY_NM AS PHYSICAL_ADDRESS_COUNTRY_NAME,
			
			CUST_ADDR_CITY_NM AS PHYSICAL_ADDRESS_CITY_NAME,
			
			CUST_ADDR_CNTY_NM AS PHYSICAL_ADDRESS_COUNTY_NAME,
			
			CUST_ADDR_POST_CD AS PHYSICAL_ADDRESS_POSTAL_CODE,
			
			PHYSICAL_FORMATTED_ADDRESS_POSTAL_CODE AS PHYSICAL_FORMATTED_ADDRESS_POSTAL_CODE,
			
			PHYSICAL_FORMATTED_ADDRESS_ZIP_CODE AS PHYSICAL_FORMATTED_ADDRESS_ZIP_CODE,
			
			PHYSICAL_FORMATTED_ADDRESS_ZIP4_CODE AS PHYSICAL_FORMATTED_ADDRESS_ZIP4_CODE,
			
			CUST_ADDR_VLDT_IND AS PHYSICAL_ADDRESS_VALIDATED_IND,
			
			CUST_ADDR_COMT AS PHYSICAL_ADDRESS_COMMENT_TEXT,
			
			CUST_ADDR_EFF_DATE AS PHYS_ADRS_EFF_DATE,
			
			PHYS_ADRS_END_DATE AS PHYS_ADRS_END_DATE,
			
			CUST_ID AS CUST_ID,
			
			VOID_IND AS VOID_IND,
			
			CUST_ADDR_TYP_CD AS CUST_ADDR_TYP_CD,
			
			CUST_ADDR_END_DATE AS CUST_ADDR_END_DATE 
			from      LOGIC_CAP
        )
----FILTER LAYER(uses aliases)----
,

        FILTER_CAP as ( SELECT  * 
			from     RENAME_CAP 
        )
----JOIN LAYER----
,
CAP as ( SELECT * 
			from  FILTER_CAP 
		)
SELECT CUST_ID as CUST_ID 
, PHYSICAL_STREET_ADDRESS_1
, PHYSICAL_STREET_ADDRESS_2
, PHYSICAL_ADDRESS_STATE_CODE
, PHYSICAL_ADDRESS_STATE_NAME
, PHYSICAL_ADDRESS_COUNTRY_NAME
, PHYSICAL_ADDRESS_CITY_NAME
, PHYSICAL_ADDRESS_COUNTY_NAME
, PHYSICAL_ADDRESS_POSTAL_CODE
, PHYSICAL_FORMATTED_ADDRESS_POSTAL_CODE
, PHYSICAL_FORMATTED_ADDRESS_ZIP_CODE
, PHYSICAL_FORMATTED_ADDRESS_ZIP4_CODE
, PHYSICAL_ADDRESS_VALIDATED_IND
, PHYSICAL_ADDRESS_COMMENT_TEXT
, PHYS_ADRS_EFF_DATE
, PHYS_ADRS_END_DATE
, VOID_IND
, CUST_ADDR_TYP_CD
, CUST_ADDR_END_DATE
 FROM CAP
      );
    